From 21ed55da15cc73be9433bdb99c8a50ed4bea50ed Mon Sep 17 00:00:00 2001
From: minaripenguin <minaripenguin@users.noreply.github.com>
Date: Sat, 11 Nov 2023 13:50:01 +0800
Subject: [PATCH] SystemUI: Add charging icon to the charging animation

Signed-off-by: minaripenguin <minaripenguin@users.noreply.github.com>
Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 packages/SystemUI/res/drawable/ic_bolt.xml    | 26 ++++++++++++++
 .../res/layout/wireless_charging_layout.xml   |  6 ++++
 packages/SystemUI/res/values/dimens.xml       |  3 ++
 .../charging/WirelessChargingLayout.java      | 35 ++++++++++++++++++-
 4 files changed, 69 insertions(+), 1 deletion(-)
 create mode 100644 packages/SystemUI/res/drawable/ic_bolt.xml

diff --git a/packages/SystemUI/res/drawable/ic_bolt.xml b/packages/SystemUI/res/drawable/ic_bolt.xml
new file mode 100644
index 000000000000..a0d39bc5934a
--- /dev/null
+++ b/packages/SystemUI/res/drawable/ic_bolt.xml
@@ -0,0 +1,26 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2023 the risingOS Android Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="48dp"
+    android:height="48dp"
+    android:viewportWidth="24"
+    android:viewportHeight="24"
+    android:tint="?attr/colorControlNormal">
+  <path
+      android:fillColor="?attr/chargingAnimColor"
+      android:pathData="M14.69,2.21L4.33,11.49c-0.64,0.58 -0.28,1.65 0.58,1.73L13,14l-4.85,6.76c-0.22,0.31 -0.19,0.74 0.08,1.01h0c0.3,0.3 0.77,0.31 1.08,0.02l10.36,-9.28c0.64,-0.58 0.28,-1.65 -0.58,-1.73L11,10l4.85,-6.76c0.22,-0.31 0.19,-0.74 -0.08,-1.01l0,0C15.47,1.93 15,1.92 14.69,2.21z"/>
+</vector>
diff --git a/packages/SystemUI/res/layout/wireless_charging_layout.xml b/packages/SystemUI/res/layout/wireless_charging_layout.xml
index f1bc88370071..a91d869138e7 100644
--- a/packages/SystemUI/res/layout/wireless_charging_layout.xml
+++ b/packages/SystemUI/res/layout/wireless_charging_layout.xml
@@ -53,6 +53,12 @@
             android:layout_width="wrap_content"
             android:layout_height="wrap_content"
             android:layout_gravity="center"/>
+        <ImageView
+            android:id="@+id/wireless_charging_icon"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:layout_gravity="center"
+            android:src="@drawable/ic_bolt"/>
     </LinearLayout>
 
 </FrameLayout>
diff --git a/packages/SystemUI/res/values/dimens.xml b/packages/SystemUI/res/values/dimens.xml
index ad441248a750..fb3a91f58ec0 100644
--- a/packages/SystemUI/res/values/dimens.xml
+++ b/packages/SystemUI/res/values/dimens.xml
@@ -1250,6 +1250,9 @@
     <item name="wireless_charging_anim_battery_level_text_size_start" format="float" type="dimen">
         0
     </item>
+    <!-- padding size in sp of batteryIcon for wireless charging animation -->
+    <item name="wireless_charging_padding" format="float" type="dimen">8
+    </item>
     <!-- Ending text size in sp of batteryLevel for wireless charging animation -->
     <item name="wireless_charging_anim_battery_level_text_size_end" format="float" type="dimen">48
     </item>
diff --git a/packages/SystemUI/src/com/android/systemui/charging/WirelessChargingLayout.java b/packages/SystemUI/src/com/android/systemui/charging/WirelessChargingLayout.java
index a9a657730109..66438fe4fcdd 100644
--- a/packages/SystemUI/src/com/android/systemui/charging/WirelessChargingLayout.java
+++ b/packages/SystemUI/src/com/android/systemui/charging/WirelessChargingLayout.java
@@ -87,6 +87,7 @@ final class WirelessChargingLayout extends FrameLayout {
 
         // amount of battery:
         final TextView percentage = findViewById(R.id.wireless_charging_percentage);
+	final ImageView chargingIcon = findViewById(R.id.wireless_charging_icon);
 
         if (batteryLevel != WirelessChargingAnimation.UNKNOWN_BATTERY_LEVEL) {
             percentage.setText(NumberFormat.getPercentInstance().format(batteryLevel / 100f));
@@ -102,6 +103,17 @@ final class WirelessChargingLayout extends FrameLayout {
         final float batteryLevelTextSizeEnd = context.getResources().getFloat(
                 R.dimen.wireless_charging_anim_battery_level_text_size_end) * (
                 showTransmittingBatteryLevel ? 0.75f : 1.0f);
+        final float batteryPadding = context.getResources().getFloat(
+                R.dimen.wireless_charging_padding);
+        final int sidePadding = Math.round(
+                TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, batteryPadding,
+                        getResources().getDisplayMetrics()));
+
+        if (batteryLevel != WirelessChargingAnimation.UNKNOWN_BATTERY_LEVEL) {
+            percentage.setText(NumberFormat.getPercentInstance().format(batteryLevel / 100f));
+            percentage.setAlpha(0);
+            chargingIcon.setPadding(sidePadding, 0, 0, 0);
+        }
 
         // Animation Scale: battery percentage text scales from 0% to 100%
         ValueAnimator textSizeAnimator = ObjectAnimator.ofFloat(percentage, "textSize",
@@ -124,9 +136,30 @@ final class WirelessChargingLayout extends FrameLayout {
         textFadeAnimator.setInterpolator(Interpolators.LINEAR);
         textFadeAnimator.setStartDelay(chargingAnimationFadeStartOffset);
 
+        // Animation Scale: battery icon scales from 0% to 100%
+        ValueAnimator battSizeAnimator = ObjectAnimator.ofFloat(chargingIcon, "batterySize",
+                batteryLevelTextSizeStart, batteryLevelTextSizeEnd);
+        battSizeAnimator.setInterpolator(new PathInterpolator(0, 0, 0, 1));
+        battSizeAnimator.setDuration(context.getResources().getInteger(
+                R.integer.wireless_charging_battery_level_text_scale_animation_duration));
+
+        // Animation Opacity: battery icon transitions from 0 to 1 opacity
+        ValueAnimator OpacityAnimatorBattIcon = ObjectAnimator.ofFloat(chargingIcon, "alpha", 0, 1);
+        OpacityAnimatorBattIcon.setInterpolator(Interpolators.LINEAR);
+        OpacityAnimatorBattIcon.setDuration(context.getResources().getInteger(
+                R.integer.wireless_charging_battery_level_text_opacity_duration));
+        OpacityAnimatorBattIcon.setStartDelay(context.getResources().getInteger(
+                R.integer.wireless_charging_anim_opacity_offset));
+
+        // Animation Opacity: battery icon fades from 1 to 0 opacity
+        ValueAnimator FadeAnimatorBattIcon = ObjectAnimator.ofFloat(chargingIcon, "alpha", 1, 0);
+        FadeAnimatorBattIcon.setDuration(chargingAnimationFadeDuration);
+        FadeAnimatorBattIcon.setInterpolator(Interpolators.LINEAR);
+        FadeAnimatorBattIcon.setStartDelay(chargingAnimationFadeStartOffset);
+
         // play all animations together
         AnimatorSet animatorSet = new AnimatorSet();
-        animatorSet.playTogether(textSizeAnimator, textOpacityAnimator, textFadeAnimator);
+        animatorSet.playTogether(textSizeAnimator, textOpacityAnimator, textFadeAnimator, battSizeAnimator, OpacityAnimatorBattIcon, FadeAnimatorBattIcon);
 
         // For tablet docking animation, we don't play the background scrim.
         // TODO(b/270524780): use utility to check for tablet instead. 
-- 
2.51.2.windows.1

