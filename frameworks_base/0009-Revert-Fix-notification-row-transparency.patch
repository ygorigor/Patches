From fffa2efe1b6df0db64aff3ae6f983eafdc13a525 Mon Sep 17 00:00:00 2001
From: John Galt <johngaltfirstrun@gmail.com>
Date: Tue, 8 Jul 2025 16:33:09 -0400
Subject: [PATCH] Revert "Fix notification row transparency."

This reverts commit 23c7418d4d96448ba76d08690df7209b9743c2dd.

To use flag com.android.systemui.notification_row_transparency currently
on qpr0

Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 .../row/ActivatableNotificationView.java      | 27 +++++----
 .../row/ExpandableNotificationRow.java        | 41 ++++---------
 .../row/NotificationBackgroundView.java       | 59 +++++++++++++------
 3 files changed, 70 insertions(+), 57 deletions(-)

diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/notification/row/ActivatableNotificationView.java b/packages/SystemUI/src/com/android/systemui/statusbar/notification/row/ActivatableNotificationView.java
index b0b08a928f6c..689222608abe 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/notification/row/ActivatableNotificationView.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/notification/row/ActivatableNotificationView.java
@@ -40,7 +40,6 @@ import android.view.animation.Interpolator;
 import com.android.app.animation.Interpolators;
 import com.android.internal.jank.InteractionJankMonitor;
 import com.android.internal.jank.InteractionJankMonitor.Configuration;
-import com.android.systemui.Flags;
 import com.android.systemui.Gefingerpoken;
 import com.android.systemui.common.shared.colors.SurfaceEffectColors;
 import com.android.systemui.res.R;
@@ -102,8 +101,7 @@ public abstract class ActivatableNotificationView extends ExpandableOutlineView
     private ValueAnimator mBackgroundColorAnimator;
     private float mAppearAnimationFraction = -1.0f;
     private float mAppearAnimationTranslation;
-    protected int mNormalColor;
-    protected int mOpaqueColor;
+    private int mNormalColor;
     private boolean mIsBelowSpeedBump;
     private long mLastActionUpTime;
 
@@ -132,13 +130,17 @@ public abstract class ActivatableNotificationView extends ExpandableOutlineView
 
     protected void updateColors() {
         if (notificationRowTransparency()) {
-            mNormalColor = SurfaceEffectColors.surfaceEffect1(getContext());
-            mOpaqueColor = mContext.getColor(
-                    com.android.internal.R.color.materialColorSurfaceContainer);
+            if (mIsBlurSupported) {
+                mNormalColor = SurfaceEffectColors.surfaceEffect1(getContext());
+            } else {
+                mNormalColor = mContext.getColor(
+                        com.android.internal.R.color.materialColorSurfaceContainer);
+            }
         } else {
             mNormalColor = mContext.getColor(
                     com.android.internal.R.color.materialColorSurfaceContainerHigh);
         }
+        setBackgroundToNormalColor();
         mTintedRippleColor = mContext.getColor(
                 R.color.notification_ripple_tinted_color);
         mNormalRippleColor = mContext.getColor(
@@ -149,6 +151,12 @@ public abstract class ActivatableNotificationView extends ExpandableOutlineView
         mOverrideAmount = 0.0f;
     }
 
+    private void setBackgroundToNormalColor() {
+        if (mBackgroundNormal != null) {
+            mBackgroundNormal.setNormalColor(mNormalColor);
+        }
+    }
+
     /**
      * Reload background colors from resources and invalidate views.
      */
@@ -178,6 +186,7 @@ public abstract class ActivatableNotificationView extends ExpandableOutlineView
         mBackgroundNormal = findViewById(R.id.backgroundNormal);
         mFakeShadow = findViewById(R.id.fake_shadow);
         mShadowHidden = mFakeShadow.getVisibility() != VISIBLE;
+        setBackgroundToNormalColor();
         initBackground();
         updateBackgroundTint();
         updateOutlineAlpha();
@@ -700,11 +709,7 @@ public abstract class ActivatableNotificationView extends ExpandableOutlineView
         if (withTint && mBgTint != NO_COLOR) {
             return mBgTint;
         } else {
-            if (Flags.notificationRowTransparency()) {
-                return usesTransparentBackground() ? mNormalColor : mOpaqueColor;
-            } else {
-                return mNormalColor;
-            }
+            return mNormalColor;
         }
     }
 
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/notification/row/ExpandableNotificationRow.java b/packages/SystemUI/src/com/android/systemui/statusbar/notification/row/ExpandableNotificationRow.java
index 3fed78674cf9..ea4b54678665 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/notification/row/ExpandableNotificationRow.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/notification/row/ExpandableNotificationRow.java
@@ -84,7 +84,6 @@ import androidx.dynamicanimation.animation.SpringAnimation;
 
 import com.android.app.animation.Interpolators;
 import com.android.internal.annotations.VisibleForTesting;
-import com.android.internal.graphics.ColorUtils;
 import com.android.internal.logging.MetricsLogger;
 import com.android.internal.logging.UiEventLogger;
 import com.android.internal.logging.nano.MetricsProto.MetricsEvent;
@@ -119,6 +118,7 @@ import com.android.systemui.statusbar.notification.NotificationUtils;
 import com.android.systemui.statusbar.notification.SourceType;
 import com.android.systemui.statusbar.notification.collection.EntryAdapter;
 import com.android.systemui.statusbar.notification.collection.NotificationEntry;
+import com.android.systemui.statusbar.notification.collection.NotificationEntryAdapter;
 import com.android.systemui.statusbar.notification.collection.PipelineEntry;
 import com.android.systemui.statusbar.notification.collection.provider.NotificationDismissibilityProvider;
 import com.android.systemui.statusbar.notification.collection.render.GroupExpansionManager;
@@ -1008,7 +1008,7 @@ public class ExpandableNotificationRow extends ActivatableNotificationView
             mAboveShelfChangedListener.onAboveShelfStateChanged(!wasAboveShelf);
         }
         if (notificationRowTransparency()) {
-            updateBackgroundTint();
+            updateColors();
         }
     }
 
@@ -1708,36 +1708,21 @@ public class ExpandableNotificationRow extends ActivatableNotificationView
 
     @Override
     protected void setBackgroundTintColor(int color) {
-        if (notificationRowTransparency()) {
-            boolean isColorized = false;
-            if (NotificationBundleUi.isEnabled()) {
-                if (mEntryAdapter != null) {
-                    isColorized = mEntryAdapter.isColorized();
-                }
-            } else {
-                if (mEntry != null) {
-                    isColorized = mEntry.getSbn().getNotification().isColorized();
-                }
-            }
-            boolean isTransparent = usesTransparentBackground();
-            if (isColorized) {
-                // For colorized notifications, use a color that matches the tint color at 90% alpha
-                // when the row is transparent.
-                color = ColorUtils.setAlphaComponent(
-                        color, (int) (0xFF * (isTransparent ? 0.9f : 1)));
-            } else {
-                // For non-colorized notifications, use the semi-transparent normal color token
-                // when the row is transparent, and the opaque color token otherwise.
-                if (!isTransparent && mBgTint == NO_COLOR) {
-                    color = mOpaqueColor;
-                }
-            }
-        }
         super.setBackgroundTintColor(color);
         NotificationContentView view = getShowingLayout();
         if (view != null) {
             view.setBackgroundTintColor(color);
         }
+        if (notificationRowTransparency() && mBackgroundNormal != null) {
+            if (NotificationBundleUi.isEnabled() && mEntryAdapter != null) {
+                mBackgroundNormal.setBgIsColorized(mEntryAdapter.isColorized());
+            } else {
+                if (mEntry != null) {
+                    mBackgroundNormal.setBgIsColorized(
+                            mEntry.getSbn().getNotification().isColorized());
+                }
+            }
+        }
     }
 
     public void closeRemoteInput() {
@@ -3204,7 +3189,7 @@ public class ExpandableNotificationRow extends ActivatableNotificationView
                 }
             }
             if (notificationRowTransparency()) {
-                updateBackgroundTint();
+                updateColors();
             }
         }
     }
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/notification/row/NotificationBackgroundView.java b/packages/SystemUI/src/com/android/systemui/statusbar/notification/row/NotificationBackgroundView.java
index e4997e4f53ad..4914e1073059 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/notification/row/NotificationBackgroundView.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/notification/row/NotificationBackgroundView.java
@@ -36,9 +36,9 @@ import android.view.View;
 import androidx.annotation.NonNull;
 import androidx.annotation.Nullable;
 
+import com.android.internal.graphics.ColorUtils;
 import com.android.internal.util.ContrastColorUtil;
 import com.android.systemui.Dumpable;
-import com.android.systemui.common.shared.colors.SurfaceEffectColors;
 import com.android.systemui.res.R;
 import com.android.systemui.statusbar.notification.shared.NotificationAddXOnHoverToDismiss;
 import com.android.systemui.util.DrawableDumpKt;
@@ -52,6 +52,7 @@ import java.util.Arrays;
 public class NotificationBackgroundView extends View implements Dumpable,
         ExpandableNotificationRow.DismissButtonTargetVisibilityListener {
 
+    private static final int MAX_ALPHA = 0xFF;
     private final boolean mDontModifyCorners;
     private Drawable mBackground;
     private int mClipTopAmount;
@@ -72,6 +73,8 @@ public class NotificationBackgroundView extends View implements Dumpable,
     private final ColorStateList mLightColoredStatefulColors;
     private final ColorStateList mDarkColoredStatefulColors;
     private int mNormalColor;
+    private boolean mBgIsColorized = false;
+    private boolean mForceOpaque = false;
     private final int convexR = 9;
     private final int concaveR = 22;
 
@@ -85,15 +88,13 @@ public class NotificationBackgroundView extends View implements Dumpable,
                 R.color.notification_state_color_light);
         mDarkColoredStatefulColors = getResources().getColorStateList(
                 R.color.notification_state_color_dark);
-        if (notificationRowTransparency()) {
-            mNormalColor = SurfaceEffectColors.surfaceEffect1(getContext());
-        } else  {
-            mNormalColor = mContext.getColor(
-                    com.android.internal.R.color.materialColorSurfaceContainerHigh);
-        }
         mFocusOverlayStroke = getResources().getDimension(R.dimen.notification_focus_stroke_width);
     }
 
+    public void setNormalColor(int color) {
+        mNormalColor = color;
+    }
+
     @Override
     public void onTargetVisibilityChanged(boolean targetVisible) {
         if (NotificationAddXOnHoverToDismiss.isUnexpectedlyInLegacyMode()) {
@@ -139,6 +140,21 @@ public class NotificationBackgroundView extends View implements Dumpable,
         }
     }
 
+    /**
+     * A way to tell whether the background has been colorized.
+     */
+    public boolean isColorized() {
+        return mBgIsColorized;
+    }
+
+    /**
+     * A way to inform this class whether the background has been colorized.
+     * We need to know this, in order to *not* override that color.
+     */
+    public void setBgIsColorized(boolean b) {
+        mBgIsColorized = b;
+    }
+
     private Path calculateDismissButtonCutoutPath(Rect backgroundBounds) {
         // TODO(b/365585705): Adapt to RTL after the UX design is finalized.
 
@@ -295,21 +311,28 @@ public class NotificationBackgroundView extends View implements Dumpable,
         return ((LayerDrawable) mBackground).getDrawable(1);
     }
 
+    private void updateBaseLayerColor() {
+        // BG base layer being a drawable, there isn't a method like setColor() to color it.
+        // Instead, we set a color filter that essentially replaces every pixel of the drawable.
+        // For non-colorized notifications, this function specifies a new color token.
+        // For colorized notifications, this uses a color that matches the tint color at 90% alpha.
+        int color = isColorized()
+                ? ColorUtils.setAlphaComponent(mTintColor, (int) (MAX_ALPHA * 0.9f))
+                : mNormalColor;
+        getBaseBackgroundLayer().setColorFilter(
+                new PorterDuffColorFilter(
+                        color,
+                        PorterDuff.Mode.SRC)); // SRC operator discards the drawable's color+alpha
+    }
+
     public void setTint(int tintColor) {
         Drawable baseLayer = getBaseBackgroundLayer();
+        baseLayer.mutate().setTintMode(PorterDuff.Mode.SRC_ATOP);
+        baseLayer.setTint(tintColor);
+        mTintColor = tintColor;
         if (notificationRowTransparency()) {
-            // BG base layer being a drawable, there isn't a method like setColor() to color it.
-            // Instead, we set a color filter that essentially replaces every pixel of the drawable.
-            baseLayer.setColorFilter(
-                    new PorterDuffColorFilter(
-                            tintColor,
-                            // SRC operator discards the drawable's color+alpha
-                            PorterDuff.Mode.SRC));
-        } else {
-            baseLayer.mutate().setTintMode(PorterDuff.Mode.SRC_ATOP);
-            baseLayer.setTint(tintColor);
+            updateBaseLayerColor();
         }
-        mTintColor = tintColor;
         setStatefulColors();
         invalidate();
     }
-- 
2.51.2.windows.1

