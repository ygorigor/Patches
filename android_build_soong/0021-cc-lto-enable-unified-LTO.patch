From 837e1b3df2a77a175e85201c567324f7b810bdcf Mon Sep 17 00:00:00 2001
From: John Galt <johngaltfirstrun@gmail.com>
Date: Wed, 3 Jan 2024 12:00:01 -0500
Subject: [PATCH] cc/lto: enable unified LTO

Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 cc/lto.go      | 4 ++++
 cc/sanitize.go | 2 +-
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/cc/lto.go b/cc/lto.go
index e144e8d47..24bfa2b8c 100644
--- a/cc/lto.go
+++ b/cc/lto.go
@@ -119,6 +119,10 @@ func (lto *lto) flags(ctx ModuleContext, flags Flags) Flags {
 			ltoCOnlyFlags = append(ltoCOnlyFlags, "-O3")
 		}
 
+		// Utilize unified LTO for greater optimization than ThinLTO with a
+		// lesser compile time hit than full lto
+		ltoCFlags = append(ltoCFlags, "-funified-lto")
+
 		if Bool(lto.Properties.Whole_program_vtables) {
 			ltoCFlags = append(ltoCFlags, "-fwhole-program-vtables")
 		}
diff --git a/cc/sanitize.go b/cc/sanitize.go
index f0b0308ae..0b80ffa41 100644
--- a/cc/sanitize.go
+++ b/cc/sanitize.go
@@ -64,7 +64,7 @@ var (
 	cfiBlocklistFilename = "cfi_blocklist.txt"
 	cfiEnableFlag        = "-fsanitize=cfi"
 	cfiCrossDsoFlag      = "-fsanitize-cfi-cross-dso"
-	cfiCflags            = []string{"-flto", cfiCrossDsoFlag,
+	cfiCflags            = []string{"-flto", "-funified-lto", cfiCrossDsoFlag,
 		sanitizeIgnorelistPrefix + cfiBlocklistPath + "/" + cfiBlocklistFilename}
 	// -flto and -fvisibility are required by clang when -fsanitize=cfi is
 	// used, but have no effect on assembly files
-- 
2.47.1.windows.1

