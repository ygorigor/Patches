From bd1fefb655f3cd55247ec9e47760b745f1074dbc Mon Sep 17 00:00:00 2001
From: John Galt <johngaltfirstrun@gmail.com>
Date: Sat, 6 Apr 2024 01:33:32 -0400
Subject: [PATCH] lto: enable O3 optimizations on explicit lto modules

Change-Id: Ia635a98b1c241a3b90029148fcd761c4dffb8d6b
Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 cc/lto.go | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/cc/lto.go b/cc/lto.go
index 984ada3e6..5acaf4a42 100644
--- a/cc/lto.go
+++ b/cc/lto.go
@@ -107,11 +107,15 @@ func (lto *lto) flags(ctx ModuleContext, flags Flags) Flags {
 	}
 	if lto.Properties.LtoEnabled {
 		ltoCFlags := []string{"-flto=thin", "-fsplit-lto-unit"}
+		var ltoCOnlyFlags []string
 		var ltoLdFlags []string
 
 		// Do not perform costly LTO optimizations for Eng builds.
 		if Bool(lto.Properties.Lto_O0) || ctx.Config().Eng() {
 			ltoLdFlags = append(ltoLdFlags, "-Wl,--lto-O0")
+		} else {
+			ltoLdFlags = append(ltoLdFlags,"-Wl,--lto-O3")
+			ltoCOnlyFlags = append(ltoCOnlyFlags, "-O3")
 		}
 
 		if Bool(lto.Properties.Whole_program_vtables) {
@@ -157,6 +161,7 @@ func (lto *lto) flags(ctx ModuleContext, flags Flags) Flags {
 		flags.Local.AsFlags = append(flags.Local.AsFlags, ltoCFlags...)
 		flags.Local.LdFlags = append(flags.Local.LdFlags, ltoCFlags...)
 		flags.Local.LdFlags = append(flags.Local.LdFlags, ltoLdFlags...)
+		flags.Local.CFlags = append(flags.Local.CFlags, ltoCOnlyFlags...)
 	}
 	return flags
 }
-- 
2.47.1.windows.1

