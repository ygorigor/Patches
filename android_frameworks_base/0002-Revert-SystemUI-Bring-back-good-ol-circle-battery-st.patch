From 274b160c868e134039ee3fc798cb406198ca8995 Mon Sep 17 00:00:00 2001
From: Igor Sorocean <igor_sorocean@hotmail.com>
Date: Mon, 25 Aug 2025 08:08:26 +0300
Subject: [PATCH] Revert "SystemUI: Bring back good ol' circle battery style"

This reverts commit 4f9c1ee6c4479c9e5572b7baa889d8ca051bd220.
---
 .../graph/CircleBatteryDrawable.kt            | 322 ------------------
 .../graph/ThemedBatteryDrawable.kt            |  31 --
 .../theme/ThemeOverlayControllerTest.java     |  12 +-
 .../res/layout/battery_percentage_view.xml    |   1 +
 .../SystemUI/res/values/lineage_dimens.xml    |   3 -
 .../SystemUI/res/xml/status_bar_prefs.xml     |   7 +-
 .../battery/AccessorizedBatteryDrawable.kt    |   5 -
 .../systemui/battery/BatteryMeterView.java    | 160 +++------
 .../battery/BatteryMeterViewController.java   |  23 +-
 .../phone/KeyguardStatusBarView.java          |   5 +-
 .../theme/ThemeOverlayController.java         |  32 --
 11 files changed, 63 insertions(+), 538 deletions(-)
 delete mode 100644 packages/SettingsLib/src/com/android/settingslib/graph/CircleBatteryDrawable.kt

diff --git a/packages/SettingsLib/src/com/android/settingslib/graph/CircleBatteryDrawable.kt b/packages/SettingsLib/src/com/android/settingslib/graph/CircleBatteryDrawable.kt
deleted file mode 100644
index f1c76b88cb84..000000000000
--- a/packages/SettingsLib/src/com/android/settingslib/graph/CircleBatteryDrawable.kt
+++ /dev/null
@@ -1,322 +0,0 @@
-/*
- * Copyright (C) 2017 The Android Open Source Project
- * Copyright (C) 2019 The LineageOS Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-package com.android.settingslib.graph
-
-import android.content.Context
-import android.content.res.Resources
-import android.graphics.*
-import android.graphics.drawable.Drawable
-import android.util.TypedValue
-import com.android.settingslib.R
-import com.android.settingslib.Utils
-import kotlin.math.max
-import kotlin.math.min
-
-class CircleBatteryDrawable(private val context: Context, frameColor: Int) : Drawable() {
-    private val criticalLevel: Int
-    private val warningString: String
-    private val framePaint: Paint
-    private val batteryPaint: Paint
-    private val warningTextPaint: Paint
-    private val textPaint: Paint
-    private val boltPaint: Paint
-    private val plusPaint: Paint
-    private val powerSavePaint: Paint
-    private val colors: IntArray
-    private val boltPoints: FloatArray
-    private val boltPath = Path()
-    private val padding = Rect()
-    private val frame = RectF()
-    private val boltFrame = RectF()
-
-    private var chargeColor: Int
-    private var iconTint = Color.WHITE
-    private var intrinsicWidth: Int
-    private var intrinsicHeight: Int
-    private var height = 0
-    private var width = 0
-
-    // Dual tone implies that battery level is a clipped overlay over top of the whole shape
-    private var dualTone = false
-
-    override fun getIntrinsicHeight() = intrinsicHeight
-
-    override fun getIntrinsicWidth() = intrinsicWidth
-
-    var charging = false
-        set(value) {
-            field = value
-            postInvalidate()
-        }
-
-    var powerSaveEnabled = false
-        set(value) {
-            field = value
-            postInvalidate()
-        }
-
-    var showPercent = false
-        set(value) {
-            field = value
-            postInvalidate()
-        }
-
-    var batteryLevel = -1
-        set(value) {
-            field = value
-            postInvalidate()
-        }
-
-    // an approximation of View.postInvalidate()
-    private fun postInvalidate() {
-        unscheduleSelf { invalidateSelf() }
-        scheduleSelf({ invalidateSelf() }, 0)
-    }
-
-    override fun setBounds(left: Int, top: Int, right: Int, bottom: Int) {
-        super.setBounds(left, top, right, bottom)
-        updateSize()
-    }
-
-    private fun updateSize() {
-        val res = context.resources
-        height = bounds.bottom - padding.bottom - (bounds.top + padding.top)
-        width = bounds.right - padding.right - (bounds.left + padding.left)
-        warningTextPaint.textSize = height * 0.75f
-        intrinsicHeight = res.getDimensionPixelSize(R.dimen.battery_height)
-        intrinsicWidth = res.getDimensionPixelSize(R.dimen.battery_height)
-    }
-
-    override fun getPadding(padding: Rect): Boolean {
-        if (this.padding.left == 0 &&
-            this.padding.top == 0 &&
-            this.padding.right == 0 &&
-            this.padding.bottom == 0
-        ) {
-            return super.getPadding(padding)
-        }
-        padding.set(this.padding)
-        return true
-    }
-
-    private fun getColorForLevel(percent: Int): Int {
-        var thresh: Int
-        var color = 0
-        var i = 0
-        while (i < colors.size) {
-            thresh = colors[i]
-            color = colors[i + 1]
-            if (percent <= thresh) {
-                // Respect tinting for "normal" level
-                return if (i == colors.size - 2) {
-                    iconTint
-                } else {
-                    color
-                }
-            }
-            i += 2
-        }
-        return color
-    }
-
-    private fun batteryColorForLevel(level: Int) =
-        if (charging || powerSaveEnabled)
-            chargeColor
-        else
-            getColorForLevel(level)
-
-    fun setColors(fgColor: Int, bgColor: Int, singleToneColor: Int) {
-        val fillColor = if (dualTone) fgColor else singleToneColor
-
-        iconTint = fillColor
-        framePaint.color = bgColor
-        boltPaint.color = fillColor
-        chargeColor = fillColor
-
-        invalidateSelf()
-    }
-
-    override fun draw(c: Canvas) {
-        if (batteryLevel == -1) return
-        val circleSize = min(width, height)
-        val strokeWidth = circleSize / 6.5f
-        framePaint.strokeWidth = strokeWidth
-        framePaint.style = Paint.Style.STROKE
-        batteryPaint.strokeWidth = strokeWidth
-        batteryPaint.style = Paint.Style.STROKE
-        powerSavePaint.strokeWidth = strokeWidth
-        frame[
-                strokeWidth / 2.0f + padding.left, strokeWidth / 2.0f,
-                circleSize - strokeWidth / 2.0f + padding.left
-        ] = circleSize - strokeWidth / 2.0f
-        // set the battery charging color
-        batteryPaint.color = batteryColorForLevel(batteryLevel)
-        if (charging) { // define the bolt shape
-            val bl = frame.left + frame.width() / 3.0f
-            val bt = frame.top + frame.height() / 3.4f
-            val br = frame.right - frame.width() / 4.0f
-            val bb = frame.bottom - frame.height() / 5.6f
-            if (boltFrame.left != bl ||
-                boltFrame.top != bt ||
-                boltFrame.right != br ||
-                boltFrame.bottom != bb
-            ) {
-                boltFrame[bl, bt, br] = bb
-                boltPath.reset()
-                boltPath.moveTo(
-                    boltFrame.left + boltPoints[0] * boltFrame.width(),
-                    boltFrame.top + boltPoints[1] * boltFrame.height()
-                )
-                var i = 2
-                while (i < boltPoints.size) {
-                    boltPath.lineTo(
-                        boltFrame.left + boltPoints[i] * boltFrame.width(),
-                        boltFrame.top + boltPoints[i + 1] * boltFrame.height()
-                    )
-                    i += 2
-                }
-                boltPath.lineTo(
-                    boltFrame.left + boltPoints[0] * boltFrame.width(),
-                    boltFrame.top + boltPoints[1] * boltFrame.height()
-                )
-            }
-            c.drawPath(boltPath, boltPaint)
-        }
-        // draw thin gray ring first
-        c.drawArc(frame, 270f, 360f, false, framePaint)
-        // draw colored arc representing charge level
-        if (batteryLevel > 0) {
-            if (!charging && powerSaveEnabled) {
-                c.drawArc(frame, 270f, 3.6f * batteryLevel, false, powerSavePaint)
-            } else {
-                c.drawArc(frame, 270f, 3.6f * batteryLevel, false, batteryPaint)
-            }
-        }
-        // compute percentage text
-        if (!charging && batteryLevel != 100 && showPercent) {
-            textPaint.color = getColorForLevel(batteryLevel)
-            textPaint.textSize = height * 0.52f
-            val textHeight = -textPaint.fontMetrics.ascent
-            val pctText =
-                if (batteryLevel > criticalLevel)
-                    batteryLevel.toString()
-                else
-                    warningString
-            val pctX = width * 0.5f
-            val pctY = (height + textHeight) * 0.47f
-            c.drawText(pctText, pctX, pctY, textPaint)
-        }
-    }
-
-    // Some stuff required by Drawable.
-    override fun setAlpha(alpha: Int) {}
-
-    override fun setColorFilter(colorFilter: ColorFilter?) {
-        framePaint.colorFilter = colorFilter
-        batteryPaint.colorFilter = colorFilter
-        warningTextPaint.colorFilter = colorFilter
-        boltPaint.colorFilter = colorFilter
-        plusPaint.colorFilter = colorFilter
-    }
-
-    override fun getOpacity() = PixelFormat.UNKNOWN
-
-    companion object {
-        private fun loadPoints(
-            res: Resources,
-            pointArrayRes: Int
-        ): FloatArray {
-            val pts = res.getIntArray(pointArrayRes)
-            var maxX = 0
-            var maxY = 0
-            run {
-                var i = 0
-                while (i < pts.size) {
-                    maxX = max(maxX, pts[i])
-                    maxY = max(maxY, pts[i + 1])
-                    i += 2
-                }
-            }
-            val ptsF = FloatArray(pts.size)
-            var i = 0
-            while (i < pts.size) {
-                ptsF[i] = pts[i].toFloat() / maxX
-                ptsF[i + 1] = pts[i + 1].toFloat() / maxY
-                i += 2
-            }
-            return ptsF
-        }
-    }
-
-    init {
-        val res = context.resources
-        val color_levels = res.obtainTypedArray(R.array.batterymeter_color_levels)
-        val color_values = res.obtainTypedArray(R.array.batterymeter_color_values)
-        colors = IntArray(2 * color_levels.length())
-        for (i in 0 until color_levels.length()) {
-            colors[2 * i] = color_levels.getInt(i, 0)
-            if (color_values.getType(i) == TypedValue.TYPE_ATTRIBUTE) {
-                colors[2 * i + 1] = Utils.getColorAttrDefaultColor(
-                    context,
-                    color_values.getThemeAttributeId(i, 0)
-                )
-            } else {
-                colors[2 * i + 1] = color_values.getColor(i, 0)
-            }
-        }
-        color_levels.recycle()
-        color_values.recycle()
-        warningString = res.getString(R.string.battery_meter_very_low_overlay_symbol)
-        criticalLevel = res.getInteger(
-            com.android.internal.R.integer.config_criticalBatteryWarningLevel
-        )
-        framePaint = Paint(Paint.ANTI_ALIAS_FLAG)
-        framePaint.color = frameColor
-        framePaint.isDither = true
-        batteryPaint = Paint(Paint.ANTI_ALIAS_FLAG)
-        batteryPaint.isDither = true
-        textPaint = Paint(Paint.ANTI_ALIAS_FLAG)
-        textPaint.typeface = Typeface.create("sans-serif-condensed", Typeface.BOLD)
-        textPaint.textAlign = Paint.Align.CENTER
-        warningTextPaint = Paint(Paint.ANTI_ALIAS_FLAG)
-        warningTextPaint.typeface = Typeface.create("sans-serif", Typeface.BOLD)
-        warningTextPaint.textAlign = Paint.Align.CENTER
-        if (colors.size > 1) {
-            warningTextPaint.color = colors[1]
-        }
-        chargeColor = Utils.getColorStateListDefaultColor(context, R.color.meter_consumed_color)
-        boltPaint = Paint(Paint.ANTI_ALIAS_FLAG)
-        boltPaint.color = Utils.getColorStateListDefaultColor(
-            context,
-            R.color.batterymeter_bolt_color
-        )
-        boltPoints =
-            loadPoints(res, R.array.batterymeter_bolt_points)
-        plusPaint = Paint(Paint.ANTI_ALIAS_FLAG)
-        plusPaint.color = Utils.getColorStateListDefaultColor(
-            context,
-            R.color.batterymeter_plus_color
-        )
-        powerSavePaint = Paint(Paint.ANTI_ALIAS_FLAG)
-        powerSavePaint.color = plusPaint.color
-        powerSavePaint.style = Paint.Style.STROKE
-        intrinsicWidth = res.getDimensionPixelSize(R.dimen.battery_width)
-        intrinsicHeight = res.getDimensionPixelSize(R.dimen.battery_height)
-
-        dualTone = res.getBoolean(com.android.internal.R.bool.config_batterymeterDualTone)
-    }
-}
diff --git a/packages/SettingsLib/src/com/android/settingslib/graph/ThemedBatteryDrawable.kt b/packages/SettingsLib/src/com/android/settingslib/graph/ThemedBatteryDrawable.kt
index 8c93f4cee7b8..73f6db6d464b 100644
--- a/packages/SettingsLib/src/com/android/settingslib/graph/ThemedBatteryDrawable.kt
+++ b/packages/SettingsLib/src/com/android/settingslib/graph/ThemedBatteryDrawable.kt
@@ -25,7 +25,6 @@ import android.graphics.Path
 import android.graphics.PixelFormat
 import android.graphics.Rect
 import android.graphics.RectF
-import android.graphics.Typeface
 import android.graphics.drawable.Drawable
 import android.util.PathParser
 import android.util.TypedValue
@@ -107,12 +106,6 @@ open class ThemedBatteryDrawable(private val context: Context, frameColor: Int)
             postInvalidate()
         }
 
-    var showPercent = false
-        set(value) {
-            field = value
-            postInvalidate()
-        }
-
     private val fillColorStrokePaint = Paint(Paint.ANTI_ALIAS_FLAG).also { p ->
         p.color = frameColor
         p.alpha = 255
@@ -159,11 +152,6 @@ open class ThemedBatteryDrawable(private val context: Context, frameColor: Int)
         p.style = Paint.Style.FILL_AND_STROKE
     }
 
-    private val textPaint = Paint(Paint.ANTI_ALIAS_FLAG).also { p ->
-        p.typeface = Typeface.create("sans-serif-condensed", Typeface.BOLD)
-        p.textAlign = Paint.Align.CENTER
-    }
-
     init {
         val density = context.resources.displayMetrics.density
         intrinsicHeight = (Companion.HEIGHT * density).toInt()
@@ -263,25 +251,6 @@ open class ThemedBatteryDrawable(private val context: Context, frameColor: Int)
             c.drawPath(scaledPlus, fillPaint)
         }
         c.restore()
-
-        if (!charging && batteryLevel < 100 && showPercent) {
-            textPaint.textSize = bounds.height() * 0.38f
-            val textHeight = -textPaint.fontMetrics.ascent
-            val pctX = bounds.width() * 0.5f
-            val pctY = (bounds.height() + textHeight) * 0.5f
-
-            textPaint.color = fillColor
-            c.drawText(batteryLevel.toString(), pctX, pctY, textPaint)
-
-            textPaint.color = fillColor.toInt().inv() or 0xFF000000.toInt()
-            c.save()
-            c.clipRect(fillRect.left,
-                    fillRect.top + (fillRect.height() * (1 - fillFraction)),
-                    fillRect.right,
-                    fillRect.bottom)
-            c.drawText(batteryLevel.toString(), pctX, pctY, textPaint)
-            c.restore()
-        }
     }
 
     private fun batteryColorForLevel(level: Int): Int {
diff --git a/packages/SystemUI/multivalentTests/src/com/android/systemui/theme/ThemeOverlayControllerTest.java b/packages/SystemUI/multivalentTests/src/com/android/systemui/theme/ThemeOverlayControllerTest.java
index 8a72fad8b8f9..8a6803413144 100644
--- a/packages/SystemUI/multivalentTests/src/com/android/systemui/theme/ThemeOverlayControllerTest.java
+++ b/packages/SystemUI/multivalentTests/src/com/android/systemui/theme/ThemeOverlayControllerTest.java
@@ -74,7 +74,6 @@ import com.android.systemui.statusbar.policy.DeviceProvisionedController;
 import com.android.systemui.statusbar.policy.DeviceProvisionedController.DeviceProvisionedListener;
 import com.android.systemui.util.kotlin.JavaAdapter;
 import com.android.systemui.util.settings.SecureSettings;
-import com.android.systemui.util.settings.SystemSettings;
 
 import com.google.common.util.concurrent.MoreExecutors;
 
@@ -122,8 +121,6 @@ public class ThemeOverlayControllerTest extends SysuiTestCase {
     @Mock
     private SecureSettings mSecureSettings;
     @Mock
-    private SystemSettings mSystemSettings;
-    @Mock
     private WallpaperManager mWallpaperManager;
     @Mock
     private UserManager mUserManager;
@@ -188,8 +185,7 @@ public class ThemeOverlayControllerTest extends SysuiTestCase {
 
         mThemeOverlayController = new ThemeOverlayController(mContext,
                 mBroadcastDispatcher, mBgHandler, mMainExecutor, mBgExecutor, mThemeOverlayApplier,
-                mSecureSettings, mSystemSettings, mWallpaperManager, mUserManager,
-                mDeviceProvisionedController,
+                mSecureSettings, mWallpaperManager, mUserManager, mDeviceProvisionedController,
                 mUserTracker, mDumpManager, mFeatureFlags, mResources, mWakefulnessLifecycle,
                 mJavaAdapter, mKeyguardTransitionInteractor, mUiModeManager, mActivityManager,
                 mSystemProperties) {
@@ -927,8 +923,7 @@ public class ThemeOverlayControllerTest extends SysuiTestCase {
 
         mThemeOverlayController = new ThemeOverlayController(mContext,
                 mBroadcastDispatcher, mBgHandler, executor, executor, mThemeOverlayApplier,
-                mSecureSettings, mSystemSettings, mWallpaperManager, mUserManager,
-                mDeviceProvisionedController,
+                mSecureSettings, mWallpaperManager, mUserManager, mDeviceProvisionedController,
                 mUserTracker, mDumpManager, mFeatureFlags, mResources, mWakefulnessLifecycle,
                 mJavaAdapter, mKeyguardTransitionInteractor, mUiModeManager, mActivityManager,
                 mSystemProperties) {
@@ -969,8 +964,7 @@ public class ThemeOverlayControllerTest extends SysuiTestCase {
         Executor executor = MoreExecutors.directExecutor();
         mThemeOverlayController = new ThemeOverlayController(mContext,
                 mBroadcastDispatcher, mBgHandler, executor, executor, mThemeOverlayApplier,
-                mSecureSettings, mSystemSettings, mWallpaperManager, mUserManager,
-                mDeviceProvisionedController,
+                mSecureSettings, mWallpaperManager, mUserManager, mDeviceProvisionedController,
                 mUserTracker, mDumpManager, mFeatureFlags, mResources, mWakefulnessLifecycle,
                 mJavaAdapter, mKeyguardTransitionInteractor, mUiModeManager, mActivityManager,
                 mSystemProperties) {
diff --git a/packages/SystemUI/res/layout/battery_percentage_view.xml b/packages/SystemUI/res/layout/battery_percentage_view.xml
index 32c18ffd27c8..8aa6930a09f9 100644
--- a/packages/SystemUI/res/layout/battery_percentage_view.xml
+++ b/packages/SystemUI/res/layout/battery_percentage_view.xml
@@ -25,6 +25,7 @@
         android:textAppearance="@style/TextAppearance.StatusBar.Default"
         android:textColor="?android:attr/textColorPrimary"
         android:gravity="center_vertical|start"
+        android:paddingStart="@dimen/battery_level_padding_start"
         android:importantForAccessibility="no"
         android:includeFontPadding="false"
         />
diff --git a/packages/SystemUI/res/values/lineage_dimens.xml b/packages/SystemUI/res/values/lineage_dimens.xml
index e1998ce3d3ab..4a24b9d35714 100644
--- a/packages/SystemUI/res/values/lineage_dimens.xml
+++ b/packages/SystemUI/res/values/lineage_dimens.xml
@@ -16,9 +16,6 @@
      limitations under the License.
 -->
 <resources>
-    <!-- Width of the battery icon in the status bar when set to circle style. -->
-    <dimen name="status_bar_battery_icon_circle_width">14.5dp</dimen>
-
     <!-- Largest size an avatar might need to be drawn in the power menu user picker -->
     <dimen name="global_actions_avatar_size">24dp</dimen>
 </resources>
diff --git a/packages/SystemUI/res/xml/status_bar_prefs.xml b/packages/SystemUI/res/xml/status_bar_prefs.xml
index 76f78409e49e..0c6a850b7fe9 100644
--- a/packages/SystemUI/res/xml/status_bar_prefs.xml
+++ b/packages/SystemUI/res/xml/status_bar_prefs.xml
@@ -108,10 +108,11 @@
         android:key="vpn"
         android:title="@string/legacy_vpn_name" />
 
-    <com.android.systemui.tuner.StatusBarSwitch
+    <com.android.systemui.tuner.BatteryPreference
         android:icon="@*android:drawable/ic_battery"
-        android:key="battery"
-        android:title="@string/battery" />
+        android:title="@string/battery"
+        android:summary="%s"
+        android:entries="@array/battery_options" />
 
     <com.android.systemui.tuner.StatusBarSwitch
         android:icon="@drawable/ic_statusbar_alarm"
diff --git a/packages/SystemUI/src/com/android/systemui/battery/AccessorizedBatteryDrawable.kt b/packages/SystemUI/src/com/android/systemui/battery/AccessorizedBatteryDrawable.kt
index 3d72c9f119d0..b8de117fcbe9 100644
--- a/packages/SystemUI/src/com/android/systemui/battery/AccessorizedBatteryDrawable.kt
+++ b/packages/SystemUI/src/com/android/systemui/battery/AccessorizedBatteryDrawable.kt
@@ -204,11 +204,6 @@ class AccessorizedBatteryDrawable(
         mainBatteryDrawable.setColors(fgColor, bgColor, singleToneColor)
     }
 
-    /** Shows the battery percentage. */
-    fun showPercent(percentage: Boolean) {
-        mainBatteryDrawable.showPercent = percentage
-    }
-
     /** Notifies this drawable that the density might have changed. */
     fun notifyDensityChanged() {
         density = context.resources.displayMetrics.density
diff --git a/packages/SystemUI/src/com/android/systemui/battery/BatteryMeterView.java b/packages/SystemUI/src/com/android/systemui/battery/BatteryMeterView.java
index c53d64911b49..e63472684585 100644
--- a/packages/SystemUI/src/com/android/systemui/battery/BatteryMeterView.java
+++ b/packages/SystemUI/src/com/android/systemui/battery/BatteryMeterView.java
@@ -15,11 +15,11 @@
  */
 package com.android.systemui.battery;
 
+import static android.provider.Settings.System.SHOW_BATTERY_PERCENT;
+
 import static com.android.settingslib.flags.Flags.newStatusBarIcons;
 import static com.android.systemui.DejankUtils.whitelistIpcs;
 
-import static lineageos.providers.LineageSettings.System.STATUS_BAR_SHOW_BATTERY_PERCENT;
-
 import static java.lang.annotation.RetentionPolicy.SOURCE;
 
 import android.animation.LayoutTransition;
@@ -35,12 +35,12 @@ import android.content.res.TypedArray;
 import android.graphics.Rect;
 import android.graphics.drawable.Drawable;
 import android.os.UserHandle;
+import android.provider.Settings;
 import android.text.TextUtils;
 import android.util.AttributeSet;
 import android.util.TypedValue;
 import android.view.Gravity;
 import android.view.LayoutInflater;
-import android.view.View;
 import android.widget.ImageView;
 import android.widget.LinearLayout;
 import android.widget.TextView;
@@ -49,7 +49,6 @@ import androidx.annotation.StyleRes;
 import androidx.annotation.VisibleForTesting;
 
 import com.android.app.animation.Interpolators;
-import com.android.settingslib.graph.CircleBatteryDrawable;
 import com.android.systemui.DualToneHandler;
 import com.android.systemui.battery.unified.BatteryColors;
 import com.android.systemui.battery.unified.BatteryDrawableState;
@@ -60,8 +59,6 @@ import com.android.systemui.plugins.DarkIconDispatcher.DarkReceiver;
 import com.android.systemui.res.R;
 import com.android.systemui.statusbar.policy.BatteryController;
 
-import lineageos.providers.LineageSettings;
-
 import java.io.PrintWriter;
 import java.lang.annotation.Retention;
 import java.text.NumberFormat;
@@ -69,10 +66,6 @@ import java.util.ArrayList;
 
 public class BatteryMeterView extends LinearLayout implements DarkReceiver {
 
-    protected static final int BATTERY_STYLE_PORTRAIT = 0;
-    protected static final int BATTERY_STYLE_CIRCLE = 1;
-    protected static final int BATTERY_STYLE_TEXT = 2;
-
     @Retention(SOURCE)
     @IntDef({MODE_DEFAULT, MODE_ON, MODE_OFF, MODE_ESTIMATE})
     public @interface BatteryPercentMode {}
@@ -81,8 +74,7 @@ public class BatteryMeterView extends LinearLayout implements DarkReceiver {
     public static final int MODE_OFF = 2;
     public static final int MODE_ESTIMATE = 3;
 
-    private final AccessorizedBatteryDrawable mAccessorizedDrawable;
-    private final CircleBatteryDrawable mCircleDrawable;
+    private final AccessorizedBatteryDrawable mDrawable;
     private final ImageView mBatteryIconView;
     private TextView mBatteryPercentView;
 
@@ -90,6 +82,7 @@ public class BatteryMeterView extends LinearLayout implements DarkReceiver {
     private int mTextColor;
     private int mLevel;
     private int mShowPercentMode = MODE_DEFAULT;
+    private boolean mShowPercentAvailable;
     private String mEstimateText = null;
     private boolean mPluggedIn;
     private boolean mPowerSaveEnabled;
@@ -127,10 +120,12 @@ public class BatteryMeterView extends LinearLayout implements DarkReceiver {
                 context.getColor(com.android.settingslib.R.color.meter_background_color));
         mPercentageStyleId = atts.getResourceId(R.styleable.BatteryMeterView_textAppearance, 0);
 
-        mAccessorizedDrawable = new AccessorizedBatteryDrawable(context, frameColor);
-        mCircleDrawable = new CircleBatteryDrawable(context, frameColor);
+        mDrawable = new AccessorizedBatteryDrawable(context, frameColor);
         atts.recycle();
 
+        mShowPercentAvailable = context.getResources().getBoolean(
+                com.android.internal.R.bool.config_battery_percentage_setting_available);
+
         setupLayoutTransition();
 
         mBatteryIconView = new ImageView(context);
@@ -146,12 +141,9 @@ public class BatteryMeterView extends LinearLayout implements DarkReceiver {
                             R.dimen.status_bar_battery_unified_icon_height));
             addView(mBatteryIconView, mlp);
         } else {
-            updateDrawable();
+            mBatteryIconView.setImageDrawable(mDrawable);
             final MarginLayoutParams mlp = new MarginLayoutParams(
-                    getBatteryStyle() == BATTERY_STYLE_PORTRAIT ?
-                    getResources().getDimensionPixelSize(R.dimen.status_bar_battery_icon_width) :
-                    getResources().getDimensionPixelSize(
-                    R.dimen.status_bar_battery_icon_circle_width),
+                    getResources().getDimensionPixelSize(R.dimen.status_bar_battery_icon_width),
                     getResources().getDimensionPixelSize(R.dimen.status_bar_battery_icon_height));
             mlp.setMargins(0, 0, 0,
                     getResources().getDimensionPixelOffset(R.dimen.battery_margin_bottom));
@@ -196,12 +188,6 @@ public class BatteryMeterView extends LinearLayout implements DarkReceiver {
         setLayoutTransition(transition);
     }
 
-    protected void updateBatteryStyle() {
-        updateDrawable();
-        scaleBatteryMeterViews();
-        updatePercentView();
-    }
-
     public void setForceShowPercent(boolean show) {
         setPercentShowMode(show ? MODE_ON : MODE_DEFAULT);
     }
@@ -225,8 +211,8 @@ public class BatteryMeterView extends LinearLayout implements DarkReceiver {
     @Override
     protected void onConfigurationChanged(Configuration newConfig) {
         super.onConfigurationChanged(newConfig);
-        updateBatteryStyle();
-        mAccessorizedDrawable.notifyDensityChanged();
+        updatePercentView();
+        mDrawable.notifyDensityChanged();
     }
 
     public void setColorsFromContext(Context context) {
@@ -253,14 +239,9 @@ public class BatteryMeterView extends LinearLayout implements DarkReceiver {
         mPluggedIn = pluggedIn;
         mLevel = level;
         boolean isCharging = isCharging();
-        mAccessorizedDrawable.setCharging(isCharging);
-        mCircleDrawable.setCharging(isCharging);
-        mAccessorizedDrawable.setBatteryLevel(level);
-        mCircleDrawable.setBatteryLevel(level);
+        mDrawable.setCharging(isCharging);
+        mDrawable.setBatteryLevel(level);
         updatePercentText();
-        if (pluggedIn) {
-            updateShowPercent();
-        }
 
         if (newStatusBarIcons()) {
             Drawable attr = mUnifiedBatteryState.getAttribution();
@@ -332,8 +313,7 @@ public class BatteryMeterView extends LinearLayout implements DarkReceiver {
         }
         mPowerSaveEnabled = isPowerSave;
         if (!newStatusBarIcons()) {
-            mAccessorizedDrawable.setPowerSaveEnabled(isPowerSave);
-            mCircleDrawable.setPowerSaveEnabled(isPowerSave);
+            mDrawable.setPowerSaveEnabled(isPowerSave);
         } else {
             setBatteryDrawableState(
                     new BatteryDrawableState(
@@ -385,7 +365,7 @@ public class BatteryMeterView extends LinearLayout implements DarkReceiver {
                         )
                 );
             } else {
-                mAccessorizedDrawable.setCharging(isCharging());
+                mDrawable.setCharging(isCharging());
             }
             updateContentDescription();
         }
@@ -547,20 +527,18 @@ public class BatteryMeterView extends LinearLayout implements DarkReceiver {
             return;
         }
 
-        if (mUnifiedBattery == null) return;
+        if (!mShowPercentAvailable || mUnifiedBattery == null) return;
 
-        // TODO(b/140051051)
-        final int showBatteryPercent = LineageSettings.System.getIntForUser(
-                getContext().getContentResolver(), STATUS_BAR_SHOW_BATTERY_PERCENT, 0,
-                UserHandle.USER_CURRENT);
-        final boolean drawPercentInside = mShowPercentMode == MODE_DEFAULT &&
-                showBatteryPercent == 1;
-        final boolean drawPercentOnly = mShowPercentMode == MODE_ESTIMATE ||
-                showBatteryPercent == 2;
-        boolean shouldShow =
-                (drawPercentOnly && (!drawPercentInside || isCharging()) ||
-                getBatteryStyle() == BATTERY_STYLE_TEXT);
-        shouldShow = shouldShow && !mBatteryStateUnknown;
+        boolean shouldShow = mShowPercentMode == MODE_ON || mShowPercentMode == MODE_ESTIMATE;
+        if (!mBatteryStateUnknown && !shouldShow && (mShowPercentMode != MODE_OFF)) {
+            // Slow case: fall back to the system setting
+            // TODO(b/140051051)
+            shouldShow = 0 != whitelistIpcs(() -> Settings.System
+                    .getIntForUser(getContext().getContentResolver(),
+                    SHOW_BATTERY_PERCENT, getContext().getResources().getBoolean(
+                    com.android.internal.R.bool.config_defaultBatteryPercentageSetting)
+                    ? 1 : 0, UserHandle.USER_CURRENT));
+        }
 
         setBatteryDrawableState(
                 new BatteryDrawableState(
@@ -582,36 +560,23 @@ public class BatteryMeterView extends LinearLayout implements DarkReceiver {
     private void updateShowPercentLegacy() {
         final boolean showing = mBatteryPercentView != null;
         // TODO(b/140051051)
-        final int showBatteryPercent = LineageSettings.System.getIntForUser(
-                getContext().getContentResolver(), STATUS_BAR_SHOW_BATTERY_PERCENT, 0,
-                UserHandle.USER_CURRENT);
-        final boolean drawPercentInside = mShowPercentMode == MODE_DEFAULT &&
-                showBatteryPercent == 1;
-        final boolean drawPercentOnly = mShowPercentMode == MODE_ESTIMATE ||
-                showBatteryPercent == 2;
+        final boolean systemSetting = 0 != whitelistIpcs(() -> Settings.System
+                .getIntForUser(getContext().getContentResolver(),
+                SHOW_BATTERY_PERCENT, getContext().getResources().getBoolean(
+                com.android.internal.R.bool.config_defaultBatteryPercentageSetting)
+                ? 1 : 0, UserHandle.USER_CURRENT));
         boolean shouldShow =
-                (drawPercentOnly && (!drawPercentInside || isCharging()) ||
-                getBatteryStyle() == BATTERY_STYLE_TEXT);
+                (mShowPercentAvailable && systemSetting && mShowPercentMode != MODE_OFF)
+                || mShowPercentMode == MODE_ON
+                || mShowPercentMode == MODE_ESTIMATE;
         shouldShow = shouldShow && !mBatteryStateUnknown;
 
         if (shouldShow) {
-            mAccessorizedDrawable.showPercent(false);
-            mCircleDrawable.setShowPercent(false);
             if (!showing) {
                 addPercentView(inflatePercentView());
                 updatePercentText();
             }
-            if (getBatteryStyle() == BATTERY_STYLE_TEXT) {
-                mBatteryPercentView.setPaddingRelative(0, 0, 0, 0);
-            } else {
-                Resources res = getContext().getResources();
-                mBatteryPercentView.setPaddingRelative(
-                        res.getDimensionPixelSize(R.dimen.battery_level_padding_start), 0, 0, 0);
-            }
-
         } else {
-            mAccessorizedDrawable.showPercent(drawPercentInside);
-            mCircleDrawable.setShowPercent(drawPercentInside);
             if (showing) {
                 removeView(mBatteryPercentView);
                 mBatteryPercentView = null;
@@ -639,7 +604,7 @@ public class BatteryMeterView extends LinearLayout implements DarkReceiver {
         if (mBatteryStateUnknown) {
             mBatteryIconView.setImageDrawable(getUnknownStateDrawable());
         } else {
-            updateDrawable();
+            mBatteryIconView.setImageDrawable(mDrawable);
         }
 
         updateShowPercent();
@@ -684,12 +649,10 @@ public class BatteryMeterView extends LinearLayout implements DarkReceiver {
         res.getValue(R.dimen.status_bar_icon_scale_factor, typedValue, true);
         float iconScaleFactor = typedValue.getFloat();
 
-        int batteryHeight = res.getDimensionPixelSize(R.dimen.status_bar_battery_icon_height);
-        int batteryWidth = getBatteryStyle() == BATTERY_STYLE_CIRCLE ?
-                res.getDimensionPixelSize(R.dimen.status_bar_battery_icon_circle_width) :
-                res.getDimensionPixelSize(R.dimen.status_bar_battery_icon_width);
-        float mainBatteryHeight = batteryHeight * iconScaleFactor;
-        float mainBatteryWidth = batteryWidth * iconScaleFactor;
+        float mainBatteryHeight =
+                res.getDimensionPixelSize(R.dimen.status_bar_battery_icon_height) * iconScaleFactor;
+        float mainBatteryWidth =
+                res.getDimensionPixelSize(R.dimen.status_bar_battery_icon_width) * iconScaleFactor;
 
         boolean displayShield = mIsBatteryDefender;
         float fullBatteryIconHeight =
@@ -718,32 +681,9 @@ public class BatteryMeterView extends LinearLayout implements DarkReceiver {
                 Math.round(fullBatteryIconHeight));
         scaledLayoutParams.setMargins(0, marginTop, 0, marginBottom);
 
-        mAccessorizedDrawable.setDisplayShield(displayShield);
+        mDrawable.setDisplayShield(displayShield);
         mBatteryIconView.setLayoutParams(scaledLayoutParams);
-        mBatteryIconView.invalidateDrawable(mAccessorizedDrawable);
-    }
-
-    private void updateDrawable() {
-        switch (getBatteryStyle()) {
-            case BATTERY_STYLE_PORTRAIT:
-                mBatteryIconView.setImageDrawable(mAccessorizedDrawable);
-                mBatteryIconView.setVisibility(View.VISIBLE);
-                break;
-            case BATTERY_STYLE_CIRCLE:
-                mBatteryIconView.setImageDrawable(mCircleDrawable);
-                mBatteryIconView.setVisibility(View.VISIBLE);
-                break;
-            case BATTERY_STYLE_TEXT:
-                mBatteryIconView.setVisibility(View.GONE);
-                mBatteryIconView.setImageDrawable(null);
-                break;
-        }
-    }
-
-    private int getBatteryStyle() {
-        return LineageSettings.System.getIntForUser(getContext().getContentResolver(),
-                LineageSettings.System.STATUS_BAR_BATTERY_STYLE, BATTERY_STYLE_PORTRAIT,
-                UserHandle.USER_CURRENT);
+        mBatteryIconView.invalidateDrawable(mDrawable);
     }
 
     @Override
@@ -797,8 +737,7 @@ public class BatteryMeterView extends LinearLayout implements DarkReceiver {
      * @param singleToneColor
      */
     public void updateColors(int foregroundColor, int backgroundColor, int singleToneColor) {
-        mAccessorizedDrawable.setColors(foregroundColor, backgroundColor, singleToneColor);
-        mCircleDrawable.setColors(foregroundColor, backgroundColor, singleToneColor);
+        mDrawable.setColors(foregroundColor, backgroundColor, singleToneColor);
         mTextColor = singleToneColor;
         if (mBatteryPercentView != null) {
             mBatteryPercentView.setTextColor(singleToneColor);
@@ -823,15 +762,12 @@ public class BatteryMeterView extends LinearLayout implements DarkReceiver {
     }
 
     public void dump(PrintWriter pw, String[] args) {
-        String powerSave = mAccessorizedDrawable == null ?
-                null : mAccessorizedDrawable.getPowerSaveEnabled() + "";
-        String displayShield = mAccessorizedDrawable == null ?
-                null : mAccessorizedDrawable.getDisplayShield() + "";
-        String charging = mAccessorizedDrawable == null ?
-                null : mAccessorizedDrawable.getCharging() + "";
+        String powerSave = mDrawable == null ? null : mDrawable.getPowerSaveEnabled() + "";
+        String displayShield = mDrawable == null ? null : mDrawable.getDisplayShield() + "";
+        String charging = mDrawable == null ? null : mDrawable.getCharging() + "";
         CharSequence percent = mBatteryPercentView == null ? null : mBatteryPercentView.getText();
         pw.println("  BatteryMeterView:");
-        pw.println("    mAccessorizedDrawable.getPowerSave: " + powerSave);
+        pw.println("    mDrawable.getPowerSave: " + powerSave);
         pw.println("    mDrawable.getDisplayShield: " + displayShield);
         pw.println("    mDrawable.getCharging: " + charging);
         pw.println("    mBatteryPercentView.getText(): " + percent);
diff --git a/packages/SystemUI/src/com/android/systemui/battery/BatteryMeterViewController.java b/packages/SystemUI/src/com/android/systemui/battery/BatteryMeterViewController.java
index 27e20e69c9eb..fcf51051940c 100644
--- a/packages/SystemUI/src/com/android/systemui/battery/BatteryMeterViewController.java
+++ b/packages/SystemUI/src/com/android/systemui/battery/BatteryMeterViewController.java
@@ -15,8 +15,7 @@
  */
 package com.android.systemui.battery;
 
-import static lineageos.providers.LineageSettings.System.STATUS_BAR_BATTERY_STYLE;
-import static lineageos.providers.LineageSettings.System.STATUS_BAR_SHOW_BATTERY_PERCENT;
+import static android.provider.Settings.System.SHOW_BATTERY_PERCENT;
 
 import android.content.ContentResolver;
 import android.content.Context;
@@ -43,8 +42,6 @@ import com.android.systemui.statusbar.policy.ConfigurationController;
 import com.android.systemui.tuner.TunerService;
 import com.android.systemui.util.ViewController;
 
-import lineageos.providers.LineageSettings;
-
 import java.io.PrintWriter;
 
 import javax.inject.Inject;
@@ -80,11 +77,7 @@ public class BatteryMeterViewController extends ViewController<BatteryMeterView>
             if (StatusBarIconController.ICON_HIDE_LIST.equals(key)) {
                 ArraySet<String> icons = StatusBarIconController.getIconHideList(
                         getContext(), newValue);
-                mBatteryHidden = icons.contains(mSlotBattery);
-                mView.setVisibility(mBatteryHidden ? View.GONE : View.VISIBLE);
-                if (!mBatteryHidden) {
-                    mView.updateBatteryStyle();
-                }
+                mView.setVisibility(icons.contains(mSlotBattery) ? View.GONE : View.VISIBLE);
             }
         }
     };
@@ -140,8 +133,6 @@ public class BatteryMeterViewController extends ViewController<BatteryMeterView>
     private boolean mIgnoreTunerUpdates;
     private boolean mIsSubscribedForTunerUpdates;
 
-    private boolean mBatteryHidden;
-
     @Inject
     public BatteryMeterViewController(
             BatteryMeterView view,
@@ -221,12 +212,7 @@ public class BatteryMeterViewController extends ViewController<BatteryMeterView>
 
     private void registerShowBatteryPercentObserver(int user) {
         mContentResolver.registerContentObserver(
-                LineageSettings.System.getUriFor(STATUS_BAR_SHOW_BATTERY_PERCENT),
-                false,
-                mSettingObserver,
-                user);
-        mContentResolver.registerContentObserver(
-                LineageSettings.System.getUriFor(STATUS_BAR_BATTERY_STYLE),
+                Settings.System.getUriFor(SHOW_BATTERY_PERCENT),
                 false,
                 mSettingObserver,
                 user);
@@ -253,9 +239,6 @@ public class BatteryMeterViewController extends ViewController<BatteryMeterView>
                 // update the text for sure if the estimate in the cache was updated
                 mView.updatePercentText();
             }
-            if (TextUtils.equals(uri.getLastPathSegment(), STATUS_BAR_BATTERY_STYLE)) {
-                mView.updateBatteryStyle();
-            }
         }
     }
 
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/phone/KeyguardStatusBarView.java b/packages/SystemUI/src/com/android/systemui/statusbar/phone/KeyguardStatusBarView.java
index e93a7846ccdc..83e5db4db6fe 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/phone/KeyguardStatusBarView.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/phone/KeyguardStatusBarView.java
@@ -75,6 +75,7 @@ public class KeyguardStatusBarView extends RelativeLayout {
 
     private final ArrayList<Rect> mEmptyTintRect = new ArrayList<>();
 
+    private boolean mShowPercentAvailable;
     private boolean mBatteryCharging;
 
     private TextView mCarrierLabel;
@@ -226,6 +227,8 @@ public class KeyguardStatusBarView extends RelativeLayout {
                 R.dimen.ongoing_appops_dot_min_padding);
         mCutoutSideNudge = getResources().getDimensionPixelSize(
                 R.dimen.display_cutout_margin_consumption);
+        mShowPercentAvailable = getContext().getResources().getBoolean(
+                com.android.internal.R.bool.config_battery_percentage_setting_available);
         mRoundedCornerPadding = res.getDimensionPixelSize(
                 R.dimen.rounded_corner_content_padding);
     }
@@ -264,7 +267,7 @@ public class KeyguardStatusBarView extends RelativeLayout {
         }
 
         if (mBatteryView != null) {
-            mBatteryView.setForceShowPercent(mBatteryCharging);
+            mBatteryView.setForceShowPercent(mBatteryCharging && mShowPercentAvailable);
         }
     }
 
diff --git a/packages/SystemUI/src/com/android/systemui/theme/ThemeOverlayController.java b/packages/SystemUI/src/com/android/systemui/theme/ThemeOverlayController.java
index 524cef9e31af..f9c3f8c373db 100644
--- a/packages/SystemUI/src/com/android/systemui/theme/ThemeOverlayController.java
+++ b/packages/SystemUI/src/com/android/systemui/theme/ThemeOverlayController.java
@@ -89,7 +89,6 @@ import com.android.systemui.statusbar.policy.DeviceProvisionedController;
 import com.android.systemui.statusbar.policy.DeviceProvisionedController.DeviceProvisionedListener;
 import com.android.systemui.util.kotlin.JavaAdapter;
 import com.android.systemui.util.settings.SecureSettings;
-import com.android.systemui.util.settings.SystemSettings;
 
 import com.google.ux.material.libmonet.dynamiccolor.DynamicColor;
 import com.google.ux.material.libmonet.dynamiccolor.MaterialDynamicColors;
@@ -97,8 +96,6 @@ import com.google.ux.material.libmonet.dynamiccolor.MaterialDynamicColors;
 import kotlinx.coroutines.flow.Flow;
 import kotlinx.coroutines.flow.StateFlow;
 
-import lineageos.providers.LineageSettings;
-
 import org.json.JSONException;
 import org.json.JSONObject;
 
@@ -136,7 +133,6 @@ public class ThemeOverlayController implements CoreStartable, Dumpable {
     private final BroadcastDispatcher mBroadcastDispatcher;
     private final Executor mBgExecutor;
     private final SecureSettings mSecureSettings;
-    private final SystemSettings mSystemSettings;
     private final Executor mMainExecutor;
     private final Handler mBgHandler;
     private final Context mContext;
@@ -424,7 +420,6 @@ public class ThemeOverlayController implements CoreStartable, Dumpable {
             @Background Executor bgExecutor,
             ThemeOverlayApplier themeOverlayApplier,
             SecureSettings secureSettings,
-            SystemSettings systemSettings,
             WallpaperManager wallpaperManager,
             UserManager userManager,
             DeviceProvisionedController deviceProvisionedController,
@@ -450,7 +445,6 @@ public class ThemeOverlayController implements CoreStartable, Dumpable {
         mBgHandler = bgHandler;
         mThemeManager = themeOverlayApplier;
         mSecureSettings = secureSettings;
-        mSystemSettings = systemSettings;
         mWallpaperManager = wallpaperManager;
         mUserTracker = userTracker;
         mResources = resources;
@@ -528,32 +522,6 @@ public class ThemeOverlayController implements CoreStartable, Dumpable {
                 },
                 UserHandle.USER_ALL);
 
-        mSystemSettings.registerContentObserverForUserSync(
-                LineageSettings.System.getUriFor(LineageSettings.System.STATUS_BAR_BATTERY_STYLE),
-                false,
-                new ContentObserver(mBgHandler) {
-                    @Override
-                    public void onChange(boolean selfChange, Collection<Uri> collection, int flags,
-                            int userId) {
-                        if (DEBUG) Log.d(TAG, "Overlay changed for user: " + userId);
-                        if (mUserTracker.getUserId() != userId) {
-                            return;
-                        }
-                        if (!mDeviceProvisionedController.isUserSetup(userId)) {
-                            Log.i(TAG, "Theme application deferred when setting changed.");
-                            mDeferredThemeEvaluation = true;
-                            return;
-                        }
-                        boolean isCircleBattery = LineageSettings.System.getIntForUser(
-                                mContext.getContentResolver(),
-                                LineageSettings.System.STATUS_BAR_BATTERY_STYLE,
-                                0, UserHandle.USER_CURRENT) == 1;
-                        if (isCircleBattery) {
-                            reevaluateSystemTheme(true /* forceReload */);
-                        }
-                    }
-                },
-                UserHandle.USER_ALL);
 
         // All wallpaper color and keyguard logic only applies when Monet is enabled.
         if (!mIsMonetEnabled) {
-- 
2.51.2.windows.1

