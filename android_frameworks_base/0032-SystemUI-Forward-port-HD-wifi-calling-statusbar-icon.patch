From c17c2b311513b7bfbf6d4030513029bb3cb052ed Mon Sep 17 00:00:00 2001
From: Dhina17 <dhinalogu@gmail.com>
Date: Wed, 31 Jan 2024 16:47:49 +0000
Subject: [PATCH] SystemUI: Forward port 'HD & wifi calling statusbar icons'

Squashed:
* SystemUI: Fix HD calling icon for RTL layout
* SystemUI: sb: Fix VoWifi icon size
* SystemUI: sb: Hide wifi airplane spacer when vowifi is available
* SignalDrawable: Add support for Cut + Roaming back

Adithya R <gh0strider.2k18.reborn@gmail.com>:
    HD icon shows for VoLTE/VoNR, and wifi calling for VoWiFi.
    Based on CLO's volte/vowifi icon implementation, reworked manually.
    Drawables taken from Nothing OS and manually tweaked.

Dhina17 <dhinalogu@gmail.com>:
    Rewrite it for new status bar impl in Android 14.
    Move VoWifi icon to Wifi space.
    New VoWifi icon with SIM identification.

Signed-off-by: Mohammad Hasan Keramat J <ikeramat@protonmail.com>
Signed-off-by: Adithya R <gh0strider.2k18.reborn@gmail.com>
Co-authored-by: Weijie Wang <quic_weijiew@quicinc.com>
Co-authored-by: Adithya R <gh0strider.2k18.reborn@gmail.com>
Co-authored-by: electimon <electimon@gmail.com>
Co-authored-by: nift4 <nift4@protonmail.com>
Original-Change-Id: I0190394690e9b38e0575ffb099be8a5ed2ae9d90
Change-Id: Ib48b1295d060acf462b2f91e81cbb570fd8df42e
Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
Signed-off-by: Dmitrii <bankersenator@gmail.com>
---
 .../SettingsLib/res/values/lineage_config.xml |  11 ++
 .../settingslib/graph/SignalDrawable.java     |  66 ++++++-
 .../status_bar_mobile_signal_group_inner.xml  |  17 +-
 .../SystemUI/res/drawable/ic_hd_calling.xml   |  13 ++
 .../res/drawable/ic_statusbar_hd_calling.xml  |  17 ++
 .../res/drawable/ic_statusbar_roaming.xml     |  21 +-
 .../res/drawable/ic_statusbar_vowifi.xml      |  14 ++
 packages/SystemUI/res/drawable/ic_vowifi.xml  |  27 +++
 .../SystemUI/res/drawable/ic_vowifi_dual.xml  |  35 ++++
 .../SystemUI/res/drawable/ic_vowifi_one.xml   |  31 +++
 .../SystemUI/res/drawable/ic_vowifi_two.xml   |  31 +++
 .../layout/status_bar_wifi_group_inner.xml    |   9 +
 packages/SystemUI/res/values/cm_strings.xml   |   7 +
 .../SystemUI/res/values/lineage_dimens.xml    |   3 +
 .../SystemUI/res/xml/status_bar_prefs.xml     |  12 ++
 .../dagger/FrameworkServicesModule.java       |   7 +
 .../dagger/StatusBarPipelineModule.kt         |   5 +
 .../pipeline/ims/data/model/ImsIconModel.kt   |  21 ++
 .../pipeline/ims/data/model/ImsStateModel.kt  |  38 ++++
 .../data/repository/CommonImsRepository.kt    | 182 +++++++++++++++++
 .../ims/data/repository/ImsRepository.kt      | 184 ++++++++++++++++++
 .../repository/MobileConnectionRepository.kt  |   6 +
 .../demo/DemoMobileConnectionRepository.kt    |   3 +
 .../prod/CarrierMergedConnectionRepository.kt |   2 +
 .../prod/FullMobileConnectionRepository.kt    |  14 ++
 .../prod/MobileConnectionRepositoryImpl.kt    |   7 +
 .../domain/interactor/MobileIconInteractor.kt |  38 +++-
 .../interactor/MobileIconsInteractor.kt       |  20 ++
 .../mobile/domain/model/SignalIconModel.kt    |   8 +-
 .../mobile/ui/binder/MobileIconBinder.kt      |  14 +-
 .../ui/view/ModernStatusBarMobileView.kt      |  18 ++
 .../ui/viewmodel/MobileIconViewModel.kt       |  47 +++--
 .../wifi/data/repository/WifiRepository.kt    |   6 +
 .../data/repository/WifiRepositorySwitcher.kt |   6 +
 .../repository/demo/DemoWifiRepository.kt     |   5 +
 .../repository/prod/DisabledWifiRepository.kt |   4 +
 .../repository/prod/WifiRepositoryImpl.kt     |   7 +
 .../wifi/domain/interactor/WifiInteractor.kt  |  29 +++
 .../pipeline/wifi/shared/model/VoWifiState.kt |  22 +++
 .../pipeline/wifi/ui/binder/WifiViewBinder.kt |  12 ++
 .../pipeline/wifi/ui/model/VoWifiIcon.kt      |  57 ++++++
 .../wifi/ui/viewmodel/WifiViewModel.kt        |  15 ++
 .../wifi/ui/viewmodel/WifiViewModelCommon.kt  |   4 +
 43 files changed, 1047 insertions(+), 48 deletions(-)
 create mode 100644 packages/SettingsLib/res/values/lineage_config.xml
 create mode 100644 packages/SystemUI/res/drawable/ic_hd_calling.xml
 create mode 100644 packages/SystemUI/res/drawable/ic_statusbar_hd_calling.xml
 create mode 100644 packages/SystemUI/res/drawable/ic_statusbar_vowifi.xml
 create mode 100644 packages/SystemUI/res/drawable/ic_vowifi.xml
 create mode 100644 packages/SystemUI/res/drawable/ic_vowifi_dual.xml
 create mode 100644 packages/SystemUI/res/drawable/ic_vowifi_one.xml
 create mode 100644 packages/SystemUI/res/drawable/ic_vowifi_two.xml
 create mode 100644 packages/SystemUI/src/com/android/systemui/statusbar/pipeline/ims/data/model/ImsIconModel.kt
 create mode 100644 packages/SystemUI/src/com/android/systemui/statusbar/pipeline/ims/data/model/ImsStateModel.kt
 create mode 100644 packages/SystemUI/src/com/android/systemui/statusbar/pipeline/ims/data/repository/CommonImsRepository.kt
 create mode 100644 packages/SystemUI/src/com/android/systemui/statusbar/pipeline/ims/data/repository/ImsRepository.kt
 create mode 100644 packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/shared/model/VoWifiState.kt
 create mode 100644 packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/ui/model/VoWifiIcon.kt

diff --git a/packages/SettingsLib/res/values/lineage_config.xml b/packages/SettingsLib/res/values/lineage_config.xml
new file mode 100644
index 000000000000..e465b8147cca
--- /dev/null
+++ b/packages/SettingsLib/res/values/lineage_config.xml
@@ -0,0 +1,11 @@
+<?xml version="1.0" encoding="utf-8"?>
+<resources>
+    <!-- Roaming symbol (R) path for SignalDrawable as defined on a 24x24 canvas. -->
+    <string name="config_signalRoamingPath" translatable="false">
+        M 19.436 19.688 L 18.152 19.688 L 18.152 22 L 17 22 L 17 16 L 19.332 16 C 20.097 16 20.687 16.155 21.103 16.466 C 21.519 16.776 21.727 17.225 21.727 17.813 C 21.727 18.214 21.619 18.551 21.403 18.823 C 21.191 19.092 20.893 19.299 20.511 19.445 L 22 21.946 L 22 22 L 20.766 22 L 19.436 19.688 Z M 18.152 18.852 L 19.336 18.852 C 19.725 18.852 20.028 18.764 20.247 18.588 C 20.465 18.409 20.575 18.166 20.575 17.859 C 20.575 17.537 20.473 17.288 20.27 17.113 C 20.069 16.937 19.769 16.846 19.368 16.841 L 18.152 16.841 L 18.152 18.852 Z
+    </string>
+    <!-- config_roamingCutout{Height,Width}Fraction define fraction of the 24x24 canvas that
+         should be cut out to display config_signalRoamingPath. -->
+    <item name="config_roamingCutoutWidthFraction" format="float" type="dimen">8</item>
+    <item name="config_roamingCutoutHeightFraction" format="float" type="dimen">9</item>
+</resources>
diff --git a/packages/SettingsLib/src/com/android/settingslib/graph/SignalDrawable.java b/packages/SettingsLib/src/com/android/settingslib/graph/SignalDrawable.java
index 671dfa230f0d..6a912c36818f 100644
--- a/packages/SettingsLib/src/com/android/settingslib/graph/SignalDrawable.java
+++ b/packages/SettingsLib/src/com/android/settingslib/graph/SignalDrawable.java
@@ -68,6 +68,8 @@ public class SignalDrawable extends DrawableWrapper {
     private static final int STATE_MASK = 0xff << STATE_SHIFT;
     private static final int STATE_CUT = 2;
     private static final int STATE_CARRIER_CHANGE = 3;
+    private static final int STATE_R = 4;
+    private static final int STATE_CUT_AND_R = 5;
 
     private static final long DOT_DELAY = 1000;
 
@@ -81,11 +83,15 @@ public class SignalDrawable extends DrawableWrapper {
     private final Path mCutoutPath = new Path();
     private final Path mForegroundPath = new Path();
     private final Path mAttributionPath = new Path();
+    private final Path mRoamingPath = new Path();
     private final Matrix mAttributionScaleMatrix = new Matrix();
     private final Path mScaledAttributionPath = new Path();
+    private final Path mScaledRoamingPath = new Path();
     private final Handler mHandler;
     private final float mCutoutWidthFraction;
     private final float mCutoutHeightFraction;
+    private final float mRCutoutWidthFraction;
+    private final float mRCutoutHeightFraction;
     private float mDarkIntensity = -1;
     private final int mIntrinsicSize;
     private boolean mAnimating;
@@ -99,12 +105,19 @@ public class SignalDrawable extends DrawableWrapper {
         super(context.getDrawable(ICON_RES));
         final String attributionPathString = context.getString(
                 com.android.internal.R.string.config_signalAttributionPath);
+        final String roamingPathString = context.getString(
+                R.string.config_signalRoamingPath);
         mAttributionPath.set(PathParser.createPathFromPathData(attributionPathString));
+        mRoamingPath.set(PathParser.createPathFromPathData(roamingPathString));
         updateScaledAttributionPath();
         mCutoutWidthFraction = context.getResources().getFloat(
                 com.android.internal.R.dimen.config_signalCutoutWidthFraction);
         mCutoutHeightFraction = context.getResources().getFloat(
                 com.android.internal.R.dimen.config_signalCutoutHeightFraction);
+        mRCutoutWidthFraction = context.getResources().getFloat(
+                R.dimen.config_roamingCutoutWidthFraction);
+        mRCutoutHeightFraction = context.getResources().getFloat(
+                R.dimen.config_roamingCutoutHeightFraction);
         mDarkModeFillColor = Utils.getColorStateListDefaultColor(context,
                 R.color.dark_mode_icon_color_single_tone);
         mLightModeFillColor = Utils.getColorStateListDefaultColor(context,
@@ -124,6 +137,7 @@ public class SignalDrawable extends DrawableWrapper {
                     getBounds().width() / VIEWPORT, getBounds().height() / VIEWPORT);
         }
         mAttributionPath.transform(mAttributionScaleMatrix, mScaledAttributionPath);
+        mRoamingPath.transform(mAttributionScaleMatrix, mScaledRoamingPath);
     }
 
     @Override
@@ -241,9 +255,32 @@ public class SignalDrawable extends DrawableWrapper {
             drawDotAndPadding(x - dotSpacing * 2, y, dotPadding, dotSize, 0);
             canvas.drawPath(mCutoutPath, mTransparentPaint);
             canvas.drawPath(mForegroundPath, mForegroundPaint);
-        } else if (!newStatusBarIcons() && isInState(STATE_CUT)) {
-            float cutX = (mCutoutWidthFraction * width / VIEWPORT);
-            float cutY = (mCutoutHeightFraction * height / VIEWPORT);
+        } else if (!newStatusBarIcons() && isInState(STATE_CUT_AND_R)) {
+            // Roaming
+            float cutWidth = mRCutoutWidthFraction;
+            float cutHeight = mRCutoutHeightFraction;
+            float cutX = (cutWidth * width / VIEWPORT);
+            float cutY = (cutHeight * height / VIEWPORT);
+            float rIconOffset = -0.8f * (mCutoutWidthFraction * width / VIEWPORT);
+            mCutoutPath.moveTo(width + rIconOffset, height);
+            mCutoutPath.rLineTo(-cutX, 0);
+            mCutoutPath.rLineTo(0, -cutY);
+            mCutoutPath.rLineTo(cutX, 0);
+            mCutoutPath.rLineTo(0, cutY);
+            canvas.drawPath(mCutoutPath, mTransparentPaint);
+            // Adjust mScaledRoamingPath
+            Path adjustedRoamingPath = new Path(mScaledRoamingPath);
+            Matrix matrix = new Matrix();
+            matrix.postTranslate(rIconOffset, 0);
+            adjustedRoamingPath.transform(matrix);
+            canvas.drawPath(adjustedRoamingPath, mForegroundPaint);
+            // Attribution
+            mCutoutPath.reset();
+            mCutoutPath.setFillType(FillType.WINDING);
+            cutWidth = mCutoutWidthFraction;
+            cutHeight = mCutoutHeightFraction;
+            cutX = (cutWidth * width / VIEWPORT);
+            cutY = (cutHeight * height / VIEWPORT);
             mCutoutPath.moveTo(width, height);
             mCutoutPath.rLineTo(-cutX, 0);
             mCutoutPath.rLineTo(0, -cutY);
@@ -251,6 +288,20 @@ public class SignalDrawable extends DrawableWrapper {
             mCutoutPath.rLineTo(0, cutY);
             canvas.drawPath(mCutoutPath, mTransparentPaint);
             canvas.drawPath(mScaledAttributionPath, mForegroundPaint);
+        } else if (!newStatusBarIcons() && (isInState(STATE_CUT) || isInState(STATE_R))) {
+            boolean isRoaming = isInState(STATE_R);
+            float cutWidth = isRoaming ? mRCutoutWidthFraction : mCutoutWidthFraction;
+            float cutHeight = isRoaming ? mRCutoutHeightFraction : mCutoutHeightFraction;
+            float cutX = (cutWidth * width / VIEWPORT);
+            float cutY = (cutHeight * height / VIEWPORT);
+            mCutoutPath.moveTo(width, height);
+            mCutoutPath.rLineTo(-cutX, 0);
+            mCutoutPath.rLineTo(0, -cutY);
+            mCutoutPath.rLineTo(cutX, 0);
+            mCutoutPath.rLineTo(0, cutY);
+            canvas.drawPath(mCutoutPath, mTransparentPaint);
+            canvas.drawPath(isRoaming ? mScaledRoamingPath : mScaledAttributionPath,
+                    mForegroundPaint);
         }
         if (isRtl) {
             canvas.restore();
@@ -312,10 +363,13 @@ public class SignalDrawable extends DrawableWrapper {
         return (fullState & STATE_MASK) >> STATE_SHIFT;
     }
 
+    public static int getState(int level, int numLevels, boolean cutOut, boolean roaming) {
+        int state = cutOut ? (roaming ? STATE_CUT_AND_R : STATE_CUT) : (roaming ? STATE_R : 0);
+        return (state << STATE_SHIFT) | (numLevels << NUM_LEVEL_SHIFT) | level;
+    }
+
     public static int getState(int level, int numLevels, boolean cutOut) {
-        return ((cutOut ? STATE_CUT : 0) << STATE_SHIFT)
-                | (numLevels << NUM_LEVEL_SHIFT)
-                | level;
+        return getState(level, numLevels, cutOut, false);
     }
 
     @Override
diff --git a/packages/SystemUI/res-keyguard/layout/status_bar_mobile_signal_group_inner.xml b/packages/SystemUI/res-keyguard/layout/status_bar_mobile_signal_group_inner.xml
index 25cadfbb0a79..41672541d0d1 100644
--- a/packages/SystemUI/res-keyguard/layout/status_bar_mobile_signal_group_inner.xml
+++ b/packages/SystemUI/res-keyguard/layout/status_bar_mobile_signal_group_inner.xml
@@ -67,9 +67,9 @@
                 />
         </FrameLayout>
         <Space
-            android:id="@+id/mobile_roaming_space"
+            android:id="@+id/mobile_hd_space"
             android:layout_height="match_parent"
-            android:layout_width="@dimen/roaming_icon_start_padding"
+            android:layout_width="2.5dp"
             android:visibility="gone"
             />
         <FrameLayout
@@ -84,13 +84,14 @@
                 systemui:hasOverlappingRendering="false"
                 />
             <ImageView
-                android:id="@+id/mobile_roaming"
-                android:layout_width="wrap_content"
-                android:layout_height="@dimen/status_bar_mobile_roam_size"
+                android:id="@+id/mobile_hd"
+                android:layout_width="12dp"
+                android:layout_height="8dp"
+                android:layout_marginTop="1dp"
+                android:layout_gravity="start|top"
+                android:src="@drawable/ic_hd_calling"
                 android:adjustViewBounds="true"
-                android:layout_gravity="top|start"
-                android:src="@drawable/stat_sys_roaming"
-                android:contentDescription="@string/data_connection_roaming"
+                android:gravity="start|top"
                 android:visibility="gone" />
         </FrameLayout>
     </com.android.keyguard.AlphaOptimizedLinearLayout>
diff --git a/packages/SystemUI/res/drawable/ic_hd_calling.xml b/packages/SystemUI/res/drawable/ic_hd_calling.xml
new file mode 100644
index 000000000000..0a3bddf6e8ff
--- /dev/null
+++ b/packages/SystemUI/res/drawable/ic_hd_calling.xml
@@ -0,0 +1,13 @@
+<vector
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="12dp"
+    android:height="8dp"
+    android:viewportWidth="12"
+    android:viewportHeight="8">
+    <path
+        android:pathData="M 5.402 7.6 L 4.225 7.6 L 4.225 4.401 L 1.182 4.401 L 1.182 7.6 L 0 7.6 L 0 0.4 L 1.182 0.4 L 1.182 3.396 L 4.225 3.396 L 4.225 0.4 L 5.402 0.4 L 5.402 7.6 Z"
+        android:fillColor="#000000"/>
+    <path
+        android:pathData="M 6.924 7.6 L 6.924 0.4 L 8.934 0.4 C 9.535 0.4 10.068 0.542 10.532 0.825 C 10.999 1.109 11.362 1.511 11.617 2.032 C 11.872 2.553 12 3.149 12 3.822 L 12 4.182 C 12 4.865 11.87 5.465 11.612 5.982 C 11.357 6.501 10.991 6.899 10.513 7.18 C 10.04 7.46 9.497 7.6 8.882 7.6 L 6.924 7.6 Z M 8.107 1.409 L 8.107 6.602 L 8.878 6.602 C 9.498 6.602 9.973 6.396 10.303 5.988 C 10.637 5.576 10.807 4.985 10.813 4.217 L 10.813 3.818 C 10.813 3.035 10.652 2.439 10.332 2.027 C 10.01 1.614 9.545 1.409 8.934 1.409 L 8.107 1.409 Z"
+        android:fillColor="#000000"/>
+</vector>
diff --git a/packages/SystemUI/res/drawable/ic_statusbar_hd_calling.xml b/packages/SystemUI/res/drawable/ic_statusbar_hd_calling.xml
new file mode 100644
index 000000000000..c97a9d45efa7
--- /dev/null
+++ b/packages/SystemUI/res/drawable/ic_statusbar_hd_calling.xml
@@ -0,0 +1,17 @@
+<vector
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="24"
+    android:viewportHeight="24"
+    android:tint="?android:attr/colorControlNormal">
+    <path
+        android:pathData="M 22 2 L 2 22 L 22 22 L 22 2 L 22 2 Z"
+        android:fillColor="#000000"/>
+    <path
+        android:pathData="M 5.402 8.2 L 4.225 8.2 L 4.225 5.001 L 1.182 5.001 L 1.182 8.2 L 0 8.2 L 0 1 L 1.182 1 L 1.182 3.996 L 4.225 3.996 L 4.225 1 L 5.402 1 L 5.402 8.2 Z"
+        android:fillColor="#000000"/>
+    <path
+        android:pathData="M 6.924 8.2 L 6.924 1 L 8.934 1 C 9.535 1 10.068 1.142 10.532 1.425 C 10.999 1.709 11.362 2.111 11.617 2.632 C 11.872 3.153 12 3.749 12 4.422 L 12 4.782 C 12 5.465 11.87 6.065 11.612 6.582 C 11.357 7.101 10.991 7.499 10.513 7.78 C 10.04 8.06 9.497 8.2 8.882 8.2 L 6.924 8.2 Z M 8.107 2.009 L 8.107 7.202 L 8.878 7.202 C 9.498 7.202 9.973 6.996 10.303 6.588 C 10.637 6.176 10.807 5.585 10.813 4.817 L 10.813 4.418 C 10.813 3.635 10.652 3.039 10.332 2.627 C 10.01 2.214 9.545 2.009 8.934 2.009 L 8.107 2.009 Z"
+        android:fillColor="#000000"/>
+</vector>
diff --git a/packages/SystemUI/res/drawable/ic_statusbar_roaming.xml b/packages/SystemUI/res/drawable/ic_statusbar_roaming.xml
index b8d2be6543ab..25e0303d16f7 100644
--- a/packages/SystemUI/res/drawable/ic_statusbar_roaming.xml
+++ b/packages/SystemUI/res/drawable/ic_statusbar_roaming.xml
@@ -13,13 +13,18 @@
      See the License for the specific language governing permissions and
      limitations under the License.
 -->
-<vector xmlns:android="http://schemas.android.com/apk/res/android"
-        android:width="16dp"
-        android:height="16dp"
-        android:viewportWidth="16.0"
-        android:viewportHeight="16.0"
-        android:tint="?android:attr/colorControlNormal">
+<vector
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="24"
+    android:viewportHeight="24"
+    android:tint="?android:attr/colorControlNormal">
     <path
-        android:fillColor="#FFFFFFFF"
-        android:pathData="M4.5,13.02V3h3.93c0.97,0 1.75,0.27 2.34,0.81c0.6,0.53 0.9,1.28 0.9,2.25c0,0.63 -0.19,1.2 -0.56,1.74c-0.37,0.53 -0.95,0.91 -1.74,1.12l2.45,4.02v0.08h-1.69L7.75,9.09H6.03v3.93H4.5zM8.46,4.44H6.03v3.23h2.44c0.49,0 0.9,-0.14 1.2,-0.41c0.31,-0.28 0.46,-0.69 0.46,-1.22s-0.15,-0.93 -0.45,-1.2C9.38,4.58 8.98,4.44 8.46,4.44z"/>
+        android:pathData="M 22 2 L 2 22 L 22 22 L 22 2 L 22 2 Z M 16 15 L 22 15 L 22 22 L 16 22 L 16 15"
+        android:fillColor="#000000"
+        android:fillType="evenOdd"/>
+    <path
+        android:pathData="M 19.436 19.688 L 18.152 19.688 L 18.152 22 L 17 22 L 17 16 L 19.332 16 C 20.097 16 20.687 16.155 21.103 16.466 C 21.519 16.776 21.727 17.225 21.727 17.813 C 21.727 18.214 21.619 18.551 21.403 18.823 C 21.191 19.092 20.893 19.299 20.511 19.445 L 22 21.946 L 22 22 L 20.766 22 L 19.436 19.688 Z M 18.152 18.852 L 19.336 18.852 C 19.725 18.852 20.028 18.764 20.247 18.588 C 20.465 18.409 20.575 18.166 20.575 17.859 C 20.575 17.537 20.473 17.288 20.27 17.113 C 20.069 16.937 19.769 16.846 19.368 16.841 L 18.152 16.841 L 18.152 18.852 Z"
+        android:fillColor="#000000"/>
 </vector>
diff --git a/packages/SystemUI/res/drawable/ic_statusbar_vowifi.xml b/packages/SystemUI/res/drawable/ic_statusbar_vowifi.xml
new file mode 100644
index 000000000000..35191a2d9eb3
--- /dev/null
+++ b/packages/SystemUI/res/drawable/ic_statusbar_vowifi.xml
@@ -0,0 +1,14 @@
+<vector
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="24"
+    android:viewportHeight="24"
+    android:tint="?android:attr/colorControlNormal">
+    <path
+        android:pathData="M 21.996 4.95 C 21.787 4.779 19.666 2.999 16.497 2.999 C 13.318 2.999 11.208 4.779 10.999 4.95 L 16.497 11.998 L 21.996 4.95 Z"
+        android:fillColor="#000000"/>
+    <path
+        android:pathData="M 19.997 15.507 C 18.756 15.507 17.548 15.308 16.427 14.938 C 16.077 14.818 15.678 14.907 15.407 15.178 L 13.208 17.377 C 10.378 15.928 8.059 13.618 6.62 10.788 L 8.819 8.589 C 9.098 8.309 9.178 7.919 9.069 7.569 C 8.699 6.45 8.498 5.25 8.498 3.999 C 8.498 3.45 8.049 2.999 7.499 2.999 L 3.999 2.999 C 3.45 2.999 2.999 3.45 2.999 3.999 C 2.999 13.388 10.608 20.997 19.997 20.997 C 20.547 20.997 20.997 20.547 20.997 19.997 L 20.997 16.508 C 20.997 15.957 20.547 15.507 19.997 15.507 Z"
+        android:fillColor="#000000"/>
+</vector>
diff --git a/packages/SystemUI/res/drawable/ic_vowifi.xml b/packages/SystemUI/res/drawable/ic_vowifi.xml
new file mode 100644
index 000000000000..d91a92c96d7a
--- /dev/null
+++ b/packages/SystemUI/res/drawable/ic_vowifi.xml
@@ -0,0 +1,27 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+/*
+* Copyright 2024, The LibreMobileOS Foundation
+*
+* Licensed under the Apache License, Version 2.0 (the "License");
+* you may not use this file except in compliance with the License.
+* You may obtain a copy of the License at
+*
+*     http://www.apache.org/licenses/LICENSE-2.0
+*
+* Unless required by applicable law or agreed to in writing, software
+* distributed under the License is distributed on an "AS IS" BASIS,
+* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+* See the License for the specific language governing permissions and
+* limitations under the License.
+*/
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="15sp"
+    android:height="15sp"
+    android:viewportWidth="24"
+    android:viewportHeight="24">
+  <path
+      android:pathData="M19.393,21C17.31,21 15.252,20.546 13.218,19.638C11.185,18.729 9.335,17.442 7.668,15.775C6.002,14.108 4.714,12.258 3.806,10.225C2.897,8.192 2.443,6.133 2.443,4.05C2.443,3.75 2.543,3.5 2.743,3.3C2.943,3.1 3.193,3 3.493,3H7.543C7.777,3 7.985,3.079 8.168,3.237C8.352,3.396 8.46,3.583 8.493,3.8L9.143,7.3C9.177,7.567 9.168,7.792 9.118,7.975C9.068,8.158 8.977,8.317 8.843,8.45L6.418,10.9C6.752,11.517 7.147,12.113 7.606,12.688C8.064,13.262 8.568,13.817 9.118,14.35C9.635,14.867 10.177,15.346 10.743,15.788C11.31,16.229 11.91,16.633 12.543,17L14.893,14.65C15.043,14.5 15.239,14.387 15.481,14.313C15.722,14.238 15.96,14.217 16.193,14.25L19.643,14.95C19.876,15.017 20.068,15.137 20.218,15.313C20.368,15.488 20.443,15.683 20.443,15.9V19.95C20.443,20.25 20.343,20.5 20.143,20.7C19.943,20.9 19.693,21 19.393,21ZM15.243,9.8L11.268,5.825C11.035,5.592 10.935,5.317 10.968,5C11.002,4.683 11.16,4.442 11.443,4.275C12.143,3.842 12.877,3.521 13.643,3.313C14.41,3.104 15.177,3 15.943,3C16.693,3 17.443,3.108 18.193,3.325C18.943,3.542 19.677,3.867 20.393,4.3C20.677,4.483 20.839,4.729 20.881,5.037C20.922,5.346 20.826,5.617 20.593,5.85L16.643,9.8C16.443,10 16.21,10.1 15.943,10.1C15.677,10.1 15.443,10 15.243,9.8Z"
+      android:fillColor="@android:color/white"/>
+</vector>
diff --git a/packages/SystemUI/res/drawable/ic_vowifi_dual.xml b/packages/SystemUI/res/drawable/ic_vowifi_dual.xml
new file mode 100644
index 000000000000..128daef00331
--- /dev/null
+++ b/packages/SystemUI/res/drawable/ic_vowifi_dual.xml
@@ -0,0 +1,35 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+/*
+* Copyright 2024, The LibreMobileOS Foundation
+*
+* Licensed under the Apache License, Version 2.0 (the "License");
+* you may not use this file except in compliance with the License.
+* You may obtain a copy of the License at
+*
+*     http://www.apache.org/licenses/LICENSE-2.0
+*
+* Unless required by applicable law or agreed to in writing, software
+* distributed under the License is distributed on an "AS IS" BASIS,
+* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+* See the License for the specific language governing permissions and
+* limitations under the License.
+*/
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="20sp"
+    android:height="15sp"
+    android:viewportWidth="32"
+    android:viewportHeight="24">
+  <path
+      android:pathData="M19.393,21C17.31,21 15.252,20.546 13.218,19.638C11.185,18.729 9.335,17.442 7.668,15.775C6.002,14.108 4.714,12.258 3.806,10.225C2.897,8.192 2.443,6.133 2.443,4.05C2.443,3.75 2.543,3.5 2.743,3.3C2.943,3.1 3.193,3 3.493,3H7.543C7.777,3 7.985,3.079 8.168,3.237C8.352,3.396 8.46,3.583 8.493,3.8L9.143,7.3C9.177,7.567 9.168,7.792 9.118,7.975C9.068,8.158 8.977,8.317 8.843,8.45L6.418,10.9C6.752,11.517 7.147,12.113 7.606,12.688C8.064,13.262 8.568,13.817 9.118,14.35C9.635,14.867 10.177,15.346 10.743,15.788C11.31,16.229 11.91,16.633 12.543,17L14.893,14.65C15.043,14.5 15.239,14.387 15.481,14.313C15.722,14.238 15.96,14.217 16.193,14.25L19.643,14.95C19.876,15.017 20.068,15.137 20.218,15.313C20.368,15.488 20.443,15.683 20.443,15.9V19.95C20.443,20.25 20.343,20.5 20.143,20.7C19.943,20.9 19.693,21 19.393,21ZM15.243,9.8L11.268,5.825C11.035,5.592 10.935,5.317 10.968,5C11.002,4.683 11.16,4.442 11.443,4.275C12.143,3.842 12.877,3.521 13.643,3.313C14.41,3.104 15.177,3 15.943,3C16.693,3 17.443,3.108 18.193,3.325C18.943,3.542 19.677,3.867 20.393,4.3C20.677,4.483 20.839,4.729 20.881,5.037C20.922,5.346 20.826,5.617 20.593,5.85L16.643,9.8C16.443,10 16.21,10.1 15.943,10.1C15.677,10.1 15.443,10 15.243,9.8Z"
+      android:fillColor="@android:color/white"/>
+  <path
+      android:pathData="M23.135,10.765C23.298,10.922 23.494,11 23.723,11H28.723C28.953,11 29.149,10.922 29.312,10.765C29.475,10.608 29.557,10.42 29.557,10.2V3.8C29.557,3.58 29.475,3.392 29.312,3.235C29.149,3.078 28.953,3 28.723,3H25.734C25.623,3 25.517,3.02 25.416,3.06C25.316,3.1 25.227,3.157 25.151,3.23L23.13,5.17C23.053,5.243 22.994,5.328 22.953,5.425C22.911,5.522 22.89,5.623 22.89,5.73V10.2C22.89,10.42 22.972,10.608 23.135,10.765ZM25.364,4.4V5.32H26.056V9.6H27.083V4.4H25.364Z"
+      android:fillColor="@android:color/white"
+      android:fillType="evenOdd"/>
+  <path
+      android:pathData="M23.135,20.765C23.298,20.922 23.494,21 23.723,21H28.723C28.953,21 29.149,20.922 29.312,20.765C29.475,20.608 29.557,20.42 29.557,20.2V13.8C29.557,13.58 29.475,13.392 29.312,13.235C29.149,13.078 28.953,13 28.723,13H25.734C25.623,13 25.517,13.02 25.416,13.06C25.316,13.1 25.227,13.157 25.151,13.23L23.13,15.17C23.053,15.243 22.994,15.328 22.953,15.425C22.911,15.522 22.89,15.623 22.89,15.73V20.2C22.89,20.42 22.972,20.608 23.135,20.765ZM25.93,17.612C25.661,17.862 25.3,18.176 24.847,18.553L24.479,18.864V19.6H27.975V18.779H25.887C26.298,18.43 26.63,18.133 26.885,17.888C27.14,17.638 27.366,17.346 27.564,17.011C27.762,16.676 27.861,16.324 27.861,15.957C27.861,15.49 27.718,15.115 27.43,14.832C27.142,14.544 26.729,14.4 26.192,14.4C25.701,14.4 25.295,14.546 24.975,14.839C24.659,15.131 24.491,15.56 24.472,16.126H25.435C25.439,15.853 25.505,15.638 25.633,15.482C25.76,15.322 25.942,15.242 26.177,15.242C26.413,15.242 26.588,15.31 26.701,15.447C26.814,15.584 26.871,15.773 26.871,16.013C26.871,16.277 26.781,16.546 26.602,16.82C26.423,17.093 26.199,17.357 25.93,17.612Z"
+      android:fillColor="@android:color/white"
+      android:fillType="evenOdd"/>
+</vector>
diff --git a/packages/SystemUI/res/drawable/ic_vowifi_one.xml b/packages/SystemUI/res/drawable/ic_vowifi_one.xml
new file mode 100644
index 000000000000..baa13ba42e2b
--- /dev/null
+++ b/packages/SystemUI/res/drawable/ic_vowifi_one.xml
@@ -0,0 +1,31 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+/*
+* Copyright 2024, The LibreMobileOS Foundation
+*
+* Licensed under the Apache License, Version 2.0 (the "License");
+* you may not use this file except in compliance with the License.
+* You may obtain a copy of the License at
+*
+*     http://www.apache.org/licenses/LICENSE-2.0
+*
+* Unless required by applicable law or agreed to in writing, software
+* distributed under the License is distributed on an "AS IS" BASIS,
+* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+* See the License for the specific language governing permissions and
+* limitations under the License.
+*/
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="20sp"
+    android:height="15sp"
+    android:viewportWidth="32"
+    android:viewportHeight="24">
+  <path
+      android:pathData="M19.393,21C17.31,21 15.252,20.546 13.218,19.638C11.185,18.729 9.335,17.442 7.668,15.775C6.002,14.108 4.714,12.258 3.806,10.225C2.897,8.192 2.443,6.133 2.443,4.05C2.443,3.75 2.543,3.5 2.743,3.3C2.943,3.1 3.193,3 3.493,3H7.543C7.777,3 7.985,3.079 8.168,3.237C8.352,3.396 8.46,3.583 8.493,3.8L9.143,7.3C9.177,7.567 9.168,7.792 9.118,7.975C9.068,8.158 8.977,8.317 8.843,8.45L6.418,10.9C6.752,11.517 7.147,12.113 7.606,12.688C8.064,13.262 8.568,13.817 9.118,14.35C9.635,14.867 10.177,15.346 10.743,15.788C11.31,16.229 11.91,16.633 12.543,17L14.893,14.65C15.043,14.5 15.239,14.387 15.481,14.313C15.722,14.238 15.96,14.217 16.193,14.25L19.643,14.95C19.876,15.017 20.068,15.137 20.218,15.313C20.368,15.488 20.443,15.683 20.443,15.9V19.95C20.443,20.25 20.343,20.5 20.143,20.7C19.943,20.9 19.693,21 19.393,21ZM15.243,9.8L11.268,5.825C11.035,5.592 10.935,5.317 10.968,5C11.002,4.683 11.16,4.442 11.443,4.275C12.143,3.842 12.877,3.521 13.643,3.313C14.41,3.104 15.177,3 15.943,3C16.693,3 17.443,3.108 18.193,3.325C18.943,3.542 19.677,3.867 20.393,4.3C20.677,4.483 20.839,4.729 20.881,5.037C20.922,5.346 20.826,5.617 20.593,5.85L16.643,9.8C16.443,10 16.21,10.1 15.943,10.1C15.677,10.1 15.443,10 15.243,9.8Z"
+      android:fillColor="@android:color/white"/>
+  <path
+      android:pathData="M23.135,20.765C23.298,20.922 23.494,21 23.723,21H28.723C28.953,21 29.149,20.922 29.312,20.765C29.475,20.608 29.557,20.42 29.557,20.2V13.8C29.557,13.58 29.475,13.392 29.312,13.235C29.149,13.078 28.953,13 28.723,13H25.734C25.623,13 25.517,13.02 25.416,13.06C25.316,13.1 25.227,13.157 25.151,13.23L23.13,15.17C23.053,15.243 22.994,15.328 22.953,15.425C22.911,15.522 22.89,15.623 22.89,15.73V20.2C22.89,20.42 22.972,20.608 23.135,20.765ZM25.364,14.4V15.32H26.056V19.6H27.083V14.4H25.364Z"
+      android:fillColor="@android:color/white"
+      android:fillType="evenOdd"/>
+</vector>
diff --git a/packages/SystemUI/res/drawable/ic_vowifi_two.xml b/packages/SystemUI/res/drawable/ic_vowifi_two.xml
new file mode 100644
index 000000000000..5c8316433816
--- /dev/null
+++ b/packages/SystemUI/res/drawable/ic_vowifi_two.xml
@@ -0,0 +1,31 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+/*
+* Copyright 2024, The LibreMobileOS Foundation
+*
+* Licensed under the Apache License, Version 2.0 (the "License");
+* you may not use this file except in compliance with the License.
+* You may obtain a copy of the License at
+*
+*     http://www.apache.org/licenses/LICENSE-2.0
+*
+* Unless required by applicable law or agreed to in writing, software
+* distributed under the License is distributed on an "AS IS" BASIS,
+* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+* See the License for the specific language governing permissions and
+* limitations under the License.
+*/
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="20sp"
+    android:height="15sp"
+    android:viewportWidth="32"
+    android:viewportHeight="24">
+  <path
+      android:pathData="M19.393,21C17.31,21 15.252,20.546 13.218,19.638C11.185,18.729 9.335,17.442 7.668,15.775C6.002,14.108 4.714,12.258 3.806,10.225C2.897,8.192 2.443,6.133 2.443,4.05C2.443,3.75 2.543,3.5 2.743,3.3C2.943,3.1 3.193,3 3.493,3H7.543C7.777,3 7.985,3.079 8.168,3.237C8.352,3.396 8.46,3.583 8.493,3.8L9.143,7.3C9.177,7.567 9.168,7.792 9.118,7.975C9.068,8.158 8.977,8.317 8.843,8.45L6.418,10.9C6.752,11.517 7.147,12.113 7.606,12.688C8.064,13.262 8.568,13.817 9.118,14.35C9.635,14.867 10.177,15.346 10.743,15.788C11.31,16.229 11.91,16.633 12.543,17L14.893,14.65C15.043,14.5 15.239,14.387 15.481,14.313C15.722,14.238 15.96,14.217 16.193,14.25L19.643,14.95C19.876,15.017 20.068,15.137 20.218,15.313C20.368,15.488 20.443,15.683 20.443,15.9V19.95C20.443,20.25 20.343,20.5 20.143,20.7C19.943,20.9 19.693,21 19.393,21ZM15.243,9.8L11.268,5.825C11.035,5.592 10.935,5.317 10.968,5C11.002,4.683 11.16,4.442 11.443,4.275C12.143,3.842 12.877,3.521 13.643,3.313C14.41,3.104 15.177,3 15.943,3C16.693,3 17.443,3.108 18.193,3.325C18.943,3.542 19.677,3.867 20.393,4.3C20.677,4.483 20.839,4.729 20.881,5.037C20.922,5.346 20.826,5.617 20.593,5.85L16.643,9.8C16.443,10 16.21,10.1 15.943,10.1C15.677,10.1 15.443,10 15.243,9.8Z"
+      android:fillColor="@android:color/white"/>
+  <path
+      android:pathData="M23.135,20.765C23.298,20.922 23.494,21 23.723,21H28.723C28.953,21 29.149,20.922 29.312,20.765C29.475,20.608 29.557,20.42 29.557,20.2V13.8C29.557,13.58 29.475,13.392 29.312,13.235C29.149,13.078 28.953,13 28.723,13H25.734C25.623,13 25.517,13.02 25.416,13.06C25.316,13.1 25.227,13.157 25.151,13.23L23.13,15.17C23.053,15.243 22.994,15.328 22.953,15.425C22.911,15.522 22.89,15.623 22.89,15.73V20.2C22.89,20.42 22.972,20.608 23.135,20.765ZM25.93,17.612C25.661,17.862 25.3,18.176 24.847,18.553L24.479,18.864V19.6H27.975V18.779H25.887C26.298,18.43 26.63,18.133 26.885,17.888C27.14,17.638 27.366,17.346 27.564,17.011C27.762,16.676 27.861,16.324 27.861,15.957C27.861,15.49 27.718,15.115 27.43,14.832C27.142,14.544 26.729,14.4 26.192,14.4C25.701,14.4 25.295,14.546 24.975,14.839C24.659,15.131 24.491,15.56 24.472,16.126H25.435C25.439,15.853 25.505,15.638 25.633,15.482C25.76,15.322 25.942,15.242 26.177,15.242C26.413,15.242 26.588,15.31 26.701,15.447C26.814,15.584 26.871,15.773 26.871,16.013C26.871,16.277 26.781,16.546 26.602,16.82C26.423,17.093 26.199,17.357 25.93,17.612Z"
+      android:fillColor="@android:color/white"
+      android:fillType="evenOdd"/>
+</vector>
diff --git a/packages/SystemUI/res/layout/status_bar_wifi_group_inner.xml b/packages/SystemUI/res/layout/status_bar_wifi_group_inner.xml
index e8b8922a138d..1987eb53eec1 100644
--- a/packages/SystemUI/res/layout/status_bar_wifi_group_inner.xml
+++ b/packages/SystemUI/res/layout/status_bar_wifi_group_inner.xml
@@ -26,6 +26,15 @@
         android:gravity="center_vertical"
         android:layout_marginStart="2.5sp"
     >
+
+        <ImageView
+            android:id="@+id/vowifi"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:layout_marginEnd="3dp"
+            android:scaleType="fitXY"
+            android:visibility="gone" />
+
         <FrameLayout
                 android:id="@+id/inout_container"
                 android:layout_height="@dimen/status_bar_wifi_inout_container_size"
diff --git a/packages/SystemUI/res/values/cm_strings.xml b/packages/SystemUI/res/values/cm_strings.xml
index eb93d2ba288e..c41b4cbc79f4 100644
--- a/packages/SystemUI/res/values/cm_strings.xml
+++ b/packages/SystemUI/res/values/cm_strings.xml
@@ -18,6 +18,13 @@
  */
 -->
 <resources xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+
+    <!-- Name of the HD calling status bar icon. -->
+    <string name="status_bar_hd_calling">HD calling (VoLTE/VoNR)</string>
+
+    <!-- Name of the VoWiFi status bar icon. -->
+    <string name="status_bar_vowifi">Wi-Fi calling (VoWiFi)</string>
+
     <!-- Name of the clock in status bar [CHAR LIMIT=30] -->
     <string name="clock">Clock</string>
 
diff --git a/packages/SystemUI/res/values/lineage_dimens.xml b/packages/SystemUI/res/values/lineage_dimens.xml
index 4a24b9d35714..5f9a842ec96b 100644
--- a/packages/SystemUI/res/values/lineage_dimens.xml
+++ b/packages/SystemUI/res/values/lineage_dimens.xml
@@ -16,6 +16,9 @@
      limitations under the License.
 -->
 <resources>
+    <!-- HD calling icon -->
+    <dimen name="signal_icon_viewport_size">24dp</dimen>
+
     <!-- Largest size an avatar might need to be drawn in the power menu user picker -->
     <dimen name="global_actions_avatar_size">24dp</dimen>
 </resources>
diff --git a/packages/SystemUI/res/xml/status_bar_prefs.xml b/packages/SystemUI/res/xml/status_bar_prefs.xml
index c3e33b8e6db7..038ecf8cb964 100644
--- a/packages/SystemUI/res/xml/status_bar_prefs.xml
+++ b/packages/SystemUI/res/xml/status_bar_prefs.xml
@@ -112,6 +112,18 @@
         android:key="roaming"
         android:title="@string/status_bar_roaming" />
 
+    <com.android.systemui.tuner.TunerSwitch
+        android:icon="@drawable/ic_statusbar_hd_calling"
+        android:key="status_bar_show_hd_calling"
+        android:title="@string/status_bar_hd_calling"
+        sysui:defValue="false" />
+
+    <com.android.systemui.tuner.TunerSwitch
+        android:icon="@drawable/ic_statusbar_vowifi"
+        android:key="status_bar_show_vowifi"
+        android:title="@string/status_bar_vowifi"
+        sysui:defValue="false" />
+
     <!-- other weird signal stuff -->
 
     <com.android.systemui.tuner.StatusBarSwitch
diff --git a/packages/SystemUI/src/com/android/systemui/dagger/FrameworkServicesModule.java b/packages/SystemUI/src/com/android/systemui/dagger/FrameworkServicesModule.java
index f45bafdfb17e..d2dfa77aefd5 100644
--- a/packages/SystemUI/src/com/android/systemui/dagger/FrameworkServicesModule.java
+++ b/packages/SystemUI/src/com/android/systemui/dagger/FrameworkServicesModule.java
@@ -99,6 +99,7 @@ import android.telecom.TelecomManager;
 import android.telephony.CarrierConfigManager;
 import android.telephony.SubscriptionManager;
 import android.telephony.TelephonyManager;
+import android.telephony.ims.ImsManager;
 import android.telephony.satellite.SatelliteManager;
 import android.view.CrossWindowBlurListeners;
 import android.view.IWindowManager;
@@ -817,4 +818,10 @@ public class FrameworkServicesModule {
     static SupervisionManager provideSupervisionManager(Context context) {
         return (SupervisionManager) context.getSystemService(Context.SUPERVISION_SERVICE);
     }
+
+    @Provides
+    @Singleton
+    static ImsManager provideImsManager(Context context) {
+        return context.getSystemService(ImsManager.class);
+    }
 }
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/dagger/StatusBarPipelineModule.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/dagger/StatusBarPipelineModule.kt
index 93489e90fb85..a672b1067303 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/dagger/StatusBarPipelineModule.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/dagger/StatusBarPipelineModule.kt
@@ -33,6 +33,8 @@ import com.android.systemui.statusbar.pipeline.airplane.ui.viewmodel.AirplaneMod
 import com.android.systemui.statusbar.pipeline.airplane.ui.viewmodel.AirplaneModeViewModelImpl
 import com.android.systemui.statusbar.pipeline.icons.shared.BindableIconsRegistry
 import com.android.systemui.statusbar.pipeline.icons.shared.BindableIconsRegistryImpl
+import com.android.systemui.statusbar.pipeline.ims.data.repository.CommonImsRepository
+import com.android.systemui.statusbar.pipeline.ims.data.repository.CommonImsRepositoryImpl
 import com.android.systemui.statusbar.pipeline.mobile.data.repository.CarrierConfigCoreStartable
 import com.android.systemui.statusbar.pipeline.mobile.data.repository.CarrierConfigRepository
 import com.android.systemui.statusbar.pipeline.mobile.data.repository.CarrierConfigRepositoryImpl
@@ -171,6 +173,9 @@ abstract class StatusBarPipelineModule {
     @Binds
     abstract fun homeStatusBarViewBinder(impl: HomeStatusBarViewBinderImpl): HomeStatusBarViewBinder
 
+    @Binds
+    abstract fun bindCommonImsRepository(impl: CommonImsRepositoryImpl): CommonImsRepository
+
     companion object {
 
         @Provides
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/ims/data/model/ImsIconModel.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/ims/data/model/ImsIconModel.kt
new file mode 100644
index 000000000000..2caa96939d65
--- /dev/null
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/ims/data/model/ImsIconModel.kt
@@ -0,0 +1,21 @@
+/*
+ * Copyright (C) 2024 Paranoid Android
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.systemui.statusbar.pipeline.ims.data.model
+
+data class ImsIconModel(
+    val showHdIcon: Boolean = false,
+    val showVowifiIcon: Boolean = false
+)
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/ims/data/model/ImsStateModel.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/ims/data/model/ImsStateModel.kt
new file mode 100644
index 000000000000..c90021f0b574
--- /dev/null
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/ims/data/model/ImsStateModel.kt
@@ -0,0 +1,38 @@
+/*
+ * Copyright (C) 2024 The LibreMobileOS Foundation
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.systemui.statusbar.pipeline.ims.data.model
+
+import android.telephony.ims.feature.MmTelFeature
+import android.telephony.ims.stub.ImsRegistrationImplBase.REGISTRATION_TECH_IWLAN
+import android.telephony.ims.stub.ImsRegistrationImplBase.REGISTRATION_TECH_NONE
+
+data class ImsStateModel(
+    val subId: Int = -1,
+    val slotIndex: Int = -1,
+    val activeSubCount: Int = 0,
+    val registered: Boolean = false,
+    val capabilities: MmTelFeature.MmTelCapabilities? = null,
+    val registrationTech: Int = REGISTRATION_TECH_NONE
+) {
+
+    fun isHdVoiceCapable(): Boolean =
+        registered && capabilities
+            ?.isCapable(MmTelFeature.MmTelCapabilities.CAPABILITY_TYPE_VOICE) ?: false
+
+    fun isVoWifiAvailable(): Boolean =
+        isHdVoiceCapable() && registrationTech == REGISTRATION_TECH_IWLAN
+
+}
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/ims/data/repository/CommonImsRepository.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/ims/data/repository/CommonImsRepository.kt
new file mode 100644
index 000000000000..3c3e2a8b0570
--- /dev/null
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/ims/data/repository/CommonImsRepository.kt
@@ -0,0 +1,182 @@
+/*
+ * Copyright (C) 2022 The Android Open Source Project
+ * Copyright (C) 2024 The LibreMobileOS Foundation
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.systemui.statusbar.pipeline.ims.data.repository
+
+import android.telephony.SubscriptionInfo
+import android.telephony.SubscriptionManager
+import com.android.systemui.common.coroutine.ConflatedCallbackFlow.conflatedCallbackFlow
+import com.android.systemui.dagger.SysUISingleton
+import com.android.systemui.dagger.qualifiers.Application
+import com.android.systemui.dagger.qualifiers.Background
+import com.android.systemui.statusbar.pipeline.ims.data.model.ImsIconModel
+import com.android.systemui.statusbar.pipeline.ims.data.model.ImsStateModel
+import com.android.systemui.tuner.TunerService
+import kotlinx.coroutines.CoroutineDispatcher
+import kotlinx.coroutines.CoroutineScope
+import kotlinx.coroutines.ExperimentalCoroutinesApi
+import kotlinx.coroutines.asExecutor
+import kotlinx.coroutines.channels.awaitClose
+import kotlinx.coroutines.flow.Flow
+import kotlinx.coroutines.flow.SharingStarted
+import kotlinx.coroutines.flow.StateFlow
+import kotlinx.coroutines.flow.combine
+import kotlinx.coroutines.flow.distinctUntilChanged
+import kotlinx.coroutines.flow.flatMapLatest
+import kotlinx.coroutines.flow.map
+import kotlinx.coroutines.flow.mapLatest
+import kotlinx.coroutines.flow.onEach
+import kotlinx.coroutines.flow.stateIn
+import kotlinx.coroutines.withContext
+import javax.inject.Inject
+
+interface CommonImsRepository {
+    val imsStates: StateFlow<List<ImsStateModel>>
+    val imsIconState: StateFlow<ImsIconModel>
+    fun getRepoForSubId(subId: Int): ImsRepository
+}
+
+@OptIn(ExperimentalCoroutinesApi::class)
+@SysUISingleton
+class CommonImsRepositoryImpl
+@Inject
+constructor(
+    private val subscriptionManager: SubscriptionManager,
+    @Background private val bgDispatcher: CoroutineDispatcher,
+    @Application private val scope: CoroutineScope,
+    private val imsRepoFactory: ImsRepositoryImpl.Factory,
+    tunerService: TunerService,
+) : CommonImsRepository {
+
+    private var subIdRepositoryCache: MutableMap<Int, ImsRepository> =
+        mutableMapOf()
+
+    private val mobileSubscriptionsChangeEvent: Flow<Unit> = conflatedCallbackFlow {
+        val callback = object : SubscriptionManager.OnSubscriptionsChangedListener() {
+            override fun onSubscriptionsChanged() {
+                trySend(Unit)
+            }
+        }
+
+        subscriptionManager.addOnSubscriptionsChangedListener(
+            bgDispatcher.asExecutor(),
+            callback,
+        )
+
+        awaitClose { subscriptionManager.removeOnSubscriptionsChangedListener(callback) }
+    }
+
+    private val subscriptions: StateFlow<List<Int>> =
+        mobileSubscriptionsChangeEvent
+            .mapLatest { fetchSubscriptionsList().map { it.subscriptionId } }
+            .onEach { ids -> dropUnusedReposFromCache(ids) }
+            .distinctUntilChanged()
+            .stateIn(scope, started = SharingStarted.WhileSubscribed(), listOf())
+
+    private fun dropUnusedReposFromCache(newIds: List<Int>) {
+        // Remove any connection repository from the cache that isn't in the new set of IDs. They
+        // will get garbage collected once their subscribers go away
+        subIdRepositoryCache =
+            subIdRepositoryCache.filter { checkSub(it.key, newIds) }.toMutableMap()
+    }
+
+    /**
+     * True if the checked subId is in the list of current subs
+     *
+     * @param checkedSubIds the list to validate [subId] against. To invalidate the cache, pass in the
+     *   new subscription list. Otherwise use [subscriptions.value] to validate a subId against the
+     *   current known subscriptions
+     */
+    private fun checkSub(subId: Int, checkedSubIds: List<Int>): Boolean {
+        checkedSubIds.forEach {
+            if (it == subId) {
+                return true
+            }
+        }
+        return false
+    }
+
+    private suspend fun fetchSubscriptionsList(): List<SubscriptionInfo> =
+        withContext(bgDispatcher) { subscriptionManager.completeActiveSubscriptionInfoList }
+
+    override val imsStates: StateFlow<List<ImsStateModel>> =
+        subscriptions
+            .map { subIds ->
+                subIds.map { getRepoForSubId(it) }
+            }
+            .flatMapLatest { repos ->
+                combine(repos.map { it.imsState }) { values ->
+                    values.toList()
+                }
+            }
+            .stateIn(scope, started = SharingStarted.WhileSubscribed(), listOf())
+
+    override val imsIconState: StateFlow<ImsIconModel> = conflatedCallbackFlow {
+        var showHdIcon = false
+        var showVowifiIcon = false
+        val callback =
+            object : TunerService.Tunable {
+                override fun onTuningChanged(key: String, newValue: String?) {
+                    when (key) {
+                        KEY_HD_ICON -> {
+                            showHdIcon =
+                                TunerService.parseIntegerSwitch(newValue, false)
+                        }
+
+                        KEY_VOWIFI_ICON -> {
+                            showVowifiIcon =
+                                TunerService.parseIntegerSwitch(newValue, false)
+                        }
+
+                        else -> return
+                    }
+                    trySend(
+                        ImsIconModel(
+                            showHdIcon = showHdIcon,
+                            showVowifiIcon = showVowifiIcon
+                        )
+                    )
+                }
+            }
+
+        tunerService.run {
+            addTunable(callback, KEY_HD_ICON)
+            addTunable(callback, KEY_VOWIFI_ICON)
+        }
+
+        awaitClose { tunerService.removeTunable(callback) }
+    }.stateIn(
+        scope,
+        started = SharingStarted.WhileSubscribed(),
+        initialValue = ImsIconModel()
+    )
+
+    override fun getRepoForSubId(subId: Int): ImsRepository =
+        getOrCreateRepoForSubId(subId)
+
+    private fun getOrCreateRepoForSubId(subId: Int) =
+        subIdRepositoryCache[subId]
+            ?: createRepositoryForSubId(subId).also { subIdRepositoryCache[subId] = it }
+
+    private fun createRepositoryForSubId(subId: Int): ImsRepository {
+        return imsRepoFactory.build(subId)
+    }
+
+    private companion object {
+        const val KEY_HD_ICON = "status_bar_show_hd_calling"
+        const val KEY_VOWIFI_ICON = "status_bar_show_vowifi"
+    }
+}
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/ims/data/repository/ImsRepository.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/ims/data/repository/ImsRepository.kt
new file mode 100644
index 000000000000..11802c7f044b
--- /dev/null
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/ims/data/repository/ImsRepository.kt
@@ -0,0 +1,184 @@
+/*
+ * Copyright (C) 2024 The LibreMobileOS Foundation
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.systemui.statusbar.pipeline.ims.data.repository
+
+import android.telephony.SubscriptionManager
+import android.telephony.ims.ImsException
+import android.telephony.ims.ImsManager
+import android.telephony.ims.ImsMmTelManager
+import android.telephony.ims.ImsReasonInfo
+import android.telephony.ims.ImsRegistrationAttributes
+import android.telephony.ims.ImsStateCallback
+import android.telephony.ims.RegistrationManager.RegistrationCallback
+import android.telephony.ims.feature.MmTelFeature
+import android.telephony.ims.stub.ImsRegistrationImplBase.REGISTRATION_TECH_NONE
+import com.android.systemui.dagger.qualifiers.Application
+import com.android.systemui.dagger.qualifiers.Background
+import com.android.systemui.statusbar.pipeline.ims.data.model.ImsStateModel
+import kotlinx.coroutines.CoroutineDispatcher
+import kotlinx.coroutines.CoroutineScope
+import kotlinx.coroutines.ExperimentalCoroutinesApi
+import kotlinx.coroutines.asExecutor
+import kotlinx.coroutines.channels.awaitClose
+import kotlinx.coroutines.delay
+import kotlinx.coroutines.flow.SharingStarted
+import kotlinx.coroutines.flow.StateFlow
+import kotlinx.coroutines.flow.callbackFlow
+import kotlinx.coroutines.flow.catch
+import kotlinx.coroutines.flow.map
+import kotlinx.coroutines.flow.retryWhen
+import kotlinx.coroutines.flow.scan
+import kotlinx.coroutines.flow.stateIn
+import javax.inject.Inject
+
+interface ImsRepository {
+    val subId: Int
+    val imsState: StateFlow<ImsStateModel>
+}
+
+@OptIn(ExperimentalCoroutinesApi::class)
+class ImsRepositoryImpl(
+    override val subId: Int,
+    imsManager: ImsManager,
+    subscriptionManager: SubscriptionManager,
+    bgDispatcher: CoroutineDispatcher,
+    scope: CoroutineScope,
+) : ImsRepository {
+
+    private val imsCallback: StateFlow<ImsCallbackState> = run {
+        val initial = ImsCallbackState()
+        val imsMmTelManager = imsManager.getImsMmTelManager(subId)
+        callbackFlow {
+            val registrationCallback = object : RegistrationCallback() {
+                override fun onRegistered(attributes: ImsRegistrationAttributes) {
+                    trySend(CallbackEvent.OnImsRegistrationChanged(true, attributes))
+                }
+
+                override fun onUnregistered(info: ImsReasonInfo) {
+                    trySend(CallbackEvent.OnImsRegistrationChanged(false, null))
+                }
+            }
+            val capabilityCallback = object : ImsMmTelManager.CapabilityCallback() {
+                override fun onCapabilitiesStatusChanged(
+                    capabilities: MmTelFeature.MmTelCapabilities
+                ) {
+                    trySend(CallbackEvent.OnImsCapabilitiesStatusChanged(capabilities))
+                }
+            }
+            val stateCallback = object : ImsStateCallback() {
+                override fun onAvailable() {
+                    imsMmTelManager.registerImsRegistrationCallback(
+                        bgDispatcher.asExecutor(), registrationCallback
+                    )
+                    imsMmTelManager.registerMmTelCapabilityCallback(
+                        bgDispatcher.asExecutor(), capabilityCallback
+                    )
+                }
+
+                override fun onUnavailable(reason: Int) {
+                    imsMmTelManager.unregisterImsRegistrationCallback(registrationCallback)
+                    imsMmTelManager.unregisterMmTelCapabilityCallback(capabilityCallback)
+                }
+
+                override fun onError() {
+                    imsMmTelManager.unregisterImsRegistrationCallback(registrationCallback)
+                    imsMmTelManager.unregisterMmTelCapabilityCallback(capabilityCallback)
+                }
+            }
+            imsMmTelManager.registerImsStateCallback(
+                bgDispatcher.asExecutor(), stateCallback
+            )
+            awaitClose {
+                imsMmTelManager.unregisterImsStateCallback(stateCallback)
+                imsMmTelManager.unregisterImsRegistrationCallback(registrationCallback)
+                imsMmTelManager.unregisterMmTelCapabilityCallback(capabilityCallback)
+            }
+        }
+            .retryWhen { cause, _ ->
+                // Retry the flow with 1 second delay
+                // only if service not available.
+                // This state is temporary and service may be available after sometime.
+                delay(1000)
+                cause is ImsException && cause.code == ImsException.CODE_ERROR_SERVICE_UNAVAILABLE
+            }
+            .catch { /* Nothing */ }
+            .scan(initial = initial) { state, event -> state.applyEvent(event) }
+            .stateIn(scope = scope, started = SharingStarted.WhileSubscribed(), initial)
+    }
+
+    override val imsState: StateFlow<ImsStateModel> =
+        imsCallback
+            .map { callbackState ->
+                val registrationChanged = callbackState.onImsRegistrationChanged
+                val capabilitiesChanged = callbackState.onImsCapabilitiesStatusChanged
+                val registered = registrationChanged?.registered ?: false
+                val capabilities = capabilitiesChanged?.capabilities
+                val registrationTech = registrationChanged?.attributes?.registrationTechnology
+                    ?: REGISTRATION_TECH_NONE
+                ImsStateModel(
+                    subId = subId,
+                    slotIndex = SubscriptionManager.getSlotIndex(subId),
+                    activeSubCount = subscriptionManager.activeSubscriptionInfoCount,
+                    registered = registered,
+                    capabilities = capabilities,
+                    registrationTech = registrationTech
+                )
+            }
+            .catch { emit(ImsStateModel()) /* on exception, just return default value */ }
+            .stateIn(scope, SharingStarted.WhileSubscribed(), ImsStateModel())
+
+    class Factory
+    @Inject
+    constructor(
+        private val imsManager: ImsManager,
+        private val subscriptionManager: SubscriptionManager,
+        @Background private val bgDispatcher: CoroutineDispatcher,
+        @Application private val scope: CoroutineScope,
+    ) {
+        fun build(subId: Int): ImsRepository {
+            return ImsRepositoryImpl(
+                subId = subId,
+                imsManager = imsManager,
+                subscriptionManager = subscriptionManager,
+                bgDispatcher = bgDispatcher,
+                scope = scope,
+            )
+        }
+    }
+}
+
+sealed interface CallbackEvent {
+    data class OnImsRegistrationChanged(
+        val registered: Boolean,
+        val attributes: ImsRegistrationAttributes?
+    ) : CallbackEvent
+
+    data class OnImsCapabilitiesStatusChanged(
+        val capabilities: MmTelFeature.MmTelCapabilities
+    ) : CallbackEvent
+}
+
+data class ImsCallbackState(
+    val onImsRegistrationChanged: CallbackEvent.OnImsRegistrationChanged? = null,
+    val onImsCapabilitiesStatusChanged: CallbackEvent.OnImsCapabilitiesStatusChanged? = null
+) {
+    fun applyEvent(event: CallbackEvent): ImsCallbackState {
+        return when (event) {
+            is CallbackEvent.OnImsRegistrationChanged -> copy(onImsRegistrationChanged = event)
+            is CallbackEvent.OnImsCapabilitiesStatusChanged -> copy(onImsCapabilitiesStatusChanged = event)
+        }
+    }
+}
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/MobileConnectionRepository.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/MobileConnectionRepository.kt
index 07843f1ef041..025e6d8b817f 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/MobileConnectionRepository.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/MobileConnectionRepository.kt
@@ -20,6 +20,7 @@ import android.telephony.CellSignalStrength
 import android.telephony.SubscriptionInfo
 import android.telephony.TelephonyManager
 import com.android.systemui.log.table.TableLogBuffer
+import com.android.systemui.statusbar.pipeline.ims.data.model.ImsStateModel
 import com.android.systemui.statusbar.pipeline.mobile.data.model.DataConnectionState
 import com.android.systemui.statusbar.pipeline.mobile.data.model.NetworkNameModel
 import com.android.systemui.statusbar.pipeline.mobile.data.model.ResolvedNetworkType
@@ -158,6 +159,11 @@ interface MobileConnectionRepository {
      */
     val isAllowedDuringAirplaneMode: StateFlow<Boolean>
 
+    /**
+     * The current state of the IMS with its capabilities
+     */
+    val imsState: StateFlow<ImsStateModel>
+
     /**
      * True if this network has NET_CAPABILITIY_PRIORITIZE_LATENCY, and can be considered to be a
      * network slice
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/demo/DemoMobileConnectionRepository.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/demo/DemoMobileConnectionRepository.kt
index 410389a8d94c..e155e0849031 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/demo/DemoMobileConnectionRepository.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/demo/DemoMobileConnectionRepository.kt
@@ -21,6 +21,7 @@ import android.telephony.SubscriptionManager.INVALID_SUBSCRIPTION_ID
 import android.telephony.TelephonyManager
 import com.android.systemui.log.table.TableLogBuffer
 import com.android.systemui.log.table.logDiffsForTable
+import com.android.systemui.statusbar.pipeline.ims.data.model.ImsStateModel
 import com.android.systemui.statusbar.pipeline.mobile.data.model.DataConnectionState
 import com.android.systemui.statusbar.pipeline.mobile.data.model.NetworkNameModel
 import com.android.systemui.statusbar.pipeline.mobile.data.model.ResolvedNetworkType
@@ -220,6 +221,8 @@ class DemoMobileConnectionRepository(
 
     override val isAllowedDuringAirplaneMode = MutableStateFlow(false)
 
+    override val imsState = MutableStateFlow(ImsStateModel())
+
     override val hasPrioritizedNetworkCapabilities = MutableStateFlow(false)
 
     override suspend fun isInEcmMode(): Boolean = false
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/prod/CarrierMergedConnectionRepository.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/prod/CarrierMergedConnectionRepository.kt
index db08f25eadaf..d7e7006721d7 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/prod/CarrierMergedConnectionRepository.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/prod/CarrierMergedConnectionRepository.kt
@@ -23,6 +23,7 @@ import android.util.Log
 import com.android.systemui.dagger.SysUISingleton
 import com.android.systemui.dagger.qualifiers.Background
 import com.android.systemui.log.table.TableLogBuffer
+import com.android.systemui.statusbar.pipeline.ims.data.model.ImsStateModel
 import com.android.systemui.statusbar.pipeline.mobile.data.model.DataConnectionState
 import com.android.systemui.statusbar.pipeline.mobile.data.model.NetworkNameModel
 import com.android.systemui.statusbar.pipeline.mobile.data.model.ResolvedNetworkType
@@ -173,6 +174,7 @@ class CarrierMergedConnectionRepository(
     override val isGsm = MutableStateFlow(false).asStateFlow()
     override val carrierNetworkChangeActive = MutableStateFlow(false).asStateFlow()
     override val satelliteLevel = MutableStateFlow(0)
+    override val imsState = MutableStateFlow(ImsStateModel()).asStateFlow()
 
     /**
      * Carrier merged connections happen over wifi but are displayed as a mobile triangle. Because
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/prod/FullMobileConnectionRepository.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/prod/FullMobileConnectionRepository.kt
index 5094bc7e083a..9834eb1866d0 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/prod/FullMobileConnectionRepository.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/prod/FullMobileConnectionRepository.kt
@@ -22,6 +22,7 @@ import com.android.systemui.dagger.qualifiers.Background
 import com.android.systemui.log.table.TableLogBuffer
 import com.android.systemui.log.table.TableLogBufferFactory
 import com.android.systemui.log.table.logDiffsForTable
+import com.android.systemui.statusbar.pipeline.ims.data.repository.ImsRepositoryImpl
 import com.android.systemui.statusbar.pipeline.mobile.data.model.NetworkNameModel
 import com.android.systemui.statusbar.pipeline.mobile.data.model.SubscriptionModel
 import com.android.systemui.statusbar.pipeline.mobile.data.repository.MobileConnectionRepository
@@ -55,6 +56,7 @@ class FullMobileConnectionRepository(
     @Background scope: CoroutineScope,
     private val mobileRepoFactory: MobileConnectionRepositoryImpl.Factory,
     private val carrierMergedRepoFactory: CarrierMergedConnectionRepository.Factory,
+    private val imsRepoFactory: ImsRepositoryImpl.Factory,
 ) : MobileConnectionRepository {
     /**
      * Sets whether this connection is a typical mobile connection or a carrier merged connection.
@@ -85,6 +87,7 @@ class FullMobileConnectionRepository(
             subscriptionModel,
             defaultNetworkName,
             networkNameSeparator,
+            imsRepoFactory.build(subId)
         )
     }
 
@@ -349,6 +352,15 @@ class FullMobileConnectionRepository(
                 activeRepo.value.isAllowedDuringAirplaneMode.value,
             )
 
+    override val imsState =
+        activeRepo
+            .flatMapLatest { it.imsState }
+            .stateIn(
+                scope,
+                SharingStarted.WhileSubscribed(),
+                activeRepo.value.imsState.value,
+            )
+
     override val hasPrioritizedNetworkCapabilities =
         activeRepo
             .flatMapLatest { it.hasPrioritizedNetworkCapabilities }
@@ -388,6 +400,7 @@ class FullMobileConnectionRepository(
         private val logFactory: TableLogBufferFactory,
         private val mobileRepoFactory: MobileConnectionRepositoryImpl.Factory,
         private val carrierMergedRepoFactory: CarrierMergedConnectionRepository.Factory,
+        private val imsRepoFactory: ImsRepositoryImpl.Factory
     ) {
         fun build(
             subId: Int,
@@ -409,6 +422,7 @@ class FullMobileConnectionRepository(
                 scope,
                 mobileRepoFactory,
                 carrierMergedRepoFactory,
+                imsRepoFactory,
             )
         }
 
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/prod/MobileConnectionRepositoryImpl.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/prod/MobileConnectionRepositoryImpl.kt
index bf7c2990b5ab..a212ba730b3e 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/prod/MobileConnectionRepositoryImpl.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/data/repository/prod/MobileConnectionRepositoryImpl.kt
@@ -48,6 +48,8 @@ import com.android.systemui.dagger.qualifiers.Background
 import com.android.systemui.flags.FeatureFlagsClassic
 import com.android.systemui.flags.Flags.ROAMING_INDICATOR_VIA_DISPLAY_INFO
 import com.android.systemui.log.table.TableLogBuffer
+import com.android.systemui.statusbar.pipeline.ims.data.model.ImsStateModel
+import com.android.systemui.statusbar.pipeline.ims.data.repository.ImsRepository
 import com.android.systemui.statusbar.pipeline.mobile.data.MobileInputLogger
 import com.android.systemui.statusbar.pipeline.mobile.data.model.DataConnectionState.Disconnected
 import com.android.systemui.statusbar.pipeline.mobile.data.model.NetworkNameModel
@@ -107,6 +109,7 @@ class MobileConnectionRepositoryImpl(
     override val tableLogBuffer: TableLogBuffer,
     flags: FeatureFlagsClassic,
     scope: CoroutineScope,
+    imsRepo: ImsRepository,
 ) : MobileConnectionRepository {
     init {
         if (telephonyManager.subscriptionId != subId) {
@@ -436,6 +439,8 @@ class MobileConnectionRepositoryImpl(
     /** Typical mobile connections aren't available during airplane mode. */
     override val isAllowedDuringAirplaneMode = MutableStateFlow(false).asStateFlow()
 
+    override val imsState: StateFlow<ImsStateModel> = imsRepo.imsState
+
     /**
      * Currently, a network with NET_CAPABILITY_PRIORITIZE_LATENCY is the only type of network that
      * we consider to be a "network slice". _PRIORITIZE_BANDWIDTH may be added in the future. Any of
@@ -494,6 +499,7 @@ class MobileConnectionRepositoryImpl(
             subscriptionModel: Flow<SubscriptionModel?>,
             defaultNetworkName: NetworkNameModel,
             networkNameSeparator: String,
+            imsRepository: ImsRepository,
         ): MobileConnectionRepository {
             return MobileConnectionRepositoryImpl(
                 subId,
@@ -511,6 +517,7 @@ class MobileConnectionRepositoryImpl(
                 mobileLogger,
                 flags,
                 scope,
+                imsRepository,
             )
         }
     }
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/domain/interactor/MobileIconInteractor.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/domain/interactor/MobileIconInteractor.kt
index d5ef67c6d7df..d8935607aa58 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/domain/interactor/MobileIconInteractor.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/domain/interactor/MobileIconInteractor.kt
@@ -131,6 +131,18 @@ interface MobileIconInteractor {
 
     /** True when in carrier network change mode */
     val carrierNetworkChangeActive: Flow<Boolean>
+
+    /** True when VoLTE/VONR available */
+    val isMobileHd: StateFlow<Boolean>
+
+    /** See [MobileIconsInteractor.isMobileHdForceHidden]. */
+    val isMobileHdForceHidden: Flow<Boolean>
+
+    /** True when VoWifi available */
+    val isVoWifi: StateFlow<Boolean>
+
+    /** See [MobileIconsInteractor.isVoWifiForceHidden]. */
+    val isVoWifiForceHidden: Flow<Boolean>
 }
 
 /** Interactor for a single mobile connection. This connection _should_ have one subscription ID */
@@ -147,6 +159,8 @@ class MobileIconInteractorImpl(
     isDefaultConnectionFailed: StateFlow<Boolean>,
     override val isForceHidden: Flow<Boolean>,
     override val isRoamingForceHidden: Flow<Boolean>,
+    override val isMobileHdForceHidden: Flow<Boolean>,
+    override val isVoWifiForceHidden: Flow<Boolean>,
     connectionRepository: MobileConnectionRepository,
     private val context: Context,
     val carrierIdOverrides: MobileIconCarrierIdOverrides = MobileIconCarrierIdOverridesImpl(),
@@ -326,6 +340,15 @@ class MobileIconInteractorImpl(
             }
             .stateIn(scope, SharingStarted.WhileSubscribed(), 0)
 
+    private val showRoaming: StateFlow<Boolean> =
+        combine(
+                isRoaming,
+                isRoamingForceHidden
+        ) { roaming, roamingForceHidden ->
+            roaming && !roamingForceHidden
+        }
+        .stateIn(scope, SharingStarted.WhileSubscribed(), false)
+
     // Satellite level is unaffected by the inflateSignalStrength property
     // See b/346904529 for details
     private val satelliteShownLevel: StateFlow<Int> =
@@ -342,12 +365,14 @@ class MobileIconInteractorImpl(
             numberOfLevels,
             showExclamationMark,
             carrierNetworkChangeActive,
-        ) { cellularShownLevel, numberOfLevels, showExclamationMark, carrierNetworkChange ->
+            showRoaming,
+        ) { cellularShownLevel, numberOfLevels, showExclamationMark, carrierNetworkChange, showRoaming ->
             SignalIconModel.Cellular(
                 cellularShownLevel,
                 numberOfLevels,
                 showExclamationMark,
                 carrierNetworkChange,
+                showRoaming,
             )
         }
 
@@ -368,6 +393,7 @@ class MobileIconInteractorImpl(
                 numberOfLevels.value,
                 showExclamationMark.value,
                 carrierNetworkChangeActive.value,
+                showRoaming.value,
             )
         isNonTerrestrial
             .flatMapLatest { ntn ->
@@ -381,4 +407,14 @@ class MobileIconInteractorImpl(
             .logDiffsForTable(tableLogBuffer, columnPrefix = "icon", initialValue = initial)
             .stateIn(scope, SharingStarted.WhileSubscribed(), initial)
     }
+
+    override val isMobileHd: StateFlow<Boolean> =
+        connectionRepository.imsState
+            .map { it.isHdVoiceCapable() }
+            .stateIn(scope, SharingStarted.WhileSubscribed(), false)
+
+    override val isVoWifi: StateFlow<Boolean> =
+        connectionRepository.imsState
+            .map { it.isVoWifiAvailable() }
+            .stateIn(scope, SharingStarted.WhileSubscribed(), false)
 }
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/domain/interactor/MobileIconsInteractor.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/domain/interactor/MobileIconsInteractor.kt
index f4e0686db3af..b39a33f01bf5 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/domain/interactor/MobileIconsInteractor.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/domain/interactor/MobileIconsInteractor.kt
@@ -31,6 +31,7 @@ import com.android.systemui.log.table.logDiffsForTable
 import com.android.systemui.statusbar.core.NewStatusBarIcons
 import com.android.systemui.statusbar.core.StatusBarRootModernization
 import com.android.systemui.statusbar.pipeline.dagger.MobileSummaryLog
+import com.android.systemui.statusbar.pipeline.ims.data.repository.CommonImsRepository
 import com.android.systemui.statusbar.pipeline.mobile.data.model.SubscriptionModel
 import com.android.systemui.statusbar.pipeline.mobile.data.repository.MobileConnectionRepository
 import com.android.systemui.statusbar.pipeline.mobile.data.repository.MobileConnectionsRepository
@@ -128,6 +129,12 @@ interface MobileIconsInteractor {
     /** True if we're configured to force-hide the roaming and false otherwise. */
     val isRoamingForceHidden: Flow<Boolean>
 
+    /** True if we're configured to force-hide the hd (VoLTE/VoNR) and false otherwise. */
+    val isMobileHdForceHidden: Flow<Boolean>
+
+    /** True if we're configured to force-hide the hd (VoLTE/VoNR) and false otherwise. */
+    val isVoWifiForceHidden: Flow<Boolean>
+
     /**
      * True if the device-level service state (with -1 subscription id) reports emergency calls
      * only. This value is only useful when there are no other subscriptions OR all existing
@@ -154,6 +161,7 @@ constructor(
     connectivityRepository: ConnectivityRepository,
     userSetupRepo: UserSetupRepository,
     @Background private val scope: CoroutineScope,
+    commonImsRepo: CommonImsRepository,
     private val context: Context,
     private val featureFlagsClassic: FeatureFlagsClassic,
 ) : MobileIconsInteractor {
@@ -429,6 +437,16 @@ constructor(
             .map { it.contains(ConnectivitySlot.ROAMING) }
             .stateIn(scope, SharingStarted.WhileSubscribed(), false)
 
+    override val isMobileHdForceHidden: Flow<Boolean> =
+        commonImsRepo.imsIconState
+            .map { !it.showHdIcon }
+            .stateIn(scope, SharingStarted.WhileSubscribed(), true)
+
+    override val isVoWifiForceHidden: Flow<Boolean> =
+        commonImsRepo.imsIconState
+            .map { !it.showVowifiIcon }
+            .stateIn(scope, SharingStarted.WhileSubscribed(), true)
+
     override val isDeviceInEmergencyCallsOnlyMode: Flow<Boolean> =
         mobileConnectionsRepo.isDeviceEmergencyCallCapable
 
@@ -449,6 +467,8 @@ constructor(
                 isDefaultConnectionFailed,
                 isForceHidden,
                 isRoamingForceHidden,
+                isMobileHdForceHidden,
+                isVoWifiForceHidden,
                 mobileConnectionsRepo.getRepoForSubId(subId),
                 context,
             )
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/domain/model/SignalIconModel.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/domain/model/SignalIconModel.kt
index 5d3b9eff593f..3b2cb569edc4 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/domain/model/SignalIconModel.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/domain/model/SignalIconModel.kt
@@ -40,6 +40,7 @@ sealed interface SignalIconModel : Diffable<SignalIconModel> {
         val numberOfLevels: Int,
         val showExclamationMark: Boolean,
         val carrierNetworkChange: Boolean,
+        val showRoaming: Boolean,
     ) : SignalIconModel {
         override fun logPartial(prevVal: SignalIconModel, row: TableRowLogger) {
             if (prevVal !is Cellular) {
@@ -57,6 +58,9 @@ sealed interface SignalIconModel : Diffable<SignalIconModel> {
                 if (prevVal.carrierNetworkChange != carrierNetworkChange) {
                     row.logChange(COL_CARRIER_NETWORK_CHANGE, carrierNetworkChange)
                 }
+                if (prevVal.showRoaming != showRoaming) {
+                    row.logChange(COL_SHOW_ROAMING, showRoaming)
+                }
             }
         }
 
@@ -66,6 +70,7 @@ sealed interface SignalIconModel : Diffable<SignalIconModel> {
             row.logChange(COL_NUM_LEVELS, numberOfLevels)
             row.logChange(COL_SHOW_EXCLAMATION, showExclamationMark)
             row.logChange(COL_CARRIER_NETWORK_CHANGE, carrierNetworkChange)
+            row.logChange(COL_SHOW_ROAMING, showRoaming)
         }
 
         /** Convert this model to an [Int] consumable by [SignalDrawable]. */
@@ -73,7 +78,7 @@ sealed interface SignalIconModel : Diffable<SignalIconModel> {
             if (carrierNetworkChange) {
                 SignalDrawable.getCarrierChangeState(numberOfLevels)
             } else {
-                SignalDrawable.getState(level, numberOfLevels, showExclamationMark)
+                SignalDrawable.getState(level, numberOfLevels, showExclamationMark, showRoaming)
             }
     }
 
@@ -107,5 +112,6 @@ sealed interface SignalIconModel : Diffable<SignalIconModel> {
         private const val COL_SHOW_EXCLAMATION = "showExclamation"
         private const val COL_CARRIER_NETWORK_CHANGE = "carrierNetworkChange"
         private const val COL_TYPE = "type"
+        private const val COL_SHOW_ROAMING = "showRoaming"
     }
 }
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/ui/binder/MobileIconBinder.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/ui/binder/MobileIconBinder.kt
index 161607c698e9..e17034a3e07c 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/ui/binder/MobileIconBinder.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/ui/binder/MobileIconBinder.kt
@@ -69,8 +69,8 @@ object MobileIconBinder {
         val networkTypeContainer = view.requireViewById<FrameLayout>(R.id.mobile_type_container)
         val iconView = view.requireViewById<ImageView>(R.id.mobile_signal)
         val mobileDrawable = SignalDrawable(view.context)
-        val roamingView = view.requireViewById<ImageView>(R.id.mobile_roaming)
-        val roamingSpace = view.requireViewById<Space>(R.id.mobile_roaming_space)
+        val mobileHdView = view.requireViewById<ImageView>(R.id.mobile_hd)
+        val mobileHdSpace = view.requireViewById<Space>(R.id.mobile_hd_space)
         val dotView = view.requireViewById<StatusBarIconView>(R.id.status_bar_dot)
 
         view.isVisible = viewModel.isVisible.value
@@ -208,11 +208,11 @@ object MobileIconBinder {
                         }
                     }
 
-                    // Set the roaming indicator
+                    // Set the mobile HD indicator (VoLTE/VoNR)
                     launch {
-                        viewModel.isRoamingVisible.distinctUntilChanged().collect { isRoaming ->
-                            roamingView.isVisible = isRoaming
-                            roamingSpace.isVisible = isRoaming
+                        viewModel.showHd.distinctUntilChanged().collect { isHd ->
+                            mobileHdView.isVisible = isHd
+                            mobileHdSpace.isVisible = isHd
                         }
                     }
 
@@ -262,7 +262,7 @@ object MobileIconBinder {
                                 networkTypeView.imageTintList = tint
                             }
 
-                            roamingView.imageTintList = tint
+                            mobileHdView.imageTintList = tint
                             activityIn.imageTintList = tint
                             activityOut.imageTintList = tint
                             dotView.setDecorColor(colors.tint)
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/ui/view/ModernStatusBarMobileView.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/ui/view/ModernStatusBarMobileView.kt
index 382af7e135ef..0bd1beaf0aae 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/ui/view/ModernStatusBarMobileView.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/ui/view/ModernStatusBarMobileView.kt
@@ -37,6 +37,8 @@ import com.android.systemui.statusbar.pipeline.mobile.ui.viewmodel.LocationBased
 import com.android.systemui.statusbar.pipeline.shared.ui.view.ModernStatusBarView
 import kotlinx.coroutines.CoroutineScope
 import kotlinx.coroutines.Job
+import com.android.systemui.statusbar.pipeline.shared.ui.binder.ModernStatusBarViewBinding
+import kotlin.math.roundToInt
 
 class ModernStatusBarMobileView(context: Context, attrs: AttributeSet?) :
     ModernStatusBarView(context, attrs) {
@@ -52,6 +54,22 @@ class ModernStatusBarMobileView(context: Context, attrs: AttributeSet?) :
             "viewString=${super.toString()}"
     }
 
+    override fun initView(slot: String, bindingCreator: () -> ModernStatusBarViewBinding) {
+        super.initView(slot, bindingCreator)
+        // Resize HD icon to make fit into the mobile view
+        val signalSize = context.resources.getDimensionPixelSize(
+                com.android.settingslib.R.dimen.signal_icon_size
+        )
+        val viewportSize = context.resources.getDimensionPixelSize(
+                R.dimen.signal_icon_viewport_size
+        )
+        val mobileHd = requireViewById<ImageView>(R.id.mobile_hd)
+        val lp = mobileHd.layoutParams
+        lp.height = (lp.height * (signalSize / viewportSize.toFloat())).roundToInt()
+        lp.width = (lp.width * (signalSize / viewportSize.toFloat())).roundToInt()
+        mobileHd.layoutParams = lp
+    }
+
     companion object {
 
         /**
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/ui/viewmodel/MobileIconViewModel.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/ui/viewmodel/MobileIconViewModel.kt
index df905e0ce806..53726f996333 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/ui/viewmodel/MobileIconViewModel.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/mobile/ui/viewmodel/MobileIconViewModel.kt
@@ -50,7 +50,6 @@ interface MobileIconViewModelCommon {
     val icon: Flow<SignalIconModel>
     val contentDescription: Flow<MobileContentDescription?>
     val roaming: Flow<Boolean>
-    val isRoamingVisible: Flow<Boolean>
     /** The RAT icon (LTE, 3G, 5G, etc) to be displayed. Null if we shouldn't show anything */
     val networkTypeIcon: Flow<Icon.Resource?>
     /** The slice attribution. Drawn as a background layer */
@@ -58,6 +57,7 @@ interface MobileIconViewModelCommon {
     val activityInVisible: Flow<Boolean>
     val activityOutVisible: Flow<Boolean>
     val activityContainerVisible: Flow<Boolean>
+    val showHd: Flow<Boolean>
 }
 
 /**
@@ -126,9 +126,6 @@ class MobileIconViewModel(
 
     override val roaming: Flow<Boolean> = vmProvider.flatMapLatest { it.roaming }
 
-    override val isRoamingVisible: Flow<Boolean> =
-        vmProvider.flatMapLatest { it.isRoamingVisible }
-
     override val networkTypeIcon: Flow<Icon.Resource?> =
         vmProvider.flatMapLatest { it.networkTypeIcon }
 
@@ -145,6 +142,8 @@ class MobileIconViewModel(
 
     override val activityContainerVisible: Flow<Boolean> =
         vmProvider.flatMapLatest { it.activityContainerVisible }
+
+    override val showHd: Flow<Boolean> = vmProvider.flatMapLatest { it.showHd }
 }
 
 /** Representation of this network when it is non-terrestrial (e.g., satellite) */
@@ -165,12 +164,12 @@ private class CarrierBasedSatelliteViewModelImpl(
 
     /** These fields are not used for satellite icons currently */
     override val roaming: Flow<Boolean> = flowOf(false)
-    override val isRoamingVisible: Flow<Boolean> = flowOf(false)
     override val networkTypeIcon: Flow<Icon.Resource?> = flowOf(null)
     override val networkTypeBackground: StateFlow<Icon.Resource?> = MutableStateFlow(null)
     override val activityInVisible: Flow<Boolean> = flowOf(false)
     override val activityOutVisible: Flow<Boolean> = flowOf(false)
     override val activityContainerVisible: Flow<Boolean> = flowOf(false)
+    override val showHd: Flow<Boolean> = flowOf(false)
 }
 
 /** Terrestrial (cellular) icon. */
@@ -306,18 +305,6 @@ private class CellularIconViewModel(
             )
             .stateIn(scope, SharingStarted.WhileSubscribed(), false)
 
-    override val isRoamingVisible: StateFlow<Boolean> =
-        combine(
-                roaming,
-                iconInteractor.isRoamingForceHidden
-            ) { isRoaming, isHidden ->
-                // If it's force hidden, just hide.
-                // Otherwise follow roaming state
-                isRoaming && !isHidden
-            }
-            .distinctUntilChanged()
-            .stateIn(scope, SharingStarted.WhileSubscribed(), false)
-
     private val activity: Flow<DataActivityModel?> =
         if (!constants.shouldShowActivityConfig) {
             flowOf(null)
@@ -342,4 +329,30 @@ private class CellularIconViewModel(
                 activity.map { it != null && (it.hasActivityIn || it.hasActivityOut) }
             }
             .stateIn(scope, SharingStarted.WhileSubscribed(), false)
+
+    private val showVoWifi: StateFlow<Boolean> =
+        combine(
+                iconInteractor.isVoWifi,
+                iconInteractor.isVoWifiForceHidden
+            ) { isVoWifi, isHidden ->
+                // If it's force hidden, just hide.
+                // Otherwise follow VoWifi state
+                isVoWifi && !isHidden
+            }
+            .distinctUntilChanged()
+            .stateIn(scope, SharingStarted.WhileSubscribed(), false)
+
+    override val showHd: StateFlow<Boolean> =
+        combine(
+                iconInteractor.isMobileHd,
+                iconInteractor.isMobileHdForceHidden,
+                showVoWifi,
+            ) { isHd, isHidden, voWifi ->
+                // If it's force hidden or VoWifi available, just hide.
+                // Otherwise follow HD state
+                isHd && !(isHidden || voWifi)
+            }
+            .distinctUntilChanged()
+            .stateIn(scope, SharingStarted.WhileSubscribed(), false)
+
 }
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/WifiRepository.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/WifiRepository.kt
index bc7d376a8740..9152cf191e6a 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/WifiRepository.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/WifiRepository.kt
@@ -16,6 +16,7 @@
 
 package com.android.systemui.statusbar.pipeline.wifi.data.repository
 
+import com.android.systemui.statusbar.pipeline.ims.data.model.ImsStateModel
 import com.android.systemui.statusbar.pipeline.shared.data.model.DataActivityModel
 import com.android.systemui.statusbar.pipeline.wifi.shared.model.WifiNetworkModel
 import com.android.systemui.statusbar.pipeline.wifi.shared.model.WifiScanEntry
@@ -50,6 +51,11 @@ interface WifiRepository {
      */
     val wifiScanResults: StateFlow<List<WifiScanEntry>>
 
+    /**
+     * The list of IMS state of all subscription Ids
+     */
+    val imsStates: StateFlow<List<ImsStateModel>>
+
     /**
      * Returns true if the device is currently connected to a wifi network with a valid SSID and
      * false otherwise.
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/WifiRepositorySwitcher.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/WifiRepositorySwitcher.kt
index 8d1edd9cada4..a6c9e5f9ece2 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/WifiRepositorySwitcher.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/WifiRepositorySwitcher.kt
@@ -22,6 +22,7 @@ import com.android.systemui.dagger.SysUISingleton
 import com.android.systemui.dagger.qualifiers.Background
 import com.android.systemui.demomode.DemoMode
 import com.android.systemui.demomode.DemoModeController
+import com.android.systemui.statusbar.pipeline.ims.data.model.ImsStateModel
 import com.android.systemui.statusbar.pipeline.shared.data.model.DataActivityModel
 import com.android.systemui.statusbar.pipeline.wifi.data.repository.demo.DemoWifiRepository
 import com.android.systemui.statusbar.pipeline.wifi.shared.model.WifiNetworkModel
@@ -127,4 +128,9 @@ constructor(
         activeRepo
             .flatMapLatest { it.wifiScanResults }
             .stateIn(scope, SharingStarted.WhileSubscribed(), realImpl.wifiScanResults.value)
+
+    override val imsStates: StateFlow<List<ImsStateModel>> =
+        activeRepo
+            .flatMapLatest { it.imsStates }
+            .stateIn(scope, SharingStarted.WhileSubscribed(), realImpl.imsStates.value)
 }
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/demo/DemoWifiRepository.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/demo/DemoWifiRepository.kt
index 5d879ddc4ddd..b15b34a671d4 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/demo/DemoWifiRepository.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/demo/DemoWifiRepository.kt
@@ -17,6 +17,7 @@
 package com.android.systemui.statusbar.pipeline.wifi.data.repository.demo
 
 import com.android.systemui.dagger.qualifiers.Application
+import com.android.systemui.statusbar.pipeline.ims.data.model.ImsStateModel
 import com.android.systemui.statusbar.pipeline.shared.data.model.DataActivityModel
 import com.android.systemui.statusbar.pipeline.shared.data.model.toWifiDataActivityModel
 import com.android.systemui.statusbar.pipeline.wifi.data.repository.WifiRepository
@@ -60,6 +61,10 @@ constructor(
         MutableStateFlow(emptyList())
     override val wifiScanResults: StateFlow<List<WifiScanEntry>> = _wifiScanResults
 
+    private val _imsStates: MutableStateFlow<List<ImsStateModel>> =
+        MutableStateFlow(emptyList())
+    override val imsStates: StateFlow<List<ImsStateModel>> = _imsStates
+
     fun startProcessingCommands() {
         demoCommandJob =
             scope.launch {
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/prod/DisabledWifiRepository.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/prod/DisabledWifiRepository.kt
index b79fb9b5caf3..2c0da946f906 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/prod/DisabledWifiRepository.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/prod/DisabledWifiRepository.kt
@@ -17,6 +17,7 @@
 package com.android.systemui.statusbar.pipeline.wifi.data.repository.prod
 
 import com.android.systemui.dagger.SysUISingleton
+import com.android.systemui.statusbar.pipeline.ims.data.model.ImsStateModel
 import com.android.systemui.statusbar.pipeline.shared.data.model.DataActivityModel
 import com.android.systemui.statusbar.pipeline.wifi.data.repository.RealWifiRepository
 import com.android.systemui.statusbar.pipeline.wifi.shared.model.WifiNetworkModel
@@ -49,6 +50,9 @@ class DisabledWifiRepository @Inject constructor() : RealWifiRepository {
     override val wifiScanResults: StateFlow<List<WifiScanEntry>> =
         MutableStateFlow<List<WifiScanEntry>>(emptyList()).asStateFlow()
 
+    override val imsStates: StateFlow<List<ImsStateModel>> =
+        MutableStateFlow<List<ImsStateModel>>(emptyList()).asStateFlow()
+
     companion object {
         private val NETWORK = WifiNetworkModel.Unavailable
         private val ACTIVITY = DataActivityModel(hasActivityIn = false, hasActivityOut = false)
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/prod/WifiRepositoryImpl.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/prod/WifiRepositoryImpl.kt
index eaceb5e22535..212ecd144696 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/prod/WifiRepositoryImpl.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/data/repository/prod/WifiRepositoryImpl.kt
@@ -38,6 +38,8 @@ import com.android.systemui.log.table.logDiffsForTable
 import com.android.systemui.statusbar.connectivity.WifiPickerTrackerFactory
 import com.android.systemui.statusbar.pipeline.dagger.WifiInputLog
 import com.android.systemui.statusbar.pipeline.dagger.WifiTableLog
+import com.android.systemui.statusbar.pipeline.ims.data.model.ImsStateModel
+import com.android.systemui.statusbar.pipeline.ims.data.repository.CommonImsRepository
 import com.android.systemui.statusbar.pipeline.shared.data.model.DataActivityModel
 import com.android.systemui.statusbar.pipeline.shared.data.model.toWifiDataActivityModel
 import com.android.systemui.statusbar.pipeline.wifi.data.repository.RealWifiRepository
@@ -83,6 +85,7 @@ constructor(
     private val wifiManager: WifiManager,
     @WifiInputLog private val inputLogger: LogBuffer,
     @WifiTableLog private val tableLogger: TableLogBuffer,
+    private val commonImsRepo: CommonImsRepository,
 ) : RealWifiRepository, LifecycleOwner {
 
     override val lifecycle =
@@ -501,6 +504,7 @@ constructor(
         private val wifiPickerTrackerFactory: WifiPickerTrackerFactory,
         @WifiInputLog private val inputLogger: LogBuffer,
         @WifiTableLog private val tableLogger: TableLogBuffer,
+        private val commonImsRepository: CommonImsRepository
     ) {
         fun create(wifiManager: WifiManager): WifiRepositoryImpl {
             return WifiRepositoryImpl(
@@ -513,10 +517,13 @@ constructor(
                 wifiManager,
                 inputLogger,
                 tableLogger,
+                commonImsRepository,
             )
         }
     }
 
+    override val imsStates: StateFlow<List<ImsStateModel>> = commonImsRepo.imsStates
+
     companion object {
         // Start out with no known wifi network.
         @VisibleForTesting val WIFI_NETWORK_DEFAULT = WifiNetworkModel.Inactive()
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/domain/interactor/WifiInteractor.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/domain/interactor/WifiInteractor.kt
index c0b0c4acb51a..30ce715b81d4 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/domain/interactor/WifiInteractor.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/domain/interactor/WifiInteractor.kt
@@ -18,10 +18,12 @@ package com.android.systemui.statusbar.pipeline.wifi.domain.interactor
 
 import com.android.systemui.dagger.SysUISingleton
 import com.android.systemui.dagger.qualifiers.Application
+import com.android.systemui.statusbar.pipeline.ims.data.repository.CommonImsRepository
 import com.android.systemui.statusbar.pipeline.shared.data.model.ConnectivitySlot
 import com.android.systemui.statusbar.pipeline.shared.data.model.DataActivityModel
 import com.android.systemui.statusbar.pipeline.shared.data.repository.ConnectivityRepository
 import com.android.systemui.statusbar.pipeline.wifi.data.repository.WifiRepository
+import com.android.systemui.statusbar.pipeline.wifi.shared.model.VoWifiState
 import com.android.systemui.statusbar.pipeline.wifi.shared.model.WifiNetworkModel
 import com.android.systemui.statusbar.pipeline.wifi.shared.model.WifiScanEntry
 import javax.inject.Inject
@@ -63,6 +65,12 @@ interface WifiInteractor {
 
     /** True if there are networks available other than the currently-connected one */
     val areNetworksAvailable: StateFlow<Boolean>
+
+    /** Our current VoWifi state. */
+    val voWifiState: StateFlow<VoWifiState>
+
+    /** True if we're configured to force-hide the VoWifi icon and false otherwise. */
+    val isVoWifiForceHidden: Flow<Boolean>
 }
 
 @SysUISingleton
@@ -71,6 +79,7 @@ class WifiInteractorImpl
 constructor(
     connectivityRepository: ConnectivityRepository,
     wifiRepository: WifiRepository,
+    commonImsRepo: CommonImsRepository,
     @Application scope: CoroutineScope,
 ) : WifiInteractor {
 
@@ -117,6 +126,26 @@ constructor(
             }
             .stateIn(scope, SharingStarted.WhileSubscribed(), false)
 
+
+    override val voWifiState: StateFlow<VoWifiState> =
+        wifiRepository.imsStates.map { states ->
+            val voWifiEnabled = states.filter { it.isVoWifiAvailable() }
+            if (voWifiEnabled.isNotEmpty()) {
+                // Get the VoWifi enabled slots
+                val slots = voWifiEnabled.map { it.slotIndex }
+                // Get the active subscription count from any one of the states
+                // (All states are being collected at the same time so doesn't matter)
+                val activeSubCount = voWifiEnabled.first().activeSubCount
+                VoWifiState.Enabled(slots, activeSubCount)
+            } else {
+                VoWifiState.Disabled
+            }
+        }
+        .stateIn(scope, SharingStarted.WhileSubscribed(), VoWifiState.Disabled)
+
+    override val isVoWifiForceHidden: Flow<Boolean> =
+        commonImsRepo.imsIconState.map { !it.showVowifiIcon }
+
     private fun anyNonMatchingNetworkExists(
         currentNetwork: WifiNetworkModel.Active,
         availableNetworks: List<WifiScanEntry>
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/shared/model/VoWifiState.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/shared/model/VoWifiState.kt
new file mode 100644
index 000000000000..1cb570f7a13a
--- /dev/null
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/shared/model/VoWifiState.kt
@@ -0,0 +1,22 @@
+/*
+ * Copyright (C) 2024 The LibreMobileOS Foundation
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.systemui.statusbar.pipeline.wifi.shared.model
+
+sealed interface VoWifiState {
+    data class Enabled(val slots: List<Int>, val activeSubCount: Int) : VoWifiState
+    object Disabled : VoWifiState
+}
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/ui/binder/WifiViewBinder.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/ui/binder/WifiViewBinder.kt
index fd93c6bd09b8..b362ebaecbee 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/ui/binder/WifiViewBinder.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/ui/binder/WifiViewBinder.kt
@@ -33,6 +33,7 @@ import com.android.systemui.statusbar.pipeline.shared.ui.binder.ModernStatusBarV
 import com.android.systemui.statusbar.pipeline.shared.ui.binder.ModernStatusBarViewVisibilityHelper
 import com.android.systemui.statusbar.pipeline.shared.ui.binder.StatusBarViewBinderConstants.ALPHA_ACTIVE
 import com.android.systemui.statusbar.pipeline.shared.ui.binder.StatusBarViewBinderConstants.ALPHA_INACTIVE
+import com.android.systemui.statusbar.pipeline.wifi.ui.model.VoWifiIcon
 import com.android.systemui.statusbar.pipeline.wifi.ui.model.WifiIcon
 import com.android.systemui.statusbar.pipeline.wifi.ui.viewmodel.LocationBasedWifiViewModel
 import kotlinx.coroutines.InternalCoroutinesApi
@@ -66,6 +67,7 @@ object WifiViewBinder {
         val activityContainerView = view.requireViewById<View>(R.id.inout_container)
         val airplaneSpacer = view.requireViewById<View>(R.id.wifi_airplane_spacer)
         val signalSpacer = view.requireViewById<View>(R.id.wifi_signal_spacer)
+        val voWifiView = view.requireViewById<ImageView>(R.id.vowifi)
 
         view.isVisible = true
         iconView.isVisible = true
@@ -115,6 +117,7 @@ object WifiViewBinder {
                         iconView.imageTintList = tintList
                         activityInView.imageTintList = tintList
                         activityOutView.imageTintList = tintList
+                        voWifiView.imageTintList = tintList
                         dotView.setDecorColor(tint)
                     }
                 }
@@ -172,6 +175,15 @@ object WifiViewBinder {
                     }
                 }
 
+                launch {
+                    viewModel.voWifiIcon.distinctUntilChanged().collect { voWifiIcon ->
+                        voWifiView.isVisible = voWifiIcon is VoWifiIcon.Visible
+                        if (voWifiIcon is VoWifiIcon.Visible) {
+                            IconViewBinder.bind(voWifiIcon.icon, voWifiView)
+                        }
+                    }
+                }
+
                 try {
                     awaitCancellation()
                 } finally {
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/ui/model/VoWifiIcon.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/ui/model/VoWifiIcon.kt
new file mode 100644
index 000000000000..5867ddb003a3
--- /dev/null
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/ui/model/VoWifiIcon.kt
@@ -0,0 +1,57 @@
+/*
+ * Copyright (C) 2024 The LibreMobileOS Foundation
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.systemui.statusbar.pipeline.wifi.ui.model
+
+import com.android.systemui.res.R
+import com.android.systemui.common.shared.model.Icon
+import com.android.systemui.statusbar.pipeline.wifi.shared.model.VoWifiState
+
+sealed interface VoWifiIcon {
+    data class Visible(val icon: Icon) : VoWifiIcon
+    object Hidden : VoWifiIcon
+}
+
+val VoWifiState.icon: VoWifiIcon
+    get() = when (this) {
+        is VoWifiState.Enabled -> {
+            val ic = if (activeSubCount == 2) {
+                if (slots.size >= 2) {
+                    R.drawable.ic_vowifi_dual
+                } else {
+                    val id = slots.firstOrNull() ?: -1
+                    when (id) {
+                        0 -> R.drawable.ic_vowifi_one // Sim 1
+                        1 -> R.drawable.ic_vowifi_two // Sim 2
+                        else -> 0
+                    }
+                }
+            } else {
+                R.drawable.ic_vowifi
+            }
+            if (ic == 0) {
+                VoWifiIcon.Hidden
+            } else {
+                VoWifiIcon.Visible(
+                    Icon.Resource(
+                        ic, null /* Content description */
+                    )
+                )
+            }
+        }
+
+        else -> VoWifiIcon.Hidden
+    }
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/ui/viewmodel/WifiViewModel.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/ui/viewmodel/WifiViewModel.kt
index 986068bc00bc..1f6bc2f8a4a1 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/ui/viewmodel/WifiViewModel.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/ui/viewmodel/WifiViewModel.kt
@@ -30,7 +30,9 @@ import com.android.systemui.statusbar.pipeline.shared.data.model.DataActivityMod
 import com.android.systemui.statusbar.pipeline.wifi.domain.interactor.WifiInteractor
 import com.android.systemui.statusbar.pipeline.wifi.shared.WifiConstants
 import com.android.systemui.statusbar.pipeline.wifi.shared.model.WifiNetworkModel
+import com.android.systemui.statusbar.pipeline.wifi.ui.model.VoWifiIcon
 import com.android.systemui.statusbar.pipeline.wifi.ui.model.WifiIcon
+import com.android.systemui.statusbar.pipeline.wifi.ui.model.icon
 import java.util.function.Supplier
 import javax.inject.Inject
 import javax.inject.Named
@@ -39,6 +41,7 @@ import kotlinx.coroutines.flow.Flow
 import kotlinx.coroutines.flow.SharingStarted
 import kotlinx.coroutines.flow.StateFlow
 import kotlinx.coroutines.flow.combine
+import kotlinx.coroutines.flow.distinctUntilChanged
 import kotlinx.coroutines.flow.flowOf
 import kotlinx.coroutines.flow.map
 import kotlinx.coroutines.flow.stateIn
@@ -135,4 +138,16 @@ constructor(
         airplaneModeViewModel.isAirplaneModeIconVisible
 
     override val isSignalSpacerVisible: Flow<Boolean> = shouldShowSignalSpacerProvider.get()
+
+    override val voWifiIcon: Flow<VoWifiIcon> =
+        combine(
+                interactor.voWifiState,
+                interactor.isVoWifiForceHidden
+            ) { state, isHidden ->
+                // If it's force hidden, just hide.
+                // Otherwise follow VoWifi state
+                if (isHidden) VoWifiIcon.Hidden else state.icon
+            }
+            .distinctUntilChanged()
+            .stateIn(scope, SharingStarted.WhileSubscribed(), VoWifiIcon.Hidden)
 }
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/ui/viewmodel/WifiViewModelCommon.kt b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/ui/viewmodel/WifiViewModelCommon.kt
index 617e19200a0a..51504446a8aa 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/ui/viewmodel/WifiViewModelCommon.kt
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/pipeline/wifi/ui/viewmodel/WifiViewModelCommon.kt
@@ -16,6 +16,7 @@
 
 package com.android.systemui.statusbar.pipeline.wifi.ui.viewmodel
 
+import com.android.systemui.statusbar.pipeline.wifi.ui.model.VoWifiIcon
 import com.android.systemui.statusbar.pipeline.wifi.ui.model.WifiIcon
 import kotlinx.coroutines.flow.Flow
 import kotlinx.coroutines.flow.StateFlow
@@ -42,4 +43,7 @@ interface WifiViewModelCommon {
 
     /** True if the spacer between the wifi icon and the RAT icon should be visible. */
     val isSignalSpacerVisible: Flow<Boolean>
+
+    /** The VoWifi icon that should be displayed. */
+    val voWifiIcon: Flow<VoWifiIcon>
 }
-- 
2.51.2.windows.1

