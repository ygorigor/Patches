From 84c0b7b3e6abf0b2df56e0ade06c79ac71769acc Mon Sep 17 00:00:00 2001
From: Saul Henriquez <saul_henriquez@hotmail.com>
Date: Thu, 21 Oct 2021 20:30:27 -0600
Subject: [PATCH] Launcher3: Allow widgets to have 1 row as minimum size

Signed-off-by: Saul Henriquez <saul_henriquez@hotmail.com>
---
 .../launcher3/widget/LauncherAppWidgetProviderInfo.java       | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/com/android/launcher3/widget/LauncherAppWidgetProviderInfo.java b/src/com/android/launcher3/widget/LauncherAppWidgetProviderInfo.java
index 94ae69cccd..e566ceb1b0 100644
--- a/src/com/android/launcher3/widget/LauncherAppWidgetProviderInfo.java
+++ b/src/com/android/launcher3/widget/LauncherAppWidgetProviderInfo.java
@@ -103,7 +103,7 @@ public class LauncherAppWidgetProviderInfo extends AppWidgetProviderInfo impleme
     public void initSpans(Context context, InvariantDeviceProfile idp) {
         mPM = context.getApplicationContext().getPackageManager();
         int minSpanX = 0;
-        int minSpanY = 0;
+        int minSpanY = 1;
         int maxSpanX = idp.numColumns;
         int maxSpanY = idp.numRows;
         int spanX = 0;
@@ -124,7 +124,7 @@ public class LauncherAppWidgetProviderInfo extends AppWidgetProviderInfo impleme
             minSpanX = Math.max(minSpanX,
                     getSpanX(widgetPadding, minResizeWidth, dp.cellLayoutBorderSpacePx.x,
                             cellSize.x));
-            minSpanY = Math.max(minSpanY,
+            minSpanY = Math.min(minSpanY,
                     getSpanY(widgetPadding, minResizeHeight, dp.cellLayoutBorderSpacePx.y,
                             cellSize.y));
 
-- 

From 05cad3f74b850dc6f7aa257bcd9f3aa5b64535ce Mon Sep 17 00:00:00 2001
From: Thecrazyskull <anaskarbila@gmail.com>
Date: Fri, 10 Feb 2017 09:38:50 -0500
Subject: [PATCH] Launcher3: Double tap on home screen to turn off screen

Change-Id: I554c005d5e523aca0842c78a353686e86af1a7f2
Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 AndroidManifest-common.xml                            |  1 +
 .../launcher3/touch/WorkspaceTouchListener.java       | 11 +++++++++++
 2 files changed, 12 insertions(+)

diff --git a/AndroidManifest-common.xml b/AndroidManifest-common.xml
index 0ddb79eb5f..691d27ea72 100644
--- a/AndroidManifest-common.xml
+++ b/AndroidManifest-common.xml
@@ -46,6 +46,7 @@
     <uses-permission android:name="android.permission.WAKEUP_SURFACE_FLINGER" />
     <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
     <uses-permission android:name="android.permission.USE_BIOMETRIC" />
     <uses-permission android:name="android.permission.ACCESS_CONTEXTUAL_SEARCH" />
+    <uses-permission android:name="android.permission.DEVICE_POWER" />
 
     <!--
     Permissions required for read/write access to the workspace data. These permission name
diff --git a/src/com/android/launcher3/touch/WorkspaceTouchListener.java b/src/com/android/launcher3/touch/WorkspaceTouchListener.java
index 576f17616b..712fd3a3e4 100644
--- a/src/com/android/launcher3/touch/WorkspaceTouchListener.java
+++ b/src/com/android/launcher3/touch/WorkspaceTouchListener.java
@@ -28,8 +28,10 @@ import static com.android.launcher3.logging.StatsLogManager.LauncherEvent.LAUNCH
 import static com.android.launcher3.logging.StatsLogManager.LauncherEvent.LAUNCHER_SPLIT_SELECTION_EXIT_INTERRUPTED;
 import static com.android.launcher3.logging.StatsLogManager.LauncherEvent.LAUNCHER_WORKSPACE_LONGPRESS;
 
+import android.content.Context;
 import android.graphics.PointF;
 import android.graphics.Rect;
+import android.os.PowerManager;
 import android.view.GestureDetector;
 import android.view.HapticFeedbackConstants;
 import android.view.InputDevice;
@@ -74,6 +76,8 @@ public class WorkspaceTouchListener extends GestureDetector.SimpleOnGestureListe
 
     private int mLongPressState = STATE_CANCELLED;
 
+    private final PowerManager mPm;
+
     private final GestureDetector mGestureDetector;
 
     public WorkspaceTouchListener(Launcher launcher, Workspace<?> workspace) {
@@ -82,6 +86,7 @@ public class WorkspaceTouchListener extends GestureDetector.SimpleOnGestureListe
         // Use twice the touch slop as we are looking for long press which is more
         // likely to cause movement.
         mTouchSlop = 2 * ViewConfiguration.get(launcher).getScaledTouchSlop();
+        mPm = (PowerManager) workspace.getContext().getSystemService(Context.POWER_SERVICE);
         mGestureDetector = new GestureDetector(workspace.getContext(), this);
     }
 
@@ -220,4 +225,10 @@ public class WorkspaceTouchListener extends GestureDetector.SimpleOnGestureListe
             }
         }
     }
+
+    @Override
+    public boolean onDoubleTap(MotionEvent event) {
+        mPm.goToSleep(event.getEventTime());
+        return true;
+    }
 }
-- 

From a80e1a0c900621b4f5f7eb00072f5cad4746a6c4 Mon Sep 17 00:00:00 2001
From: Hikari-no-Tenshi <kyryljan.serhij@gmail.com>
Date: Wed, 5 Feb 2020 22:05:00 +0200
Subject: [PATCH] Launcher3: Make double tap to sleep gesture optional

[neobuddy89: Move to SwitchPreferenceCompat]

Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 res/values/lineage_strings.xml                      |  4 ++++
 res/xml/launcher_preferences.xml                    |  7 +++++++
 .../launcher3/touch/WorkspaceTouchListener.java     | 13 ++++++++++---
 3 files changed, 21 insertions(+), 3 deletions(-)

diff --git a/res/values/lineage_strings.xml b/res/values/lineage_strings.xml
index eda1bc7206..840041ac45 100644
--- a/res/values/lineage_strings.xml
+++ b/res/values/lineage_strings.xml
@@ -60,4 +60,8 @@
     <!-- App suggestions -->
     <string name="pref_suggestions_title">Suggestions</string>
     <string name="pref_suggestions_summary">For app drawer &amp; home screen suggestions</string>
+
+    <!-- DT2S -->
+    <string name="pref_sleep_gesture_title">Double tap to sleep</string>
+    <string name="pref_sleep_gesture_summary">Double tap on empty space for screen off</string>
 </resources>
diff --git a/res/xml/launcher_preferences.xml b/res/xml/launcher_preferences.xml
index c32cdeaedb..9796299ef0 100644
--- a/res/xml/launcher_preferences.xml
+++ b/res/xml/launcher_preferences.xml
@@ -103,4 +103,11 @@
         android:defaultValue="true"
         android:persistent="true" />
 
+	<SwitchPreferenceCompat
+        android:key="pref_sleep_gesture"
+        android:title="@string/pref_sleep_gesture_title"
+        android:summary="@string/pref_sleep_gesture_summary"
+        android:defaultValue="true"
+        android:persistent="true" />
+
 </androidx.preference.PreferenceScreen>
diff --git a/src/com/android/launcher3/touch/WorkspaceTouchListener.java b/src/com/android/launcher3/touch/WorkspaceTouchListener.java
index 712fd3a3e4..462ab21454 100644
--- a/src/com/android/launcher3/touch/WorkspaceTouchListener.java
+++ b/src/com/android/launcher3/touch/WorkspaceTouchListener.java
@@ -44,6 +44,7 @@ import com.android.launcher3.AbstractFloatingView;
 import com.android.launcher3.CellLayout;
 import com.android.launcher3.DeviceProfile;
 import com.android.launcher3.Launcher;
+import com.android.launcher3.LauncherPrefs;
 import com.android.launcher3.Workspace;
 import com.android.launcher3.dragndrop.DragLayer;
 import com.android.launcher3.logger.LauncherAtom;
@@ -68,6 +69,8 @@ public class WorkspaceTouchListener extends GestureDetector.SimpleOnGestureListe
     private static final int STATE_PENDING_PARENT_INFORM = 2;
     private static final int STATE_COMPLETED = 3;
 
+    private static final String SLEEP_GESTURE = "pref_sleep_gesture";
+
     private final Rect mTempRect = new Rect();
     private final Launcher mLauncher;
     private final Workspace<?> mWorkspace;
@@ -80,14 +83,17 @@ public class WorkspaceTouchListener extends GestureDetector.SimpleOnGestureListe
 
     private final GestureDetector mGestureDetector;
 
+    private final Context mContext;
+
     public WorkspaceTouchListener(Launcher launcher, Workspace<?> workspace) {
         mLauncher = launcher;
         mWorkspace = workspace;
+        mContext = workspace.getContext();
         // Use twice the touch slop as we are looking for long press which is more
         // likely to cause movement.
         mTouchSlop = 2 * ViewConfiguration.get(launcher).getScaledTouchSlop();
-        mPm = (PowerManager) workspace.getContext().getSystemService(Context.POWER_SERVICE);
-        mGestureDetector = new GestureDetector(workspace.getContext(), this);
+        mPm = (PowerManager) mContext.getSystemService(Context.POWER_SERVICE);
+        mGestureDetector = new GestureDetector(mContext, this);
     }
 
     @Override
@@ -228,7 +234,8 @@ public class WorkspaceTouchListener extends GestureDetector.SimpleOnGestureListe
 
     @Override
     public boolean onDoubleTap(MotionEvent event) {
-        mPm.goToSleep(event.getEventTime());
+        if (LauncherPrefs.getPrefs(mContext).getBoolean(SLEEP_GESTURE, true))
+            mPm.goToSleep(event.getEventTime());
         return true;
     }
 }
-- 

From 0421c6a6bb16230bb820c3a6896b015ef6b0b2b9 Mon Sep 17 00:00:00 2001
From: LordShenron <shen.priyanshu@gmail.com>
Date: Sun, 2 Apr 2023 20:16:50 +0800
Subject: [PATCH] Launcher3: Vibrate on double tap to sleep

Signed-off-by: LordShenron <shen.priyanshu@gmail.com>
Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 src/com/android/launcher3/touch/WorkspaceTouchListener.java | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/src/com/android/launcher3/touch/WorkspaceTouchListener.java b/src/com/android/launcher3/touch/WorkspaceTouchListener.java
index 462ab21454..fd33b79331 100644
--- a/src/com/android/launcher3/touch/WorkspaceTouchListener.java
+++ b/src/com/android/launcher3/touch/WorkspaceTouchListener.java
@@ -51,6 +51,7 @@ import com.android.launcher3.logger.LauncherAtom;
 import com.android.launcher3.testing.TestLogging;
 import com.android.launcher3.testing.shared.TestProtocol;
 import com.android.launcher3.util.TouchUtil;
+import com.android.launcher3.util.VibratorWrapper;
 
 /**
  * Helper class to handle touch on empty space in workspace and show options popup on long press
@@ -234,8 +235,10 @@ public class WorkspaceTouchListener extends GestureDetector.SimpleOnGestureListe
 
     @Override
     public boolean onDoubleTap(MotionEvent event) {
-        if (LauncherPrefs.getPrefs(mContext).getBoolean(SLEEP_GESTURE, true))
+        if (LauncherPrefs.getPrefs(mContext).getBoolean(SLEEP_GESTURE, true)) {
+            VibratorWrapper.INSTANCE.get(mContext).vibrate(VibratorWrapper.EFFECT_CLICK);
             mPm.goToSleep(event.getEventTime());
+        }
         return true;
     }
 }
-- 

From e901c620acbe30952f153e20c2df23ce3a15fbb3 Mon Sep 17 00:00:00 2001
From: jhonboy121 <alfredmathew05@gmail.com>
Date: Tue, 15 Mar 2022 18:55:35 +0530
Subject: [PATCH] Launcher3: Show clear all button in recents overview

idoybh (YAAP): Keep rightmost
neobuddy89: Updated for A15 QPR2

Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 quickstep/res/drawable/ic_clear_all.xml       | 19 +++++++++++++++++++
 .../res/layout/overview_actions_container.xml |  9 +++++++++
 .../states/BackgroundAppState.java            |  1 -
 .../uioverrides/states/OverviewState.java     |  2 +-
 .../android/quickstep/TaskOverlayFactory.java | 15 +++++++++++++++
 .../quickstep/fallback/RecentsState.java      |  2 +-
 .../quickstep/views/OverviewActionsView.java  |  5 ++++-
 .../android/quickstep/views/RecentsView.java  |  4 ++++
 8 files changed, 53 insertions(+), 4 deletions(-)
 create mode 100644 quickstep/res/drawable/ic_clear_all.xml

diff --git a/quickstep/res/drawable/ic_clear_all.xml b/quickstep/res/drawable/ic_clear_all.xml
new file mode 100644
index 0000000000..00e8fd42a3
--- /dev/null
+++ b/quickstep/res/drawable/ic_clear_all.xml
@@ -0,0 +1,19 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2020 The Android Open Source Project
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+          http://www.apache.org/licenses/LICENSE-2.0
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:height="24dp"
+    android:width="24dp"
+    android:viewportWidth="24"
+    android:viewportHeight="24">
+    <path android:fillColor="#FF000000" android:pathData="M5,13H19V11H5M3,17H17V15H3M7,7V9H21V7" />
+</vector>
\ No newline at end of file
diff --git a/quickstep/res/layout/overview_actions_container.xml b/quickstep/res/layout/overview_actions_container.xml
index fcd2e5495a..8b53f92b43 100644
--- a/quickstep/res/layout/overview_actions_container.xml
+++ b/quickstep/res/layout/overview_actions_container.xml
@@ -45,6 +45,15 @@
             android:theme="@style/ThemeControlHighlightWorkspaceColor"
             android:visibility="gone" />
 
+        <Button
+            android:id="@+id/action_clear_all"
+            style="@style/OverviewActionButton"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:drawableStart="@drawable/ic_clear_all"
+            android:text="@string/recents_clear_all"
+            android:theme="@style/ThemeControlHighlightWorkspaceColor" />
+
     </LinearLayout>
 
     <!-- Currently, the only "group action button" is this save app pair button. If more are added,
diff --git a/quickstep/src/com/android/launcher3/uioverrides/states/BackgroundAppState.java b/quickstep/src/com/android/launcher3/uioverrides/states/BackgroundAppState.java
index a5b1ee7b53..93c82e315e 100644
--- a/quickstep/src/com/android/launcher3/uioverrides/states/BackgroundAppState.java
+++ b/quickstep/src/com/android/launcher3/uioverrides/states/BackgroundAppState.java
@@ -76,7 +76,6 @@ public class BackgroundAppState extends OverviewState {
     public int getVisibleElements(Launcher launcher) {
         return super.getVisibleElements(launcher)
                 & ~OVERVIEW_ACTIONS
-                & ~CLEAR_ALL_BUTTON
                 & ~VERTICAL_SWIPE_INDICATOR
                 & ~ADD_DESK_BUTTON;
     }
diff --git a/quickstep/src/com/android/launcher3/uioverrides/states/OverviewState.java b/quickstep/src/com/android/launcher3/uioverrides/states/OverviewState.java
index c774143328..2dd515e377 100644
--- a/quickstep/src/com/android/launcher3/uioverrides/states/OverviewState.java
+++ b/quickstep/src/com/android/launcher3/uioverrides/states/OverviewState.java
@@ -113,7 +113,7 @@ public class OverviewState extends LauncherState {
 
     @Override
     public int getVisibleElements(Launcher launcher) {
-        int elements = CLEAR_ALL_BUTTON | OVERVIEW_ACTIONS | ADD_DESK_BUTTON;
+        int elements = OVERVIEW_ACTIONS | ADD_DESK_BUTTON;
         DeviceProfile dp = launcher.getDeviceProfile();
         boolean showFloatingSearch;
         if (dp.isPhone) {
diff --git a/quickstep/src/com/android/quickstep/TaskOverlayFactory.java b/quickstep/src/com/android/quickstep/TaskOverlayFactory.java
index 5bf4451fad..e9038a7892 100644
--- a/quickstep/src/com/android/quickstep/TaskOverlayFactory.java
+++ b/quickstep/src/com/android/quickstep/TaskOverlayFactory.java
@@ -256,6 +256,11 @@ public class TaskOverlayFactory implements ResourceBasedOverride {
                     .saveAppPair(taskView);
         }
 
+        private void clearAllTasks() {
+            final RecentsView recentsView = mTaskContainer.getTaskView().getRecentsView();
+            recentsView.dismissAllTasks();
+        }
+
         /**
          * Called when the overlay is no longer used.
          */
@@ -402,17 +407,25 @@ public class TaskOverlayFactory implements ResourceBasedOverride {
             }
 
             @SuppressLint("NewApi")
+            @Override
             public void onScreenshot() {
                 endLiveTileMode(() -> saveScreenshot(mTask));
             }
 
+            @Override
             public void onSplit() {
                 endLiveTileMode(TaskOverlay.this::enterSplitSelect);
             }
 
+            @Override
             public void onSaveAppPair() {
                 endLiveTileMode(TaskOverlay.this::saveAppPair);
             }
+
+            @Override
+            public void onClearAllTasksRequested() {
+                endLiveTileMode(TaskOverlay.this::clearAllTasks);
+            }
         }
     }
 
@@ -429,5 +442,7 @@ public class TaskOverlayFactory implements ResourceBasedOverride {
 
         /** User wants to save an app pair with current group of apps. */
         void onSaveAppPair();
+
+        void onClearAllTasksRequested();
     }
 }
diff --git a/quickstep/src/com/android/quickstep/fallback/RecentsState.java b/quickstep/src/com/android/quickstep/fallback/RecentsState.java
index 77aac4176d..358f36dedc 100644
--- a/quickstep/src/com/android/quickstep/fallback/RecentsState.java
+++ b/quickstep/src/com/android/quickstep/fallback/RecentsState.java
@@ -140,7 +140,7 @@ public class RecentsState implements BaseState<RecentsState> {
      * For this state, whether clear all button should be shown.
      */
     public boolean hasClearAllButton() {
-        return hasFlag(FLAG_CLEAR_ALL_BUTTON);
+        return false;
     }
 
     /**
diff --git a/quickstep/src/com/android/quickstep/views/OverviewActionsView.java b/quickstep/src/com/android/quickstep/views/OverviewActionsView.java
index 7b0ec4ed04..ea0a93b56e 100644
--- a/quickstep/src/com/android/quickstep/views/OverviewActionsView.java
+++ b/quickstep/src/com/android/quickstep/views/OverviewActionsView.java
@@ -185,6 +185,7 @@ public class OverviewActionsView<T extends OverlayUICallbacks> extends FrameLayo
         mSplitButton = findViewById(R.id.action_split);
         mSplitButton.setOnClickListener(this);
         mSaveAppPairButton.setOnClickListener(this);
+        findViewById(R.id.action_clear_all).setOnClickListener(this);
     }
 
     /**
@@ -201,13 +202,15 @@ public class OverviewActionsView<T extends OverlayUICallbacks> extends FrameLayo
         if (mCallbacks == null) {
             return;
         }
-        int id = view.getId();
+        final int id = view.getId();
         if (id == R.id.action_screenshot) {
             mCallbacks.onScreenshot();
         } else if (id == R.id.action_split) {
             mCallbacks.onSplit();
         } else if (id == R.id.action_save_app_pair) {
             mCallbacks.onSaveAppPair();
+        } else if (id == R.id.action_clear_all) {
+            mCallbacks.onClearAllTasksRequested();
         }
     }
 
diff --git a/quickstep/src/com/android/quickstep/views/RecentsView.java b/quickstep/src/com/android/quickstep/views/RecentsView.java
index 3e4b953b5b..b90cdc7f6a 100644
--- a/quickstep/src/com/android/quickstep/views/RecentsView.java
+++ b/quickstep/src/com/android/quickstep/views/RecentsView.java
@@ -4730,6 +4730,10 @@ public abstract class RecentsView<
         mContainer.getStatsLogManager().logger().log(LAUNCHER_TASK_CLEAR_ALL);
     }
 
+    public void dismissAllTasks() {
+        dismissAllTasks(null);
+    }
+
     private void dismissCurrentTask() {
         TaskView taskView = getNextPageTaskView();
         if (taskView != null) {
-- 

From 7aa9d32461d12add9b5fc2ca397e91cbabcde377 Mon Sep 17 00:00:00 2001
From: minaripenguin <minaripenguin@users.noreply.github.com>
Date: Sat, 26 Oct 2024 21:23:53 +0800
Subject: [PATCH] Launcher3: Fix crashes when navigating from launcher settings
 to home screen

*logs:

10-26 21:11:50.189 14667 14667 E AndroidRuntime: Process: com.android.launcher3, PID: 14667
10-26 21:11:50.189 14667 14667 E AndroidRuntime: java.lang.NullPointerException: Attempt to invoke virtual method 'android.graphics.drawable.Drawable$ConstantState com.android.launcher3.icons.FastBitmapDrawable.getConstantState()' on a null object reference
10-26 21:11:50.189 14667 14667 E AndroidRuntime: 	at com.android.launcher3.views.FloatingIconView.lambda$fetchIcon$3(FloatingIconView.java:570)
10-26 21:11:50.189 14667 14667 E AndroidRuntime: 	at com.android.launcher3.views.FloatingIconView$$ExternalSyntheticLambda3.get(D8$$SyntheticClass:0)
10-26 21:11:50.189 14667 14667 E AndroidRuntime: 	at com.android.launcher3.views.FloatingIconView.setOriginalDrawableBackground(FloatingIconView.java:404)
10-26 21:11:50.189 14667 14667 E AndroidRuntime: 	at com.android.launcher3.views.FloatingIconView.getFloatingIconView(FloatingIconView.java:635)
10-26 21:11:50.189 14667 14667 E AndroidRuntime: 	at com.android.quickstep.LauncherSwipeHandlerV2.createIconHomeAnimationFactory(LauncherSwipeHandlerV2.java:134)
10-26 21:11:50.189 14667 14667 E AndroidRuntime: 	at com.android.quickstep.LauncherSwipeHandlerV2.createHomeAnimationFactory(LauncherSwipeHandlerV2.java:128)
10-26 21:11:50.189 14667 14667 E AndroidRuntime: 	at com.android.quickstep.AbsSwipeUpHandler.animateToProgressInternal(AbsSwipeUpHandler.java:1617)

10-26 21:11:50.189 14667 14688 E AndroidRuntime: FATAL EXCEPTION: launcher-loader
10-26 21:11:50.189 14667 14688 E AndroidRuntime: Process: com.android.launcher3, PID: 14667
10-26 21:11:50.189 14667 14688 E AndroidRuntime: java.lang.NullPointerException: Attempt to invoke virtual method 'android.content.ComponentName android.content.Intent.getComponent()' on a null object reference
10-26 21:11:50.189 14667 14688 E AndroidRuntime: 	at android.content.pm.LauncherApps.resolveActivity(LauncherApps.java:975)
10-26 21:11:50.189 14667 14688 E AndroidRuntime: 	at com.android.launcher3.Utilities.getFullDrawable(Utilities.java:660)
10-26 21:11:50.189 14667 14688 E AndroidRuntime: 	at com.android.launcher3.views.FloatingIconView.getIconResult(FloatingIconView.java:319)
10-26 21:11:50.189 14667 14688 E AndroidRuntime: 	at com.android.launcher3.views.FloatingIconView.lambda$fetchIcon$4(FloatingIconView.java:585)

test: manual, swipe from launcher settings to homescreen

Signed-off-by: minaripenguin <minaripenguin@users.noreply.github.com>
Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 src/com/android/launcher3/Utilities.java              | 6 +++++-
 src/com/android/launcher3/views/FloatingIconView.java | 4 +++-
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/src/com/android/launcher3/Utilities.java b/src/com/android/launcher3/Utilities.java
index d20a247f8a..dba647f7aa 100644
--- a/src/com/android/launcher3/Utilities.java
+++ b/src/com/android/launcher3/Utilities.java
@@ -647,8 +647,12 @@ public final class Utilities {
                     ((PendingAddShortcutInfo) info).getActivityInfo(context);
             mainIcon = activityInfo.getFullResIcon(appState.getIconCache());
         } else if (info.itemType == LauncherSettings.Favorites.ITEM_TYPE_APPLICATION) {
+            android.content.Intent intent = info.getIntent();
+            if (intent == null) {
+                return null;
+            }
             LauncherActivityInfo activityInfo = context.getSystemService(LauncherApps.class)
-                    .resolveActivity(info.getIntent(), info.user);
+                    .resolveActivity(intent, info.user);
             if (activityInfo == null) {
                 return null;
             }
diff --git a/src/com/android/launcher3/views/FloatingIconView.java b/src/com/android/launcher3/views/FloatingIconView.java
index 5b3abc383a..88fc26e04f 100644
--- a/src/com/android/launcher3/views/FloatingIconView.java
+++ b/src/com/android/launcher3/views/FloatingIconView.java
@@ -571,7 +571,9 @@ public class FloatingIconView extends FrameLayout implements
             } else {
                 btvIcon = btv.getIcon();
                 // Clone when needed
-                btvDrawableSupplier = () -> btvIcon.getConstantState().newDrawable();
+                btvDrawableSupplier = () -> (btvIcon != null && btvIcon.getConstantState() != null)
+                        ? btvIcon.getConstantState().newDrawable()
+                        : null;
             }
         } else {
             btvIcon = null;
-- 

From 4a25760aedc42556b0d481d77eb26b66fbca6f69 Mon Sep 17 00:00:00 2001
From: Yaksh Bariya <yakshbari4@gmail.com>
Date: Wed, 15 Jan 2025 13:06:26 +0530
Subject: [PATCH] Launcher3: Fix upstream bug with dots enabled (#5167)

https://github.com/GrapheneOS/os-issue-tracker/issues/2601

I did not find any issue reported upstream, but I can confirm that this
bug exists on Moto App Launcher (the launcher on Motorola's devices),
which seems to imply this is a bug in AOSP itself. I had asked
@agnostic-apollo about this is a bug, and he said that this is a bug in
Android's libraries itself

@neobuddy89: Update error message.

Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 .../android/launcher3/notification/NotificationListener.java   | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/src/com/android/launcher3/notification/NotificationListener.java b/src/com/android/launcher3/notification/NotificationListener.java
index 864fed064f..a92de1bcdf 100644
--- a/src/com/android/launcher3/notification/NotificationListener.java
+++ b/src/com/android/launcher3/notification/NotificationListener.java
@@ -209,6 +209,9 @@ public class NotificationListener extends NotificationListenerService {
             result = getActiveNotifications(keys);
         } catch (SecurityException e) {
             Log.e(TAG, "SecurityException: failed to fetch notifications");
+        } catch (RuntimeException e) {
+            // This is an upstream bug in the Android framework
+            Log.e(TAG, "RuntimeException: failed to fetch notifications");
         }
         return result == null ? new StatusBarNotification[0] : result;
     }
-- 

From 177f287640086d531c15b0182e360b1bb58d4f1c Mon Sep 17 00:00:00 2001
From: Pranav Vashi <neobuddy89@gmail.com>
Date: Fri, 7 Apr 2023 08:46:03 +0530
Subject: [PATCH] Launcher3: Add vibrate for all overview actions

Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 .../com/android/quickstep/views/OverviewActionsView.java    | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/quickstep/src/com/android/quickstep/views/OverviewActionsView.java b/quickstep/src/com/android/quickstep/views/OverviewActionsView.java
index ea0a93b56e..8007111a90 100644
--- a/quickstep/src/com/android/quickstep/views/OverviewActionsView.java
+++ b/quickstep/src/com/android/quickstep/views/OverviewActionsView.java
@@ -39,6 +39,7 @@ import com.android.launcher3.anim.AnimatedFloat;
 import com.android.launcher3.util.DisplayController;
 import com.android.launcher3.util.MultiValueAlpha;
 import com.android.launcher3.util.NavigationMode;
+import com.android.launcher3.util.VibratorWrapper;
 import com.android.quickstep.TaskOverlayFactory.OverlayUICallbacks;
 import com.android.quickstep.util.LayoutUtils;
 import com.android.wm.shell.shared.TypefaceUtils;
@@ -204,13 +205,18 @@ public class OverviewActionsView<T extends OverlayUICallbacks> extends FrameLayo
         }
         final int id = view.getId();
         if (id == R.id.action_screenshot) {
+            VibratorWrapper.INSTANCE.get(getContext()).vibrate(VibratorWrapper.EFFECT_CLICK);
             mCallbacks.onScreenshot();
         } else if (id == R.id.action_split) {
+            VibratorWrapper.INSTANCE.get(getContext()).vibrate(VibratorWrapper.EFFECT_CLICK);
             mCallbacks.onSplit();
         } else if (id == R.id.action_save_app_pair) {
+            VibratorWrapper.INSTANCE.get(getContext()).vibrate(VibratorWrapper.EFFECT_CLICK);
             mCallbacks.onSaveAppPair();
         } else if (id == R.id.action_clear_all) {
+            VibratorWrapper.INSTANCE.get(getContext()).vibrate(VibratorWrapper.EFFECT_CLICK);
             mCallbacks.onClearAllTasksRequested();
+            VibratorWrapper.INSTANCE.get(getContext()).vibrate(VibratorWrapper.EFFECT_CLICK);
         }
     }
 
-- 

From 9a0293379ba7d7dbfbfeec4399933ff0d736b9ac Mon Sep 17 00:00:00 2001
From: MrSluffy <werdna.jac@gmail.com>
Date: Sat, 22 Jun 2024 15:12:51 +0800
Subject: [PATCH] Launcher3: Fix keyboard disappear on empty search

neobuddy89 -
Fixes: https://github.com/LawnchairLauncher/lawnchair/issues/4095

Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 .../launcher3/allapps/ActivityAllAppsContainerView.java      | 5 -----
 1 file changed, 5 deletions(-)

diff --git a/src/com/android/launcher3/allapps/ActivityAllAppsContainerView.java b/src/com/android/launcher3/allapps/ActivityAllAppsContainerView.java
index 1f1bc7a584..58e3af424a 100644
--- a/src/com/android/launcher3/allapps/ActivityAllAppsContainerView.java
+++ b/src/com/android/launcher3/allapps/ActivityAllAppsContainerView.java
@@ -558,17 +558,12 @@ public class ActivityAllAppsContainerView<T extends Context & ActivityContext>
             // Will be called at the end of the animation.
             return;
         }
-        if (currentActivePage != SEARCH) {
-            mActivityContext.hideKeyboard();
-        }
         if (mAH.get(currentActivePage).mRecyclerView != null) {
             mAH.get(currentActivePage).mRecyclerView.bindFastScrollbar(mFastScroller,
                     ALL_APPS_SCROLLER);
         }
         // Header keeps track of active recycler view to properly render header protection.
         mHeader.setActiveRV(currentActivePage);
-        reset(true /* animate */, !isSearching() /* exitSearch */);
-
         mWorkManager.onActivePageChanged(currentActivePage);
     }
 
-- 

From d5395b34d454be8ebeb64607a9fc5eb2edcc3e01 Mon Sep 17 00:00:00 2001
From: Pranav Vashi <neobuddy89@gmail.com>
Date: Sat, 27 Jul 2024 04:46:48 +0530
Subject: [PATCH] Launcher3: Hide keyboard when transitioning to home screen

Squashed:

    From: Pranav Vashi <neobuddy89@gmail.com>
    Date: Fri, 6 Sep 2024 19:54:04 +0530
    Subject: [PATCH 298/300] Launcher3: Improve hide keyboard when transitioning
     to home screen

    Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>

Fixes: https://github.com/crdroidandroid/issue_tracker/issues/448
Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 src/com/android/launcher3/Launcher.java | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/src/com/android/launcher3/Launcher.java b/src/com/android/launcher3/Launcher.java
index 2e69ddb631..3439a43e17 100644
--- a/src/com/android/launcher3/Launcher.java
+++ b/src/com/android/launcher3/Launcher.java
@@ -2803,7 +2803,9 @@ public class Launcher extends StatefulActivity<LauncherState>
      * @param progress Transition progress from 0 to 1; where 0 => home and 1 => all apps.
      */
     public void onAllAppsTransition(float progress) {
-        // No-Op
+        if (progress == 0 && mAppsView != null) {
+            hideKeyboard();
+        }
     }
 
     /**
-- 

From 22727cf0f337863c5400b208203001515acb10bc Mon Sep 17 00:00:00 2001
From: Pranav Vashi <neobuddy89@gmail.com>
Date: Tue, 9 Aug 2022 10:28:30 +0530
Subject: [PATCH] Launcher3: Follow navbar color in base for settings

* Ref: https://github.com/crdroidandroid/android_frameworks_base/commit/d5915acc696dbdbfea1889d5688c8dc6a3c67ecd

Change-Id: Ic8f27892bdb31b9b3bba41db2a543fc3befcd6d9
Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 res/values-v31/styles.xml | 1 -
 res/values/styles.xml     | 1 -
 2 files changed, 2 deletions(-)

diff --git a/res/values-v31/styles.xml b/res/values-v31/styles.xml
index 7f4ab553b2..8e3090fd07 100644
--- a/res/values-v31/styles.xml
+++ b/res/values-v31/styles.xml
@@ -22,7 +22,6 @@
     <style name="HomeSettings.Theme" parent="@android:style/Theme.DeviceDefault.Settings">
         <item name="android:listPreferredItemPaddingEnd">16dp</item>
         <item name="android:listPreferredItemPaddingStart">24dp</item>
-        <item name="android:navigationBarColor">@android:color/transparent</item>
         <item name="android:statusBarColor">@android:color/transparent</item>
         <item name="android:switchStyle">@style/SwitchStyle</item>
         <item name="android:textAppearanceListItem">@style/HomeSettings.PreferenceTitle</item>
diff --git a/res/values/styles.xml b/res/values/styles.xml
index b1d5e7d39b..9374e3dc76 100644
--- a/res/values/styles.xml
+++ b/res/values/styles.xml
@@ -174,7 +174,6 @@
     <style name="AppTheme.Dark.DarkText" parent="@style/LauncherTheme.Dark.DarkText" />
 
     <style name="HomeSettings.Theme" parent="@android:style/Theme.DeviceDefault.Settings">
-        <item name="android:navigationBarColor">?android:colorPrimaryDark</item>
         <item name="android:windowActionBar">false</item>
         <item name="android:windowNoTitle">true</item>
         <item name="preferenceTheme">@style/HomeSettings.PreferenceTheme</item>
-- 

From 7becf4e8ba728cbfdc98a7a600e6c4358317466c Mon Sep 17 00:00:00 2001
From: Pranav Vashi <neobuddy89@gmail.com>
Date: Sun, 24 Apr 2022 02:11:35 +0530
Subject: [PATCH] Launcher3: Use font configs instead hardcoded fonts

Change-Id: Ia9a954cd3fe3e2b56d791f3fc88283603a342664
Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 go/quickstep/res/values/styles.xml            |  6 ++---
 .../res/layout/predicted_hotseat_edu.xml      |  2 +-
 quickstep/res/values/styles.xml               | 22 +++++++++----------
 .../appprediction/AppsDividerView.java        |  2 +-
 res/layout/all_apps_empty_search.xml          |  2 +-
 res/layout/drop_target_tool_tip.xml           |  2 +-
 res/values-v31/styles.xml                     | 15 ++++++-------
 res/values/styles.xml                         |  2 +-
 8 files changed, 26 insertions(+), 27 deletions(-)

diff --git a/go/quickstep/res/values/styles.xml b/go/quickstep/res/values/styles.xml
index 2524c760f4..4f66829d3e 100644
--- a/go/quickstep/res/values/styles.xml
+++ b/go/quickstep/res/values/styles.xml
@@ -41,7 +41,7 @@
     </style>
 
     <style name="GoOverviewActionButtonCaption">
-        <item name="android:fontFamily">sans-serif-medium</item>
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamilyMedium</item>
         <item name="android:textSize">14dp</item>
         <item name="android:textColor">?attr/overviewButtonTextColor</item>
         <item name="android:lineHeight">20dp</item>
@@ -61,7 +61,7 @@
 
     <!-- Modal Dialogs -->
     <style name="ModalDialogTitle">
-        <item name="android:fontFamily">sans-serif-medium</item>
+        <item name="android:fontFamily">@*android:string/config_headlineFontFamily</item>
         <item name="android:textSize">20sp</item>
         <item name="android:textColor">?android:attr/textColorPrimary</item>
         <item name="android:lineHeight">24dp</item>
@@ -71,7 +71,7 @@
     </style>
 
     <style name="ModalDialogText">
-        <item name="android:fontFamily">sans-serif-medium</item>
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamilyMedium</item>
         <item name="android:textSize">16sp</item>
         <item name="android:textColor">?android:attr/textColorTertiary</item>
         <item name="android:lineHeight">24dp</item>
diff --git a/quickstep/res/layout/predicted_hotseat_edu.xml b/quickstep/res/layout/predicted_hotseat_edu.xml
index f0c12f1029..9b5fb13ea9 100644
--- a/quickstep/res/layout/predicted_hotseat_edu.xml
+++ b/quickstep/res/layout/predicted_hotseat_edu.xml
@@ -42,7 +42,7 @@
             android:paddingLeft="@dimen/bottom_sheet_edu_padding"
             android:paddingRight="@dimen/bottom_sheet_edu_padding"
             android:text="@string/hotseat_edu_title_migrate"
-            android:fontFamily="google-sans"
+            android:fontFamily="@*android:string/config_bodyFontFamily"
             android:textAlignment="center"
             android:textColor="@android:color/white"
             android:textSize="20sp" />
diff --git a/quickstep/res/values/styles.xml b/quickstep/res/values/styles.xml
index f8ca8d9adf..992e0fdc7e 100644
--- a/quickstep/res/values/styles.xml
+++ b/quickstep/res/values/styles.xml
@@ -42,7 +42,7 @@
         parent="TextAppearance.GestureTutorial">
         <item name="android:gravity">start</item>
         <item name="android:textColor">?android:attr/textColorPrimary</item>
-        <item name="android:fontFamily">google-sans</item>
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamily</item>
         <item name="android:letterSpacing">0.03</item>
         <item name="android:textSize">36sp</item>
         <item name="android:lineHeight">44sp</item>
@@ -79,7 +79,7 @@
     <style name="TextAppearance.GestureTutorial.Dialog.Title"
         parent="TextAppearance.GestureTutorial.Feedback.Title">
         <item name="android:gravity">center_horizontal</item>
-        <item name="android:fontFamily">google-sans</item>
+        <item name="android:fontFamily">@*android:string/config_headlineFontFamily</item>
         <item name="android:lineHeight">32sp</item>
         <item name="android:textSize">24sp</item>
     </style>
@@ -88,7 +88,7 @@
         parent="TextAppearance.GestureTutorial">
         <item name="android:gravity">start</item>
         <item name="android:textColor">?android:attr/textColorPrimary</item>
-        <item name="android:fontFamily">google-sans-text</item>
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamily</item>
         <item name="android:letterSpacing">0.03</item>
         <item name="android:textSize">14sp</item>
         <item name="android:lineHeight">20sp</item>
@@ -103,7 +103,7 @@
     <style name="TextAppearance.GestureTutorial.Dialog.Subtitle"
         parent="TextAppearance.GestureTutorial.Feedback.Subtitle">
         <item name="android:gravity">center_horizontal</item>
-        <item name="android:fontFamily">google-sans-text</item>
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamily</item>
         <item name="android:letterSpacing">0.025</item>
         <item name="android:lineHeight">20sp</item>
         <item name="android:textSize">14sp</item>
@@ -128,7 +128,7 @@
         <item name="android:letterSpacing">0.02</item>
         <item name="android:textSize">16sp</item>
         <item name="android:textAllCaps">false</item>
-        <item name="android:fontFamily">google-sans-text-medium</item>
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamilyMedium</item>
     </style>
 
     <style name="TextAppearance.GestureTutorial.ButtonLabel.Home"
@@ -164,7 +164,7 @@
     <style name="TextAppearance.GestureTutorial.MainTitle"
         parent="TextAppearance.GestureTutorial">
         <item name="android:textSize">36sp</item>
-        <item name="android:fontFamily">google-sans</item>
+        <item name="android:fontFamily">@*android:string/config_headlineFontFamily</item>
     </style>
 
     <style name="TextAppearance.GestureTutorial.MainTitle.Home"
@@ -201,7 +201,7 @@
         parent="TextAppearance.GestureTutorial.Subtitle">
         <item name="android:textSize">16sp</item>
         <item name="android:letterSpacing">0.02</item>
-        <item name="android:fontFamily">google-sans-text</item>
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamily</item>
         <item name="android:textColor">?attr/tutorialSubtitle</item>
     </style>
 
@@ -256,18 +256,18 @@
 
     <style name="TextAppearance.TaskbarEduTooltip.Title" parent="@android:style/TextAppearance.DeviceDefault.DialogWindowTitle">
         <item name="android:gravity">center_horizontal</item>
-        <item name="android:fontFamily">google-sans</item>
+        <item name="android:fontFamily">@*android:string/config_headlineFontFamily</item>
         <item name="android:textSize">24sp</item>
     </style>
 
     <style name="TextAppearance.TaskbarEduTooltip.Subtext" parent="android:TextAppearance.Material.Body1">
         <item name="android:layout_marginTop">16dp</item>
-        <item name="android:fontFamily">google-sans-text</item>
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamily</item>
         <item name="android:textSize">14sp</item>
     </style>
 
     <style name="KeyboardQuickSwitchText">
-        <item name="fontFamily">google-sans-text</item>
+        <item name="fontFamily">@*android:string/config_bodyFontFamily</item>
         <item name="android:textSize">14sp</item>
         <item name="android:textColor">@color/materialColorOnSurface</item>
         <item name="lineHeight">20sp</item>
@@ -318,7 +318,7 @@
     </style>
 
     <style name="IconAppChipMenuTextStyle">
-        <item name="android:fontFamily">google-sans-text-medium</item>
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamilyMedium</item>
         <item name="android:textSize">@dimen/task_thumbnail_icon_menu_text_size</item>
         <item name="android:textColor">@color/materialColorOnSurface</item>
         <item name="android:includeFontPadding">false</item>
diff --git a/quickstep/src/com/android/launcher3/appprediction/AppsDividerView.java b/quickstep/src/com/android/launcher3/appprediction/AppsDividerView.java
index e1e3eec790..994232ad10 100644
--- a/quickstep/src/com/android/launcher3/appprediction/AppsDividerView.java
+++ b/quickstep/src/com/android/launcher3/appprediction/AppsDividerView.java
@@ -211,7 +211,7 @@ public class AppsDividerView extends View implements FloatingHeaderRow {
     private Layout getAllAppsLabelLayout() {
         if (mAllAppsLabelLayout == null) {
             mPaint.setAntiAlias(true);
-            mPaint.setTypeface(Typeface.create("google-sans", Typeface.NORMAL));
+            mPaint.setTypeface(Typeface.create("@*android:string/config_bodyFontFamilyMedium", Typeface.NORMAL));
             mPaint.setTextSize(
                     getResources().getDimensionPixelSize(R.dimen.all_apps_label_text_size));
 
diff --git a/res/layout/all_apps_empty_search.xml b/res/layout/all_apps_empty_search.xml
index 463adac0c6..1e890ca4ac 100644
--- a/res/layout/all_apps_empty_search.xml
+++ b/res/layout/all_apps_empty_search.xml
@@ -23,7 +23,7 @@
     android:paddingBottom="8dp"
     android:paddingLeft="16dp"
     android:paddingRight="16dp"
-    android:fontFamily="sans-serif-medium"
+    android:fontFamily="@*android:string/config_bodyFontFamilyMedium"
     android:textSize="14sp"
     android:textColor="?android:attr/textColorTertiary"
     android:focusable="false" />
diff --git a/res/layout/drop_target_tool_tip.xml b/res/layout/drop_target_tool_tip.xml
index a3efec4e31..2e33b87631 100644
--- a/res/layout/drop_target_tool_tip.xml
+++ b/res/layout/drop_target_tool_tip.xml
@@ -27,5 +27,5 @@
     android:paddingStart="16dp"
     android:paddingTop="6.5dp"
     android:textSize="14sp"
-    android:fontFamily="sans-serif"
+    android:fontFamily="@*android:string/config_bodyFontFamily"
     android:textColor="?android:attr/colorForeground" />
diff --git a/res/values-v31/styles.xml b/res/values-v31/styles.xml
index 8e3090fd07..6949e66411 100644
--- a/res/values-v31/styles.xml
+++ b/res/values-v31/styles.xml
@@ -28,7 +28,7 @@
         <item name="android:windowActionBar">false</item>
         <item name="android:windowNoTitle">true</item>
         <item name="preferenceTheme">@style/HomeSettings.PreferenceTheme</item>
-        <item name="android:fontFamily" android:featureFlag="com.android.launcher3.gsf_res">google-sans-flex</item>
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamily</item>
     </style>
 
     <style name="HomeSettings.PreferenceTheme" parent="@style/PreferenceThemeOverlay">
@@ -38,7 +38,7 @@
         <item name="preferenceScreenStyle">@style/HomeSettings.PreferenceScreenStyle</item>
         <item name="preferenceStyle">@style/HomeSettings.PreferenceStyle</item>
         <item name="switchPreferenceCompatStyle">@style/HomeSettings.SwitchPreferenceStyle</item>
-        <item name="android:fontFamily">google-sans-text</item>
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamily</item>
     </style>
 
     <style name="HomeSettings.CategoryStyle" parent="@style/Preference.Category.Material">
@@ -63,12 +63,12 @@
 
     <style name="HomeSettings.PreferenceTitle"
             parent="@android:style/TextAppearance.Material.Subhead">
-        <item name="android:fontFamily">google-sans</item>
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamily</item>
         <item name="android:textSize">20sp</item>
     </style>
 
     <style name="HomeSettings.CategoryTitle" parent="@android:style/TextAppearance.Material.Body2">
-        <item name="android:fontFamily">google-sans-text-medium</item>
+        <item name="android:fontFamily">@*android:string/config_headlineFontFamily</item>
     </style>
 
     <style name="HomeSettings.CollapsingToolbar" parent="@style/Theme.MaterialComponents.DayNight">
@@ -80,13 +80,12 @@
 
     <style name="HomeSettings.CollapsedToolbarTitle"
             parent="@android:style/TextAppearance.DeviceDefault.Widget.ActionBar.Title">
-        <item name="android:fontFamily" android:featureFlag="!com.android.launcher3.gsf_res">google-sans</item>
-        <item name="android:fontFamily" android:featureFlag="com.android.launcher3.gsf_res">variable-title-large</item>
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamily</item>
         <item name="android:textSize">20sp</item>
     </style>
 
     <style name="HomeSettings.ExpandedToolbarTitle" parent="HomeSettings.CollapsedToolbarTitle">
-        <item name="android:fontFamily" android:featureFlag="com.android.launcher3.gsf_res">variable-display-small</item>
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamily</item>
         <item name="android:textSize">36sp</item>
     </style>
-</resources>
\ No newline at end of file
+</resources>
diff --git a/res/values/styles.xml b/res/values/styles.xml
index 9374e3dc76..431e92202f 100644
--- a/res/values/styles.xml
+++ b/res/values/styles.xml
@@ -475,7 +475,7 @@
     <style name="PrivateSpaceHeaderTextStyle">
         <item name="android:textSize">16sp</item>
         <item name="android:textColor">@color/materialColorOnSurface</item>
-        <item name="android:fontFamily">google-sans-text-medium</item>
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamilyMedium</item>
         <item name="android:ellipsize">end</item>
     </style>
 </resources>
-- 

From e76fc25262019d38df69e954825b413e2ce6f274 Mon Sep 17 00:00:00 2001
From: Adithya R <gh0strider.2k18.reborn@gmail.com>
Date: Tue, 2 Nov 2021 23:36:14 +0530
Subject: [PATCH] Launcher3: Use regular body font for app labels

Change-Id: I00e07f23ae944c5986f26080f1a6ebf0898f9726
Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 res/values/styles.xml | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/res/values/styles.xml b/res/values/styles.xml
index 431e92202f..5e1f26a2fe 100644
--- a/res/values/styles.xml
+++ b/res/values/styles.xml
@@ -339,7 +339,9 @@
         <item name="android:importantForAccessibility">no</item>
     </style>
 
-    <style name="BaseIconRoot" parent="@android:style/TextAppearance.DeviceDefault.DialogWindowTitle"/>
+    <style name="BaseIconRoot" parent="@android:style/TextAppearance.DeviceDefault.DialogWindowTitle">
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamily</item>
+    </style>
 
     <style name="BaseIconUnBounded" parent="BaseIconRoot">
         <item name="android:layout_width">match_parent</item>
-- 

From d0ea2a641613868f5ee52b804c4146e91f21db3b Mon Sep 17 00:00:00 2001
From: jhenrique09 <jhsv09@gmail.com>
Date: Sun, 29 Jan 2023 13:00:54 +0800
Subject: [PATCH] Launcher3: Fix app icon font

Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 res/values/styles.xml | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/res/values/styles.xml b/res/values/styles.xml
index 5e1f26a2fe..68d5a24c89 100644
--- a/res/values/styles.xml
+++ b/res/values/styles.xml
@@ -340,7 +340,7 @@
     </style>
 
     <style name="BaseIconRoot" parent="@android:style/TextAppearance.DeviceDefault.DialogWindowTitle">
-        <item name="android:fontFamily">@*android:string/config_bodyFontFamily</item>
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamilyMedium</item>
     </style>
 
     <style name="BaseIconUnBounded" parent="BaseIconRoot">
@@ -412,7 +412,9 @@
         <item name="android:fontFamily" android:featureFlag="com.android.launcher3.gsf_res">variable-title-medium</item>
     </style>
 
-    <style name="TextHeadline" parent="@android:style/TextAppearance.DeviceDefault.DialogWindowTitle" />
+    <style name="TextHeadline" parent="@android:style/TextAppearance.DeviceDefault.DialogWindowTitle">
+        <item name="android:fontFamily">@*android:string/config_bodyFontFamilyMedium</item>
+    </style>
 
     <style name="PrimaryHeadline" parent="@android:style/TextAppearance.DeviceDefault.DialogWindowTitle"/>
 
-- 

From 8e446634458367ac9e1af3e496759d6b20c1a112 Mon Sep 17 00:00:00 2001
From: Pranav Vashi <neobuddy89@gmail.com>
Date: Tue, 13 Dec 2022 23:19:47 +0530
Subject: [PATCH] Launcher3: Make it a platform package

Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 Android.bp                 | 4 ++++
 AndroidManifest-common.xml | 4 +++-
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/Android.bp b/Android.bp
index 9471cd0d77..17f8ea93b3 100644
--- a/Android.bp
+++ b/Android.bp
@@ -458,6 +458,7 @@ android_app {
     min_sdk_version: min_launcher3_sdk_version,
     target_sdk_version: "current",
     plugins: ["dagger2-compiler"],
+    certificate: "platform",
     privileged: true,
     system_ext_specific: true,
 
@@ -603,6 +604,7 @@ android_app {
     min_sdk_version: "current",
     target_sdk_version: "current",
 
+    certificate: "platform",
     privileged: true,
     system_ext_specific: true,
     overrides: [
@@ -649,6 +651,7 @@ android_app {
         shrink_resources: true,
     },
 
+    certificate: "platform",
     privileged: true,
     system_ext_specific: true,
     overrides: [
@@ -690,6 +693,7 @@ android_app {
         shrink_resources: true,
     },
 
+    certificate: "platform",
     privileged: true,
     system_ext_specific: true,
     overrides: [
diff --git a/AndroidManifest-common.xml b/AndroidManifest-common.xml
index 109e90e7b5..76ab7cef84 100644
--- a/AndroidManifest-common.xml
+++ b/AndroidManifest-common.xml
@@ -20,7 +20,9 @@
 <manifest
     xmlns:android="http://schemas.android.com/apk/res/android"
     xmlns:tools="http://schemas.android.com/tools"
-    package="com.android.launcher3">
+    package="com.android.launcher3"
+    coreApp="true"
+    android:sharedUserId="android.uid.system">
 
     <!--
     The manifest defines the common entries that should be present in any derivative of Launcher3.
-- 

From 24c92463c7a713a7ca91d40cef7f333fdedd2733 Mon Sep 17 00:00:00 2001
From: nift4 <nift4@protonmail.com>
Date: Wed, 23 Aug 2023 17:56:27 +0200
Subject: [PATCH] Launcher3: Disable live tile

Method as per Google commit 25399db1e7495132eafc5eb9ca0cacdcb38148fd
("[DO NOT MERGE] Disable live tile in split mode for S").

Live tile has a LOT of bugs even in AOSP and Pixel stock ROMs:
* Alpha animation randomly not applying causing app to get stuck
* X/Y translation not applying causing app to get stuck
* Causes extreme jank (enable HWUI bars and swipe in recents...)
* Sidescroll tile minimization cuts off content instead of shrinking it.
* Screenshotting a sidescolled live tile causes it to become invisible.

Combined with our blur/transparency changes:
* The tile doesn't actually shrink because Google just draws background
  over the tile instead of shrinking it...
* The tile gets blurred which has to be fixed in very hacky ways,
  because it is on a very low layer, which is below the blur
...the end result is a total mess.
Kill this feature, and revisit fixing our issues once Google gets their
own shit together.

Change-Id: I33e6dab845b2147fd72fe0fb4c151e78035560ec
Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 quickstep/src/com/android/quickstep/views/RecentsView.java | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/quickstep/src/com/android/quickstep/views/RecentsView.java b/quickstep/src/com/android/quickstep/views/RecentsView.java
index b90cdc7f6a..05ff28f659 100644
--- a/quickstep/src/com/android/quickstep/views/RecentsView.java
+++ b/quickstep/src/com/android/quickstep/views/RecentsView.java
@@ -3080,6 +3080,10 @@ public abstract class RecentsView<
         }
 
         mCurrentGestureEndTarget = null;
+
+        switchToScreenshot(
+            () -> finishRecentsAnimation(true /* toRecents */, false /* shouldPip */,
+                    null));
     }
 
     /**
-- 

From c45237334e999372f8037670d7872d958ada624e Mon Sep 17 00:00:00 2001
From: ygorigor <sorocean.igor@gmail.com>
Date: Mon, 25 Aug 2025 09:59:18 +0300
Subject: [PATCH] Launcher3: Increase icons size for some grids

---
 res/xml/device_profiles.xml | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

diff --git a/res/xml/device_profiles.xml b/res/xml/device_profiles.xml
index c931b013fe..e1562981aa 100644
--- a/res/xml/device_profiles.xml
+++ b/res/xml/device_profiles.xml
@@ -185,7 +185,7 @@
             launcher:name="Large Phone"
             launcher:minWidthDps="406"
             launcher:minHeightDps="694"
-            launcher:iconImageSize="56"
+            launcher:iconImageSize="60"
             launcher:iconTextSize="12.0"
             launcher:allAppsBorderSpace="16"
             launcher:allAppsCellHeight="104"
@@ -197,7 +197,7 @@
             launcher:name="Large Phone Split Display"
             launcher:minWidthDps="406"
             launcher:minHeightDps="694"
-            launcher:iconImageSize="56"
+            launcher:iconImageSize="60"
             launcher:iconTextSize="12.0"
             launcher:allAppsBorderSpace="16"
             launcher:allAppsCellHeight="104"
@@ -209,7 +209,7 @@
             launcher:name="Shorter Stubby"
             launcher:minWidthDps="255"
             launcher:minHeightDps="400"
-            launcher:iconImageSize="48"
+            launcher:iconImageSize="52"
             launcher:iconTextSize="12.0"
             launcher:allAppsBorderSpace="16"
             launcher:allAppsCellHeight="104"
@@ -234,7 +234,7 @@
             launcher:name="Large Phone"
             launcher:minWidthDps="406"
             launcher:minHeightDps="694"
-            launcher:iconImageSize="56"
+            launcher:iconImageSize="60"
             launcher:iconTextSize="12.0"
             launcher:allAppsBorderSpace="16"
             launcher:allAppsCellHeight="104"
@@ -259,7 +259,7 @@
             launcher:name="Large Phone"
             launcher:minWidthDps="406"
             launcher:minHeightDps="694"
-            launcher:iconImageSize="56"
+            launcher:iconImageSize="60"
             launcher:iconTextSize="12.0"
             launcher:allAppsBorderSpace="16"
             launcher:allAppsCellHeight="104"
@@ -333,7 +333,7 @@
             launcher:name="Large Phone"
             launcher:minWidthDps="406"
             launcher:minHeightDps="694"
-            launcher:iconImageSize="48"
+            launcher:iconImageSize="52"
             launcher:iconTextSize="12.0"
             launcher:allAppsBorderSpace="16"
             launcher:allAppsCellHeight="104"
-- 

From 3c508560211f2642c965bb4eb9c9df1a72d56df5 Mon Sep 17 00:00:00 2001
From: Pranav Vashi <neobuddy89@gmail.com>
Date: Sun, 11 Dec 2022 16:46:08 +0530
Subject: [PATCH] Launcher3: Use system collapsing toolbar

Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 Android.bp                                    |  1 +
 res/layout-v31/settings_activity.xml          | 69 -------------------
 res/layout/settings_activity.xml              | 17 ++---
 .../launcher3/settings/SettingsActivity.java  | 12 ++--
 4 files changed, 11 insertions(+), 88 deletions(-)
 delete mode 100644 res/layout-v31/settings_activity.xml

diff --git a/Android.bp b/Android.bp
index 17f8ea93b3..87aa71c1b8 100644
--- a/Android.bp
+++ b/Android.bp
@@ -410,6 +410,7 @@ android_library {
         "jsr330",
         "com_android_systemui_shared_flags_lib",
         "libGoogleFeed",
+        "SettingsLib",
         "org.lineageos.platform",
     ],
     manifest: "AndroidManifest-common.xml",
diff --git a/res/layout-v31/settings_activity.xml b/res/layout-v31/settings_activity.xml
deleted file mode 100644
index 59e14f22dd..0000000000
--- a/res/layout-v31/settings_activity.xml
+++ /dev/null
@@ -1,69 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!--
-  Copyright (C) 2021 The Android Open Source Project
-
-  Licensed under the Apache License, Version 2.0 (the "License");
-  you may not use this file except in compliance with the License.
-  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-  Unless required by applicable law or agreed to in writing, software
-  distributed under the License is distributed on an "AS IS" BASIS,
-  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-  See the License for the specific language governing permissions and
-  limitations under the License.
--->
-<androidx.coordinatorlayout.widget.CoordinatorLayout
-    xmlns:android="http://schemas.android.com/apk/res/android"
-    xmlns:app="http://schemas.android.com/apk/res-auto"
-    android:id="@+id/content_parent"
-    android:layout_width="match_parent"
-    android:layout_height="match_parent"
-    android:fitsSystemWindows="true">
-
-    <com.google.android.material.appbar.AppBarLayout
-        android:id="@+id/app_bar"
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:background="?android:attr/colorPrimary"
-        android:fitsSystemWindows="true"
-        android:outlineAmbientShadowColor="@android:color/transparent"
-        android:outlineSpotShadowColor="@android:color/transparent"
-        android:theme="@style/HomeSettings.CollapsingToolbar">
-
-        <com.google.android.material.appbar.CollapsingToolbarLayout
-            android:id="@+id/collapsing_toolbar"
-            android:layout_width="match_parent"
-            android:layout_height="226dp"
-            android:clipToPadding="false"
-            app:collapsedTitleTextAppearance="@style/HomeSettings.CollapsedToolbarTitle"
-            app:contentScrim="@color/home_settings_header_collapsed"
-            app:expandedTitleMarginEnd="24dp"
-            app:expandedTitleMarginStart="24dp"
-            app:expandedTitleTextAppearance="@style/HomeSettings.ExpandedToolbarTitle"
-            app:layout_scrollFlags="scroll|exitUntilCollapsed|snap"
-            app:maxLines="3"
-            app:scrimAnimationDuration="50"
-            app:scrimVisibleHeightTrigger="174dp"
-            app:statusBarScrim="@null"
-            app:titleCollapseMode="fade"
-            app:toolbarId="@id/action_bar">
-
-            <Toolbar
-                android:id="@+id/action_bar"
-                android:layout_width="match_parent"
-                android:layout_height="?attr/actionBarSize"
-                android:theme="?android:attr/actionBarTheme"
-                android:transitionName="shared_element_view"
-                app:layout_collapseMode="pin" />
-
-        </com.google.android.material.appbar.CollapsingToolbarLayout>
-    </com.google.android.material.appbar.AppBarLayout>
-
-    <FrameLayout
-        android:id="@+id/content_frame"
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        app:layout_behavior="@string/appbar_scrolling_view_behavior" />
-</androidx.coordinatorlayout.widget.CoordinatorLayout>
\ No newline at end of file
diff --git a/res/layout/settings_activity.xml b/res/layout/settings_activity.xml
index 5edd2df3f5..a1ea1478a3 100644
--- a/res/layout/settings_activity.xml
+++ b/res/layout/settings_activity.xml
@@ -14,22 +14,17 @@
   See the License for the specific language governing permissions and
   limitations under the License.
 -->
-<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
+<androidx.coordinatorlayout.widget.CoordinatorLayout
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
     android:id="@+id/content_parent"
     android:layout_width="match_parent"
     android:layout_height="match_parent"
-    android:orientation="vertical"
     android:fitsSystemWindows="true">
 
-    <Toolbar
-        android:id="@+id/action_bar"
-        style="?android:attr/actionBarStyle"
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:theme="?android:attr/actionBarTheme" />
-
     <FrameLayout
         android:id="@+id/content_frame"
         android:layout_width="match_parent"
-        android:layout_height="match_parent" />
-</LinearLayout>
\ No newline at end of file
+        android:layout_height="wrap_content"
+        app:layout_behavior="@string/appbar_scrolling_view_behavior" />
+</androidx.coordinatorlayout.widget.CoordinatorLayout>
diff --git a/src/com/android/launcher3/settings/SettingsActivity.java b/src/com/android/launcher3/settings/SettingsActivity.java
index 43225eaeeb..e7dc7516ba 100644
--- a/src/com/android/launcher3/settings/SettingsActivity.java
+++ b/src/com/android/launcher3/settings/SettingsActivity.java
@@ -41,7 +41,6 @@ import androidx.annotation.VisibleForTesting;
 import androidx.core.view.WindowCompat;
 import androidx.fragment.app.DialogFragment;
 import androidx.fragment.app.Fragment;
-import androidx.fragment.app.FragmentActivity;
 import androidx.fragment.app.FragmentManager;
 import androidx.preference.Preference;
 import androidx.preference.PreferenceFragmentCompat;
@@ -63,10 +62,12 @@ import com.android.launcher3.states.RotationHelper;
 import com.android.launcher3.util.DisplayController;
 import com.android.launcher3.util.SettingsCache;
 
+import com.android.settingslib.collapsingtoolbar.CollapsingToolbarBaseActivity;
+
 /**
  * Settings activity for Launcher. Currently implements the following setting: Allow rotation
  */
-public class SettingsActivity extends FragmentActivity
+public class SettingsActivity extends CollapsingToolbarBaseActivity
         implements OnPreferenceStartFragmentCallback, OnPreferenceStartScreenCallback {
 
     @VisibleForTesting
@@ -98,14 +99,9 @@ public class SettingsActivity extends FragmentActivity
         super.onCreate(savedInstanceState);
         setContentView(R.layout.settings_activity);
 
-        setActionBar(findViewById(R.id.action_bar));
         WindowCompat.setDecorFitsSystemWindows(getWindow(), false);
 
         Intent intent = getIntent();
-        if (intent.hasExtra(EXTRA_FRAGMENT_ROOT_KEY) || intent.hasExtra(EXTRA_FRAGMENT_ARGS)
-                || intent.hasExtra(EXTRA_FRAGMENT_HIGHLIGHT_KEY)) {
-            getActionBar().setDisplayHomeAsUpEnabled(true);
-        }
 
         if (savedInstanceState == null) {
             Bundle args = intent.getBundleExtra(EXTRA_FRAGMENT_ARGS);
@@ -127,7 +123,7 @@ public class SettingsActivity extends FragmentActivity
                     getString(R.string.settings_fragment_name));
             f.setArguments(args);
             // Display the fragment as the main content.
-            fm.beginTransaction().replace(R.id.content_frame, f).commit();
+            fm.beginTransaction().replace(com.android.settingslib.collapsingtoolbar.R.id.content_frame, f).commit();
         }
     }
 
-- 

From 32f0ab81bb9d7c037ce53f7ff84d78c7081938cc Mon Sep 17 00:00:00 2001
From: Pranav Vashi <neobuddy89@gmail.com>
Date: Fri, 14 Mar 2025 11:40:53 +0530
Subject: [PATCH] Launcher3: Bump launcher min sdk version

Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 Android.bp          | 2 +-
 AndroidManifest.xml | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/Android.bp b/Android.bp
index 87aa71c1b8..ffc0aaf6b7 100644
--- a/Android.bp
+++ b/Android.bp
@@ -17,7 +17,7 @@ package {
     default_applicable_licenses: ["Android-Apache-2.0"],
 }
 
-min_launcher3_sdk_version = "31"
+min_launcher3_sdk_version = "36"
 
 // Targets that don't inherit framework aconfig libs (i.e., those that don't set
 // `platform_apis: true`) must manually link them.
diff --git a/AndroidManifest.xml b/AndroidManifest.xml
index 486f99b104..609cdd196d 100644
--- a/AndroidManifest.xml
+++ b/AndroidManifest.xml
@@ -20,7 +20,7 @@
 <manifest
     xmlns:android="http://schemas.android.com/apk/res/android"
     package="com.android.launcher3">
-    <uses-sdk android:targetSdkVersion="33" android:minSdkVersion="30"/>
+    <uses-sdk android:targetSdkVersion="36" android:minSdkVersion="36"/>
     <!--
     Manifest entries specific to Launcher3. This is merged with AndroidManifest-common.xml.
     Refer comments around specific entries on how to extend individual components.
-- 

From a734038aa306dfa57b478cce7da6bd3bf8149348 Mon Sep 17 00:00:00 2001
From: Ali B <abittin@gmail.com>
Date: Sat, 30 Jan 2021 22:36:40 +0300
Subject: [PATCH] Launcher3: Add uninstall button to system shortcuts

[ghostrider-reborn: Adapt to Sv2, 13]

Squashed:

    Author: Adithya R <gh0strider.2k18.reborn@gmail.com>
    Date:   Sun Jun 26 18:44:18 2022 +0530

    Launcher3: SystemShortcut: Avoid NPE due to uninstall button

    Crash log: https://bin.kv2.dev/~62b85c7008bb984d9dc61e94

    Steps to reproduce:
    - Add Now Playing widget to home screen
    - Long press on it
    - Launcher crashes

    Test: manual; no longer crashes
    Change-Id: I6c0f73e38a3695a64d820c40b58f5e87ba7013c5

    From: Pranav Vashi <neobuddy89@gmail.com>
    Date: Thu, 3 Feb 2022 22:14:38 +0530
    Subject: Launcher3: Use standard launcher method for uninstalling

    Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>

    From: Pranav Vashi <neobuddy89@gmail.com>
    Date: Tue, 24 Sep 2024 00:06:28 +0530
    Subject: Launcher3: Update UNINSTALL TaskShortcutFactory for A15

    Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>

neobuddy89: Add back removed method to check system app and adapt.

Change-Id: I005d676d9a98f65296c330e5e13fd0d849df6fe5
Co-authored-by: Adithya R <gh0strider.2k18.reborn@gmail.com>
Co-authored-by: Pranav Vashi <neobuddy89@gmail.com>
Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 .../android/quickstep/TaskOverlayFactory.java |  1 +
 .../quickstep/TaskShortcutFactory.java        | 12 +++++
 src/com/android/launcher3/Launcher.java       |  3 +-
 .../launcher3/popup/SystemShortcut.java       | 29 ++++++++++++
 .../launcher3/util/PackageManagerHelper.java  | 44 +++++++++++++++++++
 5 files changed, 88 insertions(+), 1 deletion(-)

diff --git a/quickstep/src/com/android/quickstep/TaskOverlayFactory.java b/quickstep/src/com/android/quickstep/TaskOverlayFactory.java
index e9038a7892..5691a96cd3 100644
--- a/quickstep/src/com/android/quickstep/TaskOverlayFactory.java
+++ b/quickstep/src/com/android/quickstep/TaskOverlayFactory.java
@@ -113,6 +113,7 @@ public class TaskOverlayFactory implements ResourceBasedOverride {
     private static final TaskShortcutFactory[] MENU_OPTIONS = new TaskShortcutFactory[]{
             TaskShortcutFactory.APP_INFO,
             TaskShortcutFactory.SPLIT_SELECT,
+            TaskShortcutFactory.UNINSTALL,
             TaskShortcutFactory.PIN,
             TaskShortcutFactory.INSTALL,
             TaskShortcutFactory.FREE_FORM,
diff --git a/quickstep/src/com/android/quickstep/TaskShortcutFactory.java b/quickstep/src/com/android/quickstep/TaskShortcutFactory.java
index bc46ace741..cab707350b 100644
--- a/quickstep/src/com/android/quickstep/TaskShortcutFactory.java
+++ b/quickstep/src/com/android/quickstep/TaskShortcutFactory.java
@@ -50,6 +50,7 @@ import com.android.launcher3.model.WellbeingModel;
 import com.android.launcher3.popup.SystemShortcut;
 import com.android.launcher3.popup.SystemShortcut.AppInfo;
 import com.android.launcher3.util.InstantAppResolver;
+import com.android.launcher3.util.PackageManagerHelper;
 import com.android.launcher3.util.SplitConfigurationOptions;
 import com.android.launcher3.util.SplitConfigurationOptions.SplitPositionOption;
 import com.android.launcher3.views.ActivityContext;
@@ -409,6 +410,17 @@ public interface TaskShortcutFactory {
         }
     };
 
+    TaskShortcutFactory UNINSTALL = new TaskShortcutFactory() {
+        @Override
+        public List<SystemShortcut> getShortcuts(RecentsViewContainer container,
+                TaskContainer taskContainer) {
+            return PackageManagerHelper.isSystemApp(container.asContext(),
+                    taskContainer.getTask().getTopComponent().getPackageName()) ? null :
+                    Collections.singletonList(new SystemShortcut.UnInstall(container,
+                            taskContainer.getItemInfo(), taskContainer.getTaskView()));
+        }
+    };
+
     TaskShortcutFactory FREE_FORM = new TaskShortcutFactory() {
         @Override
         public List<SystemShortcut> getShortcuts(RecentsViewContainer container,
diff --git a/src/com/android/launcher3/Launcher.java b/src/com/android/launcher3/Launcher.java
index 3439a43e17..f95a132e0c 100644
--- a/src/com/android/launcher3/Launcher.java
+++ b/src/com/android/launcher3/Launcher.java
@@ -100,6 +100,7 @@ import static com.android.launcher3.model.ItemInstallQueue.FLAG_ACTIVITY_PAUSED;
 import static com.android.launcher3.model.ItemInstallQueue.FLAG_DRAG_AND_DROP;
 import static com.android.launcher3.popup.SystemShortcut.APP_INFO;
 import static com.android.launcher3.popup.SystemShortcut.INSTALL;
+import static com.android.launcher3.popup.SystemShortcut.UNINSTALL;
 import static com.android.launcher3.popup.SystemShortcut.WIDGETS;
 import static com.android.launcher3.states.RotationHelper.REQUEST_LOCK;
 import static com.android.launcher3.states.RotationHelper.REQUEST_NONE;
@@ -3038,7 +3039,7 @@ public class Launcher extends StatefulActivity<LauncherState>
     }
 
     public Stream<SystemShortcut.Factory> getSupportedShortcuts() {
-        return Stream.of(APP_INFO, WIDGETS, INSTALL);
+        return Stream.of(APP_INFO, WIDGETS, INSTALL, UNINSTALL);
     }
 
     /**
diff --git a/src/com/android/launcher3/popup/SystemShortcut.java b/src/com/android/launcher3/popup/SystemShortcut.java
index 25be998ffe..49ac223907 100644
--- a/src/com/android/launcher3/popup/SystemShortcut.java
+++ b/src/com/android/launcher3/popup/SystemShortcut.java
@@ -13,6 +13,7 @@ import android.content.Context;
 import android.content.Intent;
 import android.content.pm.ShortcutInfo;
 import android.graphics.Rect;
+import android.net.Uri;
 import android.os.Process;
 import android.os.UserHandle;
 import android.util.Log;
@@ -46,6 +47,7 @@ import com.android.launcher3.views.Snackbar;
 import com.android.launcher3.widget.WidgetsBottomSheet;
 import com.android.launcher3.widget.picker.model.data.WidgetPickerData;
 
+import java.net.URISyntaxException;
 import java.util.Arrays;
 
 /**
@@ -396,6 +398,33 @@ public abstract class SystemShortcut<T extends ActivityContext> extends ItemInfo
         }
     }
 
+    public static final Factory<ActivityContext> UNINSTALL = (activity, itemInfo, originalView) ->
+            itemInfo.getTargetComponent() == null ||
+                    PackageManagerHelper.isSystemApp((Context) activity,
+                    itemInfo.getTargetComponent().getPackageName())
+                    ? null : new UnInstall(activity, itemInfo, originalView);
+
+    public static class UnInstall<T extends ActivityContext> extends SystemShortcut<T> {
+
+        public UnInstall(T target, ItemInfo itemInfo, View originalView) {
+            super(R.drawable.ic_uninstall_no_shadow, R.string.uninstall_drop_target_label,
+                    target, itemInfo, originalView);
+        }
+
+        @Override
+        public void onClick(View view) {
+            try {
+                Intent intent = Intent.parseUri(view.getContext().getString(R.string.delete_package_intent), 0)
+                    .setData(Uri.fromParts("package", mItemInfo.getTargetComponent().getPackageName(),
+                    mItemInfo.getTargetComponent().getClassName())).putExtra(Intent.EXTRA_USER, mItemInfo.user);
+                mTarget.startActivitySafely(view, intent, mItemInfo);
+                AbstractFloatingView.closeAllOpenViews(mTarget);
+            } catch (URISyntaxException e) {
+                // Do nothing.
+            }
+        }
+    }
+
     protected void dismissTaskMenuView() {
         mAbstractFloatingViewHelper.closeOpenViews(mTarget, true,
                 AbstractFloatingView.TYPE_ALL & ~AbstractFloatingView.TYPE_REBIND_SAFE);
diff --git a/src/com/android/launcher3/util/PackageManagerHelper.java b/src/com/android/launcher3/util/PackageManagerHelper.java
index 3d01f246ec..d17dd8f934 100644
--- a/src/com/android/launcher3/util/PackageManagerHelper.java
+++ b/src/com/android/launcher3/util/PackageManagerHelper.java
@@ -22,10 +22,13 @@ import android.content.ActivityNotFoundException;
 import android.content.ComponentName;
 import android.content.Context;
 import android.content.Intent;
+import android.content.pm.ApplicationInfo;
 import android.content.pm.LauncherActivityInfo;
 import android.content.pm.LauncherApps;
+import android.content.pm.PackageInfo;
 import android.content.pm.PackageManager;
 import android.content.pm.PackageManager.NameNotFoundException;
+import android.content.pm.ResolveInfo;
 import android.graphics.Rect;
 import android.os.Bundle;
 import android.os.Process;
@@ -144,6 +147,47 @@ public class PackageManagerHelper {
         }
     }
 
+    public static boolean isSystemApp(@NonNull final Context context, String pkgName) {
+        return isSystemApp(context, null, pkgName);
+    }
+
+    public static boolean isSystemApp(@NonNull final Context context, Intent intent) {
+        return isSystemApp(context, intent, null);
+    }
+
+    public static boolean isSystemApp(@NonNull final Context context, Intent intent, String pkgName) {
+        PackageManager pm = context.getPackageManager();
+        String packageName = null;
+        // If the intent is not null, let's get the package name from the intent.
+        if (intent != null) {
+            ComponentName cn = intent.getComponent();
+            if (cn == null) {
+                ResolveInfo info = pm.resolveActivity(intent, PackageManager.MATCH_DEFAULT_ONLY);
+                if ((info != null) && (info.activityInfo != null)) {
+                    packageName = info.activityInfo.packageName;
+                }
+            } else {
+                packageName = cn.getPackageName();
+            }
+        }
+        // Otherwise we have the package name passed from the method.
+        else {
+            packageName = pkgName;
+        }
+        // Check if the provided package is a system app.
+        if (packageName != null) {
+            try {
+                PackageInfo info = pm.getPackageInfo(packageName, 0);
+                return (info != null) && (info.applicationInfo != null) &&
+                        ((info.applicationInfo.flags & ApplicationInfo.FLAG_SYSTEM) != 0);
+            } catch (NameNotFoundException e) {
+                return false;
+            }
+        } else {
+            return false;
+        }
+    }
+
     /**
      * Returns true if the intent is a valid launch intent for a launcher activity of an app.
      * This is used to identify shortcuts which are different from the ones exposed by the
-- 

From dedafb3b694d3a4f6f5a3f7b34bd2e9f738dac0f Mon Sep 17 00:00:00 2001
From: Pranav Vashi <neobuddy89@gmail.com>
Date: Sun, 25 Jun 2023 21:35:05 +0530
Subject: [PATCH] Launcher3: Add UNINSTALL shortcut to QuickstepLauncher

Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 .../com/android/launcher3/uioverrides/QuickstepLauncher.java    | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/quickstep/src/com/android/launcher3/uioverrides/QuickstepLauncher.java b/quickstep/src/com/android/launcher3/uioverrides/QuickstepLauncher.java
index 0dc8981d6a..034069b8dc 100644
--- a/quickstep/src/com/android/launcher3/uioverrides/QuickstepLauncher.java
+++ b/quickstep/src/com/android/launcher3/uioverrides/QuickstepLauncher.java
@@ -49,6 +49,7 @@ import static com.android.launcher3.popup.SystemShortcut.BUBBLE_SHORTCUT;
 import static com.android.launcher3.popup.SystemShortcut.DONT_SUGGEST_APP;
 import static com.android.launcher3.popup.SystemShortcut.INSTALL;
 import static com.android.launcher3.popup.SystemShortcut.PRIVATE_PROFILE_INSTALL;
+import static com.android.launcher3.popup.SystemShortcut.UNINSTALL;
 import static com.android.launcher3.popup.SystemShortcut.UNINSTALL_APP;
 import static com.android.launcher3.popup.SystemShortcut.WIDGETS;
 import static com.android.launcher3.taskbar.LauncherTaskbarUIController.ALL_APPS_PAGE_PROGRESS_INDEX;
@@ -484,6 +485,7 @@ public class QuickstepLauncher extends Launcher implements RecentsViewContainer,
                 APP_INFO, WellbeingModel.SHORTCUT_FACTORY, mHotseatPredictionController));
 
         shortcuts.addAll(getSplitShortcuts());
+        shortcuts.add(UNINSTALL);
         shortcuts.add(WIDGETS);
         shortcuts.add(INSTALL);
         if (Flags.enablePrivateSpaceInstallShortcut()) {
-- 

From b9b90c7854eebb1c0f9135d4aad0079bde82b427 Mon Sep 17 00:00:00 2001
From: Erfan Abdi <erfangplus@gmail.com>
Date: Fri, 21 Jul 2023 10:00:47 +0000
Subject: [PATCH] Launcher3: Fix Uninstalling work apps

Change-Id: I99bf35b014eb51199eece9fd3136bcc33ee512fb
Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 .../launcher3/popup/SystemShortcut.java       | 41 +++++++++++++++++--
 1 file changed, 38 insertions(+), 3 deletions(-)

diff --git a/src/com/android/launcher3/popup/SystemShortcut.java b/src/com/android/launcher3/popup/SystemShortcut.java
index 49ac223907..dcbd799b4d 100644
--- a/src/com/android/launcher3/popup/SystemShortcut.java
+++ b/src/com/android/launcher3/popup/SystemShortcut.java
@@ -1,5 +1,6 @@
 package com.android.launcher3.popup;
 
+import static com.android.launcher3.LauncherSettings.Favorites.ITEM_TYPE_APPLICATION;
 import static com.android.launcher3.logging.StatsLogManager.LauncherEvent.LAUNCHER_DISMISS_PREDICTION_UNDO;
 import static com.android.launcher3.logging.StatsLogManager.LauncherEvent.LAUNCHER_PRIVATE_SPACE_INSTALL_SYSTEM_SHORTCUT_TAP;
 import static com.android.launcher3.logging.StatsLogManager.LauncherEvent.LAUNCHER_PRIVATE_SPACE_UNINSTALL_SYSTEM_SHORTCUT_TAP;
@@ -11,6 +12,8 @@ import static com.android.launcher3.widget.picker.model.data.WidgetPickerDataUti
 import android.content.ComponentName;
 import android.content.Context;
 import android.content.Intent;
+import android.content.pm.LauncherActivityInfo;
+import android.content.pm.LauncherApps;
 import android.content.pm.ShortcutInfo;
 import android.graphics.Rect;
 import android.net.Uri;
@@ -21,6 +24,8 @@ import android.view.View;
 import android.view.accessibility.AccessibilityNodeInfo;
 import android.widget.ImageView;
 import android.widget.TextView;
+import android.widget.Toast;
+import android.os.UserHandle;
 
 import androidx.annotation.NonNull;
 import androidx.annotation.Nullable;
@@ -411,13 +416,43 @@ public abstract class SystemShortcut<T extends ActivityContext> extends ItemInfo
                     target, itemInfo, originalView);
         }
 
+        /**
+         * @return the component name that should be uninstalled or null.
+         */
+        private ComponentName getUninstallTarget(ItemInfo item, Context context) {
+            Intent intent = null;
+            UserHandle user = null;
+            if (item != null &&
+                    item.itemType == ITEM_TYPE_APPLICATION) {
+                intent = item.getIntent();
+                user = item.user;
+            }
+            if (intent != null) {
+                LauncherActivityInfo info = context.getSystemService(LauncherApps.class)
+                        .resolveActivity(intent, user);
+                if (info != null
+                        && (info.getApplicationInfo().flags & ApplicationInfo.FLAG_SYSTEM) == 0) {
+                    return info.getComponentName();
+                }
+            }
+            return null;
+        }
+
         @Override
         public void onClick(View view) {
+            ComponentName cn = getUninstallTarget(mItemInfo, view.getContext());
+            if (cn == null) {
+                // System applications cannot be installed. For now, show a toast explaining that.
+                // We may give them the option of disabling apps this way.
+                Toast.makeText(view.getContext(), R.string.uninstall_system_app_text, Toast.LENGTH_SHORT).show();
+                return;
+            }
+
             try {
                 Intent intent = Intent.parseUri(view.getContext().getString(R.string.delete_package_intent), 0)
-                    .setData(Uri.fromParts("package", mItemInfo.getTargetComponent().getPackageName(),
-                    mItemInfo.getTargetComponent().getClassName())).putExtra(Intent.EXTRA_USER, mItemInfo.user);
-                mTarget.startActivitySafely(view, intent, mItemInfo);
+                    .setData(Uri.fromParts("package", cn.getPackageName(), cn.getClassName()))
+                    .putExtra(Intent.EXTRA_USER, mItemInfo.user);
+                ((Context) mTarget).startActivity(intent);
                 AbstractFloatingView.closeAllOpenViews(mTarget);
             } catch (URISyntaxException e) {
                 // Do nothing.
-- 

From dde2ef75ee79c5f98e3747e470d83760010b753c Mon Sep 17 00:00:00 2001
From: nift4 <nift4@protonmail.com>
Date: Thu, 4 Apr 2024 06:37:01 +0530
Subject: [PATCH] Launcher3: Fix uninstalling apps from recents

neobuddy89: Updated for A15 QPR2

Change-Id: Icc1543ba4352991393c4b5efd37f3ab9dd3970ed
Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 src/com/android/launcher3/SecondaryDropTarget.java  | 3 ++-
 src/com/android/launcher3/popup/SystemShortcut.java | 3 ++-
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/src/com/android/launcher3/SecondaryDropTarget.java b/src/com/android/launcher3/SecondaryDropTarget.java
index f4d3146ed5..19dae04e5a 100644
--- a/src/com/android/launcher3/SecondaryDropTarget.java
+++ b/src/com/android/launcher3/SecondaryDropTarget.java
@@ -201,7 +201,8 @@ public class SecondaryDropTarget extends ButtonDropTarget implements OnAlarmList
         Intent intent = null;
         UserHandle user = null;
         if (item != null &&
-                item.itemType == LauncherSettings.Favorites.ITEM_TYPE_APPLICATION) {
+                (item.itemType == LauncherSettings.Favorites.ITEM_TYPE_APPLICATION ||
+                item.itemType == LauncherSettings.Favorites.ITEM_TYPE_TASK)) {
             intent = item.getIntent();
             user = item.user;
         }
diff --git a/src/com/android/launcher3/popup/SystemShortcut.java b/src/com/android/launcher3/popup/SystemShortcut.java
index dcbd799b4d..9894dec4c3 100644
--- a/src/com/android/launcher3/popup/SystemShortcut.java
+++ b/src/com/android/launcher3/popup/SystemShortcut.java
@@ -1,6 +1,7 @@
 package com.android.launcher3.popup;
 
 import static com.android.launcher3.LauncherSettings.Favorites.ITEM_TYPE_APPLICATION;
+import static com.android.launcher3.LauncherSettings.Favorites.ITEM_TYPE_TASK;
 import static com.android.launcher3.logging.StatsLogManager.LauncherEvent.LAUNCHER_DISMISS_PREDICTION_UNDO;
 import static com.android.launcher3.logging.StatsLogManager.LauncherEvent.LAUNCHER_PRIVATE_SPACE_INSTALL_SYSTEM_SHORTCUT_TAP;
 import static com.android.launcher3.logging.StatsLogManager.LauncherEvent.LAUNCHER_PRIVATE_SPACE_UNINSTALL_SYSTEM_SHORTCUT_TAP;
@@ -423,7 +424,7 @@ public abstract class SystemShortcut<T extends ActivityContext> extends ItemInfo
             Intent intent = null;
             UserHandle user = null;
             if (item != null &&
-                    item.itemType == ITEM_TYPE_APPLICATION) {
+                    (item.itemType == ITEM_TYPE_APPLICATION || item.itemType == ITEM_TYPE_TASK)) {
                 intent = item.getIntent();
                 user = item.user;
             }
-- 

From af434617eb420571daa297bd935f8e7b3ffb408d Mon Sep 17 00:00:00 2001
From: ygorigor <sorocean.igor@gmail.com>
Date: Tue, 2 Sep 2025 11:50:51 +0300
Subject: [PATCH] Launcher3: add missing import
 android.content.pm.ApplicationInfo

---
 src/com/android/launcher3/popup/SystemShortcut.java | 1 +
 1 file changed, 1 insertion(+)

diff --git a/src/com/android/launcher3/popup/SystemShortcut.java b/src/com/android/launcher3/popup/SystemShortcut.java
index 9894dec4c3..b794844a0c 100644
--- a/src/com/android/launcher3/popup/SystemShortcut.java
+++ b/src/com/android/launcher3/popup/SystemShortcut.java
@@ -13,6 +13,7 @@ import static com.android.launcher3.widget.picker.model.data.WidgetPickerDataUti
 import android.content.ComponentName;
 import android.content.Context;
 import android.content.Intent;
+import android.content.pm.ApplicationInfo;
 import android.content.pm.LauncherActivityInfo;
 import android.content.pm.LauncherApps;
 import android.content.pm.ShortcutInfo;
-- 

From fc58fa292720d2ac21afaba918ea43c1dae2908b Mon Sep 17 00:00:00 2001
From: rmp22 <195054967+rmp22@users.noreply.github.com>
Date: Wed, 25 Jun 2025 16:05:47 +0800
Subject: [PATCH] RecentsDismissUtils: fix expressive dismiss animation not
 fully dismissed

Change-Id: I0c1defa87b43bf8595144a43e64fa445d014d774
---
 .../src/com/android/quickstep/views/RecentsDismissUtils.kt     | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/quickstep/src/com/android/quickstep/views/RecentsDismissUtils.kt b/quickstep/src/com/android/quickstep/views/RecentsDismissUtils.kt
index 6acaeae8db..6153f09c37 100644
--- a/quickstep/src/com/android/quickstep/views/RecentsDismissUtils.kt
+++ b/quickstep/src/com/android/quickstep/views/RecentsDismissUtils.kt
@@ -59,6 +59,7 @@ class RecentsDismissUtils(private val recentsView: RecentsView<*, *>) {
             FloatPropertyCompat.createFloatPropertyCompat(
                 draggedTaskView.secondaryDismissTranslationProperty
             )
+        val overshootLength = 100f
         val minVelocity =
             recentsView.pagedOrientationHandler.getSecondaryDimension(draggedTaskView).toFloat()
         val startVelocity = abs(velocity).coerceAtLeast(minVelocity) * velocity.sign
@@ -68,7 +69,7 @@ class RecentsDismissUtils(private val recentsView: RecentsView<*, *>) {
                 .setSpring(createExpressiveDismissSpringForce())
                 .setStartVelocity(startVelocity)
                 .addUpdateListener { animation, value, _ ->
-                    if (isDismissing && abs(value) >= abs(dismissLength)) {
+                    if (isDismissing && abs(value) >= abs(dismissLength + overshootLength)) {
                         animation.cancel()
                     } else if (draggedTaskView.isRunningTask && recentsView.enableDrawingLiveTile) {
                         recentsView.runActionOnRemoteHandles { remoteTargetHandle ->
-- 

From 5c793dabcc3d6548ce550279eb7e29989fb20f08 Mon Sep 17 00:00:00 2001
From: rmp22 <195054967+rmp22@users.noreply.github.com>
Date: Thu, 15 May 2025 09:45:40 +0800
Subject: [PATCH] Launcher3: Fix cloned apps not appearing in app drawer

Change-Id: I21e54ed73dc2ce35131af64fbc039b0a0da22bd0
Signed-off-by: rmp22 <195054967+rmp22@users.noreply.github.com>
Signed-off-by: Pranav Vashi <neobuddy89@gmail.com>
---
 AndroidManifest-common.xml                    |  1 +
 com.android.launcher3-extra.xml               |  1 +
 .../allapps/ActivityAllAppsContainerView.java |  9 +++++----
 .../launcher3/util/ItemInfoMatcher.java       | 20 +++++++++++++++++++
 4 files changed, 27 insertions(+), 4 deletions(-)

diff --git a/AndroidManifest-common.xml b/AndroidManifest-common.xml
index 76ab7cef84..56c72b7abf 100644
--- a/AndroidManifest-common.xml
+++ b/AndroidManifest-common.xml
@@ -50,6 +50,7 @@
     <uses-permission android:name="android.permission.USE_BIOMETRIC" />
     <uses-permission android:name="android.permission.ACCESS_CONTEXTUAL_SEARCH" />
     <uses-permission android:name="android.permission.DEVICE_POWER" />
+    <uses-permission android:name="android.permission.QUERY_USERS" />
 
     <!--
     Permissions required for read/write access to the workspace data. These permission name
diff --git a/com.android.launcher3-extra.xml b/com.android.launcher3-extra.xml
index 55468deb3b..558dda1217 100644
--- a/com.android.launcher3-extra.xml
+++ b/com.android.launcher3-extra.xml
@@ -17,5 +17,6 @@
 <permissions>
     <privapp-permissions package="com.android.launcher3">
         <permission name="android.permission.ACCESS_CONTEXTUAL_SEARCH" />
+        <permission name="android.permission.QUERY_USERS"/>
     </privapp-permissions>
 </permissions>
diff --git a/src/com/android/launcher3/allapps/ActivityAllAppsContainerView.java b/src/com/android/launcher3/allapps/ActivityAllAppsContainerView.java
index 58e3af424a..9e27075971 100644
--- a/src/com/android/launcher3/allapps/ActivityAllAppsContainerView.java
+++ b/src/com/android/launcher3/allapps/ActivityAllAppsContainerView.java
@@ -128,8 +128,7 @@ public class ActivityAllAppsContainerView<T extends Context & ActivityContext>
 
     protected final T mActivityContext;
     protected final List<AdapterHolder> mAH;
-    protected final Predicate<ItemInfo> mPersonalMatcher = ItemInfoMatcher.ofUser(
-            Process.myUserHandle());
+    protected final Predicate<ItemInfo> mPersonalMatcher;
     protected WorkProfileManager mWorkManager;
     protected final PrivateProfileManager mPrivateProfileManager;
     protected final Point mFastScrollerOffset = new Point();
@@ -197,6 +196,8 @@ public class ActivityAllAppsContainerView<T extends Context & ActivityContext>
     public ActivityAllAppsContainerView(Context context, AttributeSet attrs, int defStyleAttr) {
         super(context, attrs, defStyleAttr);
         mActivityContext = ActivityContext.lookupContext(context);
+        UserManager userManager = mActivityContext.getSystemService(UserManager.class);
+        mPersonalMatcher = ItemInfoMatcher.ofCurrentOrDualUser(userManager, Process.myUserHandle());
         mAllAppsStore = new AllAppsStore<>(mActivityContext);
 
         mScrimColor = Themes.getAttrColor(context, R.attr.allAppsScrimColor);
@@ -205,12 +206,12 @@ public class ActivityAllAppsContainerView<T extends Context & ActivityContext>
         mHeaderProtectionColor = Themes.getAttrColor(context, R.attr.allappsHeaderProtectionColor);
 
         mWorkManager = new WorkProfileManager(
-                mActivityContext.getSystemService(UserManager.class),
+                userManager,
                 this,
                 mActivityContext.getStatsLogManager(),
                 UserCache.INSTANCE.get(mActivityContext));
         mPrivateProfileManager = new PrivateProfileManager(
-                mActivityContext.getSystemService(UserManager.class),
+                userManager,
                 this,
                 mActivityContext.getStatsLogManager(),
                 UserCache.INSTANCE.get(mActivityContext));
diff --git a/src/com/android/launcher3/util/ItemInfoMatcher.java b/src/com/android/launcher3/util/ItemInfoMatcher.java
index 063313a8c6..3ecc4d79ba 100644
--- a/src/com/android/launcher3/util/ItemInfoMatcher.java
+++ b/src/com/android/launcher3/util/ItemInfoMatcher.java
@@ -18,6 +18,7 @@ package com.android.launcher3.util;
 
 import android.content.ComponentName;
 import android.os.UserHandle;
+import android.os.UserManager;
 
 import androidx.annotation.NonNull;
 
@@ -45,6 +46,25 @@ public abstract class ItemInfoMatcher {
         return info -> info != null && info.user.equals(user);
     }
 
+    public static Predicate<ItemInfo> ofCurrentOrDualUser(UserManager userManager, UserHandle user) {
+        return itemInfo -> itemInfo != null && (
+                isDualAppUser(userManager, itemInfo.user) || itemInfo.user.equals(user)
+        );
+    }
+
+    private static boolean isDualAppUser(UserManager userManager, UserHandle user) {
+        return user.getIdentifier() == getCloneUserId(userManager);
+    }
+
+    public static int getCloneUserId(UserManager userManager) {
+        for (UserHandle userHandle : userManager.getUserProfiles()) {
+            if (userManager.getUserInfo(userHandle.getIdentifier()).isCloneProfile()) {
+                return userHandle.getIdentifier();
+            }
+        }
+        return -1;
+    }
+
     public static Predicate<ItemInfo> ofComponents(
             HashSet<ComponentName> components, UserHandle user) {
         return info -> info != null && info.user.equals(user)
-- 

From f2c56053b63de84e9aa913ea18a02e5f753f49ce Mon Sep 17 00:00:00 2001
From: zaixiang xu <zaixiang.xu@transsion.com>
Date: Tue, 26 Aug 2025 08:44:42 -0700
Subject: [PATCH] Optimize the display speed of desktop icons when switching
 icon styles

Change the icon from single-threaded serial loading to multi-threaded loading (put into task queue)

Bug: 442273512
Test: Test icon loading speed
Change-Id: Ief1bba5394a6cd453ef7543cd5ee99f7265087af
---
 .../android/launcher3/icons/IconCache.java    |  53 +++++---
 .../android/launcher3/util/TaskSchedule.java  | 128 ++++++++++++++++++
 2 files changed, 159 insertions(+), 22 deletions(-)
 create mode 100644 src/com/android/launcher3/util/TaskSchedule.java

diff --git a/src/com/android/launcher3/icons/IconCache.java b/src/com/android/launcher3/icons/IconCache.java
index 1e80d03727..076e2306fe 100644
--- a/src/com/android/launcher3/icons/IconCache.java
+++ b/src/com/android/launcher3/icons/IconCache.java
@@ -73,7 +73,10 @@ import com.android.launcher3.util.InstantAppResolver;
 import com.android.launcher3.util.PackageUserKey;
 import com.android.launcher3.widget.WidgetSections;
 import com.android.launcher3.widget.WidgetSections.WidgetSection;
+import com.android.launcher3.util.Executors;
+import com.android.launcher3.util.TaskSchedule;
 
+import java.util.ArrayList;
 import java.util.Collections;
 import java.util.List;
 import java.util.Map;
@@ -489,6 +492,7 @@ public class IconCache extends BaseIconCache {
         }
 
         Trace.beginSection("loadIconSubsectionWithFallback");
+        ArrayList<TaskSchedule.SafelyRunnable> tasksList = new ArrayList<>();
         // Fallback title and icon loading
         for (ComponentName cn : duplicateIconRequestsMap.keySet()) {
             IconRequestInfo<T> iconRequestInfo = duplicateIconRequestsMap.get(cn).get(0);
@@ -513,30 +517,35 @@ public class IconCache extends BaseIconCache {
                     entry.bitmap = icon;
                 }
                 entry.contentDescription = itemInfo.contentDescription;
-
-                if (loadFallbackIcon) {
-                    loadFallbackIcon(
-                            lai,
-                            entry,
-                            LauncherActivityCachingLogic.INSTANCE,
-                            /* usePackageIcon= */ false,
-                            /* usePackageTitle= */ loadFallbackTitle,
-                            cn,
-                            sectionKey.first);
-                }
-                if (loadFallbackTitle && TextUtils.isEmpty(entry.title) && lai != null) {
-                    loadFallbackTitle(
-                            lai,
-                            entry,
-                            LauncherActivityCachingLogic.INSTANCE,
-                            sectionKey.first);
-                }
-
-                for (IconRequestInfo<T> iconRequest : duplicateIconRequestsMap.get(cn)) {
-                    applyCacheEntry(entry, iconRequest.itemInfo);
-                }
+                TaskSchedule.SafelyRunnable runnable = new TaskSchedule.SafelyRunnable() {
+                    @Override
+                    public void onTaskRun() {
+                        if(loadFallbackIcon){
+                            loadFallbackIcon(
+                                    lai,
+                                    entry,
+                                    LauncherActivityCachingLogic.INSTANCE,
+                                    /* usePackageIcon= */ false,
+                                    /* usePackageTitle= */ loadFallbackTitle,
+                                    cn,
+                                    sectionKey.first);
+                        }
+                        if(loadFallbackTitle &&TextUtils.isEmpty(entry.title)&&lai !=null){
+                            loadFallbackTitle(
+                                    lai,
+                                    entry,
+                                    LauncherActivityCachingLogic.INSTANCE,
+                                    sectionKey.first);
+                        }
+                        for(IconRequestInfo<T> iconRequest :duplicateIconRequestsMap.get(cn)){
+                            applyCacheEntry(entry, iconRequest.itemInfo);
+                        }
+                    }
+                };
+                tasksList.add(runnable);
             }
         }
+        TaskSchedule.runTasks(tasksList, Executors.THREAD_POOL_EXECUTOR, Math.max(Runtime.getRuntime().availableProcessors() / 2, 2), 2000);
         Trace.endSection();
     }
 
diff --git a/src/com/android/launcher3/util/TaskSchedule.java b/src/com/android/launcher3/util/TaskSchedule.java
new file mode 100644
index 0000000000..b0b6eb77a3
--- /dev/null
+++ b/src/com/android/launcher3/util/TaskSchedule.java
@@ -0,0 +1,128 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.launcher3.util;
+
+import android.os.SystemClock;
+import android.util.Log;
+
+import java.util.ArrayList;
+import java.util.concurrent.Executor;
+
+public class TaskSchedule {
+
+    static final String TAG = "TaskSchedule";
+    public static void runAllTasksInExecutor(ArrayList<SafelyRunnable> runnableList, Executor executor, int parallelTasks) {
+        int taskSize = runnableList.size();
+        parallelTasks = Math.min(taskSize, parallelTasks);
+        Object LOCK = new Object();
+        for (int i = 0; i < parallelTasks; ++i) {
+            executor.execute(() -> {
+                while (true) {
+                    SafelyRunnable runnable = getTask(runnableList, LOCK);
+                    if (runnable == null) {
+                        break;
+                    }
+                    runnable.run();
+                }
+            });
+        }
+    }
+
+    public static void runTasks(ArrayList<SafelyRunnable> runnableList, Executor executor, int parallelTasks, long timeOut) {
+        int taskSize = runnableList.size();
+        parallelTasks = Math.min(taskSize - 1, parallelTasks);
+        Object LOCK = new Object();
+        final IntCounter intCounter = new IntCounter();
+        for (int i = 0; i < parallelTasks; ++i) {
+            executor.execute(() -> {
+                while (true) {
+                    SafelyRunnable runnable = getTask(runnableList, LOCK);
+                    if (runnable == null) {
+                        break;
+                    }
+                    runnable.run();
+                    synchronized (LOCK) {
+                        intCounter.add();
+                    }
+                }
+            });
+        }
+        long taskDoneTime = -1;
+        while (true) {
+            SafelyRunnable runnable = getTask(runnableList, LOCK);
+            if (runnable == null) {
+                if (intCounter.isEqual(taskSize)) {
+                    break;
+                }
+                if (taskDoneTime == -1) {
+                    taskDoneTime = SystemClock.uptimeMillis();
+                }
+                try {
+                    Thread.sleep(10);
+                } catch (InterruptedException e) {
+                    Log.e(TAG, "InterruptedException-e:" + e.getMessage());
+                }
+                long now = SystemClock.uptimeMillis();
+                if (now - taskDoneTime > timeOut) {
+                    Log.e(TAG, "runTasks>>>>>>>>>>>>>>>>>>>>>>>time out");
+                    break;
+                }
+                continue;
+            }
+            runnable.run();
+            synchronized (LOCK) {
+                intCounter.add();
+            }
+        }
+    }
+
+    static SafelyRunnable getTask(ArrayList<SafelyRunnable> runnableList, final Object LOCK) {
+        synchronized (LOCK) {
+            if (runnableList.isEmpty()) {
+                return null;
+            }
+            int size = runnableList.size();
+            return runnableList.remove(size - 1);
+        }
+    }
+
+    public static abstract class SafelyRunnable implements Runnable {
+
+        @Override
+        public final void run() {
+            try {
+                onTaskRun();
+            } catch (Throwable e) {
+                Log.e(TAG,"SafelyRunnable-Throwable:" + e.getMessage());
+            }
+        }
+
+        public abstract void onTaskRun();
+    }
+
+    public static class IntCounter {
+        public int mCounter = 0;
+
+        public void add() {
+            this.mCounter += 1;
+        }
+
+        public boolean isEqual(int value) {
+            return this.mCounter == value;
+        }
+    }
+}
\ No newline at end of file
-- 

